head	1.34;
access;
symbols
	pre_getangas:1.31
	GPL2010:1.31
	pre_GPL2010:1.30
	pre_var_equation:1.30
	pre_fftwrings:1.30
	pre_opfiles:1.30
	src:1.30
	best-code:1.30
	x-named-regs:1.30
	x:1.30
	v13-00:1.30
	pre_GPL:1.26
	prec_CA:1.25
	noindx:1.25
	Bproc:1.25
	oct21:1.22
	last77:1.18;
locks; strict;
comment	@c @;


1.34
date	2012.02.22.15.41.03;	author leith;	state Exp;
branches;
next	1.33;

1.33
date	2011.02.18.16.13.14;	author leith;	state Exp;
branches;
next	1.32;

1.32
date	2011.02.18.16.02.11;	author leith;	state Exp;
branches;
next	1.31;

1.31
date	2010.06.24.13.26.31;	author leith;	state Exp;
branches;
next	1.30;

1.30
date	2005.10.19.17.24.55;	author leith;	state Exp;
branches;
next	1.29;

1.29
date	2005.10.17.20.17.41;	author leith;	state Exp;
branches;
next	1.28;

1.28
date	2005.10.17.18.10.49;	author leith;	state Exp;
branches;
next	1.27;

1.27
date	2005.10.17.13.30.06;	author leith;	state Exp;
branches;
next	1.26;

1.26
date	2005.08.17.13.58.45;	author leith;	state Exp;
branches;
next	1.25;

1.25
date	2000.07.07.20.43.34;	author pawel;	state Exp;
branches;
next	1.24;

1.24
date	2000.07.07.20.16.00;	author pawel;	state Exp;
branches;
next	1.23;

1.23
date	2000.02.03.15.31.51;	author bimal;	state Exp;
branches;
next	1.22;

1.22
date	99.05.26.13.40.16;	author pawel;	state Exp;
branches;
next	1.21;

1.21
date	99.05.26.13.37.18;	author pawel;	state Exp;
branches;
next	1.20;

1.20
date	99.04.12.18.35.27;	author pawel;	state Exp;
branches;
next	1.19;

1.19
date	99.04.09.21.33.40;	author pawel;	state Exp;
branches;
next	1.18;

1.18
date	98.10.26.20.33.31;	author pawel;	state Exp;
branches;
next	1.17;

1.17
date	98.02.12.16.28.24;	author pawel;	state Exp;
branches;
next	1.16;

1.16
date	97.10.24.21.33.25;	author hedget;	state Exp;
branches;
next	1.15;

1.15
date	97.10.10.18.59.02;	author pawel;	state Exp;
branches;
next	1.14;

1.14
date	97.08.07.15.37.20;	author pawel;	state Exp;
branches;
next	1.13;

1.13
date	96.01.23.19.15.14;	author ramani;	state Exp;
branches;
next	1.12;

1.12
date	96.01.04.22.01.45;	author ramani;	state Exp;
branches;
next	1.11;

1.11
date	95.12.21.18.11.19;	author ramani;	state Exp;
branches;
next	1.10;

1.10
date	95.07.27.17.50.06;	author pawel;	state Exp;
branches;
next	1.9;

1.9
date	95.07.13.19.23.12;	author ramani;	state Exp;
branches;
next	1.8;

1.8
date	95.03.17.15.28.02;	author ramani;	state Exp;
branches;
next	1.7;

1.7
date	94.12.21.14.19.53;	author ramani;	state Exp;
branches;
next	1.6;

1.6
date	94.12.20.16.18.34;	author ramani;	state Exp;
branches;
next	1.5;

1.5
date	94.12.06.20.52.24;	author ramani;	state Exp;
branches;
next	1.4;

1.4
date	94.12.06.20.09.55;	author ramani;	state Exp;
branches;
next	1.3;

1.3
date	94.11.28.10.55.55;	author ramani;	state Exp;
branches;
next	1.2;

1.2
date	94.11.28.09.44.04;	author ramani;	state Exp;
branches;
next	1.1;

1.1
date	94.05.13.12.51.26;	author leith;	state Exp;
branches;
next	;


desc
@copied from USER2:[PSIDER.CMSREF] on 11 May 1994
@


1.34
log
@cycle, cosmetic
@
text
@C++*********************************************************************
C
C PR3DB.F              COSMETIC                  FEB 2011 ARDEAN LEITH  
C                      CYCLE                     FEB 2012 ARDEAN LEITH
C **********************************************************************
C=*                                                                    *
C=* This file is part of:   SPIDER - Modular Image Processing System.  *
C=* SPIDER System Authors:  Joachim Frank & ArDean Leith               *
C=* Copyright 1985-2012  Health Research Inc.,                         *
C=* Riverview Center, 150 Broadway, Suite 560, Menands, NY 12204.      *
C=* Email: spider@@wadsworth.org                                        *
C=*                                                                    *
C=* SPIDER is free software; you can redistribute it and/or            *
C=* modify it under the terms of the GNU General Public License as     *
C=* published by the Free Software Foundation; either version 2 of the *
C=* License, or (at your option) any later version.                    *
C=*                                                                    *
C=* SPIDER is distributed in the hope that it will be useful,          *
C=* but WITHOUT ANY WARRANTY; without even the implied warranty of     *
C=* merchantability or fitness for a particular purpose.  See the GNU  *
C=* General Public License for more details.                           *
C=* You should have received a copy of the GNU General Public License  *
C=* along with this program. If not, see <http://www.gnu.org/licenses> *
C=*                                                                    *
C **********************************************************************
C 
C PURPOSE: CALCULATE THE 3-D PHASE RESIDUE OUTSIDE MISSING CONE, 
C          PR OF FOURIER RINGS(RADIUS, DIRECTION RELATIVE TO Z) AND 
C          OF FOURIER SHELLS(RADIUS) IS CALCULATED. 
C
C23456789012345678901234567890123456789012345678901234567890123456789012
C--*********************************************************************

        SUBROUTINE PR3DB(A,B,PR,AMP,CSUM1,LR,CSUM,CSUM2,
     &     AVSUM,LSD,NX,NY,NZ,DSCALE,NSCALE,SCALE1,SSANG,
     &     INC,Y1,WI,SER)

        REAL            :: A(LSD,NY,NZ), B(LSD,NY,NZ)
        REAL            :: PR(NSCALE,INC), AMP(NSCALE,INC)
        REAL            :: AVSUM(NSCALE,INC)
        REAL            :: CSUM1(INC),CSUM2(INC)
        INTEGER         :: LR(INC)
        REAL            :: CSUM(INC)
        CHARACTER*1     :: SER

        REAL, PARAMETER :: QUADPI     = 3.1415926535897932384626
        REAL, PARAMETER :: RAD_TO_DGR = (180.0/QUADPI)
        REAL, PARAMETER :: DGR_TO_RAD = (QUADPI/180)

        ZANG = (90.0 - SSANG) * DGR_TO_RAD
        ND2  = NX / 2
        NR2  = NY / 2

C       FOR 2D CASE SET NS2 TO ONE
        NS2 = MAX(1,NZ/2)

        DO  L=1,INC
           LR(L)    = 0
           CSUM(L)  = 0.0
           CSUM1(L) = 0.0
           CSUM2(L) = 0.0

           DO  NSC=1,NSCALE
              PR(NSC,L)    = 0.0
              AVSUM(NSC,L) = 0.0
              AMP(NSC,L)   = 0.0
           ENDDO
        ENDDO

        DO K=1,NZ
           IIK = (K - 1)
           IF (IIK > NS2)  IIK = IIK-NZ
           PK = (FLOAT(IIK) / FLOAT(NS2))**2

           DO J=1,NY
              IIJ = (J-1)
              IF (IIJ > NR2)  IIJ = IIJ - NY
              PJ = (FLOAT(IIJ)/FLOAT(NR2))**2

              DO I=1,LSD,2
                III=(I-1)/2

C               SKIP HERMITIAN RELATED VALUES
                IF (III > 0 .OR. (IIK >= 0 .AND. 
     &             (IIJ >=0 .OR. IIK.NE.0))) THEN

                PII = (FLOAT(III) / FLOAT(ND2))**2
                R   = SQRT(PII+PJ+PK) * 0.5

		IF (R  >  0.0)  THEN
                   R1 = SQRT(PII+PK)*0.5          ! r1=(x^2+z^2)^0.5
                   !if(r1 > 0.05) cycle

                   IF (SER == 'C')  THEN
                      IF (ACOS(AMIN1(1.0,SQRT(PK)/R)) < ZANG) CYCLE

                   ELSEIF (SER == 'W')  THEN
                      IF (R1 == 0.0)  THEN
                         FI = ACOS(1.0)
                      ELSE
                         FI = ACOS(AMIN1(1.0,SQRT(PK)/R1))
                      ENDIF
                      IF (FI  <  ZANG) CYCLE
                   ENDIF

                   L = NINT(R*2*(INC-1) )+ 1
                   IF (L  >  INC) CYCLE

                   LR(L) = LR(L) + 2
                   IF (A(I,J,K) .NE. 0.0)THEN
                      PHA = ATAN2(A(I+1,J,K),A(I,J,K)) * RAD_TO_DGR
                   ELSE
                      PHA = 0
                   ENDIF 

                   IF (B(I,J,K) .NE. 0.0)THEN
                      PHB = ATAN2(B(I+1,J,K),B(I,J,K)) * RAD_TO_DGR
                   ELSE
                      PHB = 0.0
                   ENDIF 

                   DPH = PHA - PHB
                   IF (DPH  >  180.0)  DPH = 360.0-DPH
                   IF (DPH  <  -180.0) DPH = 360.0+DPH

                   QA = SQRT(A(I,J,K)**2 + A(I+1,J,K)**2)
                   QB = SQRT(B(I,J,K)**2 + B(I+1,J,K)**2)

                   CSUM(L)=
     &                CSUM(L)+A(I,J,K)*B(I,J,K)+A(I+1,J,K)*B(I+1,J,K)

                   CSUM1(L) = CSUM1(L) + QA * QA
                   CSUM2(L) = CSUM2(L) + QB * QB

C                  SCALES
                   DPH = DPH * DPH

                   DO NSC=1,NSCALE
                      SCALE        = SCALE1 + (NSC-1) * DSCALE
                      QBS          = QB * SCALE
                      AVSUM(NSC,L) = AVSUM(NSC,L) + ABS(QA - QBS)
                      PR(NSC,L)    = PR(NSC,L)  + ((QA+QBS)/2.) * DPH
                      AMP(NSC,L)   = AMP(NSC,L) + ((QA+QBS)/2.)
                   ENDDO
		ENDIF
                ENDIF

             ENDDO
          ENDDO
        ENDDO

        END
@


1.33
log
@*** empty log message ***
@
text
@d1 1
a1 3
C++************************************************************************
C
C PR3DB.F              COSMETIC                  FEB 2011 ARDEAN LEITH *
d3 2
d9 1
a9 1
C=* Copyright 1985-2011  Health Research Inc.,                         *
d35 1
a35 1
     &     AVSUM,LSD,NSAM,NROW,NSLICE,DSCALE,NSCALE,SCALE1,SSANG,
d38 11
a48 9
        DIMENSION   :: A(LSD,NROW,NSLICE),B(LSD,NROW,NSLICE)
        DIMENSION   :: PR(NSCALE,INC),AMP(NSCALE,INC),AVSUM(NSCALE,INC)
        DIMENSION   :: CSUM1(INC),CSUM2(INC),LR(INC)
        DIMENSION   :: CSUM(INC)
        CHARACTER*1 :: SER

        REAL, PARAMETER   :: QUADPI = 3.1415926535897932384626
        REAL, PARAMETER   :: RAD_TO_DGR = (180.0/QUADPI)
        REAL, PARAMETER   :: DGR_TO_RAD = (QUADPI/180)
d51 2
a52 2
        ND2  = NSAM / 2
        NR2  = NROW / 2
d55 1
a55 1
        NS2 = MAX(1,NSLICE/2)
d70 1
a70 1
        DO K=1,NSLICE
d72 1
a72 1
           IF (IIK .GT. NS2)  IIK = IIK-NSLICE
d75 1
a75 1
           DO J=1,NROW
d77 1
a77 1
              IF (IIJ .GT. NR2)  IIJ = IIJ - NROW
d84 2
a85 2
                IF (III.GT.0 .OR.(IIK.GE.0 .AND. 
     &             (IIJ.GE.0 .OR. IIK.NE.0))) THEN
d90 1
a90 1
		IF (R .GT. 0.0)  THEN
d92 1
a92 1
                   !if(r1.gt.0.05) goto 3
d94 2
a95 2
                   IF (SER .EQ. 'C')  THEN
                      IF (ACOS(AMIN1(1.0,SQRT(PK)/R)).LT.ZANG) GO TO 3
d97 2
a98 2
                   ELSEIF (SER .EQ. 'W')  THEN
                      IF (R1 .EQ. 0.0)  THEN
d103 1
a103 1
                      IF (FI .LT. ZANG) GO TO 3
d107 1
a107 1
                   IF (L .GT. INC) GO TO 3
d123 2
a124 2
                   IF (DPH .GT. 180.0)  DPH = 360.0-DPH
                   IF (DPH .LT. -180.0) DPH = 360.0+DPH
a147 1
3            CONTINUE
@


1.32
log
@cosmetic
@
text
@d44 3
a46 3
        PARAMETER   :: QUADPI = 3.1415926535897932384626
        PARAMETER   :: RAD_TO_DGR = (180.0/QUADPI)
        PARAMETER   :: DGR_TO_RAD = (QUADPI/180)
@


1.31
log
@GPL_2010
@
text
@d3 1
a3 1
C PR3DB.F
d9 1
a9 1
C=* Copyright 1985-2010  Health Research Inc.,                         *
d38 13
a50 13
        DIMENSION A(LSD,NROW,NSLICE),B(LSD,NROW,NSLICE)
        DIMENSION PR(NSCALE,INC),AMP(NSCALE,INC),AVSUM(NSCALE,INC)
        DIMENSION CSUM1(INC),CSUM2(INC),LR(INC)
        DIMENSION CSUM(INC)
        CHARACTER*1 SER

        PARAMETER (QUADPI = 3.141592653589793238462643383279502884197)
        PARAMETER (RAD_TO_DGR = (180.0/QUADPI))
        PARAMETER (DGR_TO_RAD = (QUADPI/180))

        ZANG=(90.0-SSANG)*DGR_TO_RAD
        ND2=NSAM/2
        NR2=NROW/2
d52 2
a53 2
C       for 2D case set NS2 to one
        NS2 = MAX0(1,NSLICE/2)
d60 1
d62 3
a64 3
              PR(NSC,L)=0.0
              AVSUM(NSC,L)=0.0
              AMP(NSC,L) =0.0
d69 4
a72 3
           IIK=(K-1)
           IF(IIK.GT.NS2)  IIK=IIK-NSLICE
           PK=(FLOAT(IIK)/FLOAT(NS2))**2
d74 3
a76 3
              IIJ=(J-1)
              IF(IIJ.GT.NR2)  IIJ=IIJ-NROW
              PJ=(FLOAT(IIJ)/FLOAT(NR2))**2
d80 2
a81 1
C               skip Hermitian related values
d84 3
a86 2
                PII = (FLOAT(III)/FLOAT(ND2))**2
                R   = SQRT(PII+PJ+PK)*0.5
d91 1
d104 1
a104 1
                   L = NINT(R*2*(INC-1))+1
d106 1
d109 1
a109 1
                      PHA = ATAN2(A(I+1,J,K),A(I,J,K))*RAD_TO_DGR
d113 1
d115 1
a115 1
                      PHB = ATAN2(B(I+1,J,K),B(I,J,K))*RAD_TO_DGR
a118 3
                   DPH = PHA-PHB
                   IF (DPH .GT. 180.0)  DPH=360.0-DPH
                   IF (DPH .LT. -180.0) DPH=360.0+DPH
d120 6
a125 2
                   QA = SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
                   QB = SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
d129 3
a131 2
                   CSUM1(L) = CSUM1(L)+QA*QA
                   CSUM2(L) = CSUM2(L)+QB*QB
d134 2
a135 1
                   DPH=DPH*DPH
d137 5
a141 5
                      SCALE        = SCALE1+(NSC-1)*DSCALE
                      QBS          = QB*SCALE
                      AVSUM(NSC,L) = AVSUM(NSC,L)+ABS(QA-QBS)
                      PR(NSC,L)    = PR(NSC,L)+((QA+QBS)/2.)*DPH
                      AMP(NSC,L)   = AMP(NSC,L)+((QA+QBS)/2.)
d144 5
a148 4
             ENDIF
3               CONTINUE
              ENDDO
           ENDDO
d150 1
@


1.30
log
@trap for r=0 & cosmetic
@
text
@a5 2
C=* FROM: SPIDER - MODULAR IMAGE PROCESSING SYSTEM.   AUTHOR: J.FRANK  *
C=* Copyright (C) 1985-2005  Health Research Inc.                      *
d7 5
a11 2
C=* HEALTH RESEARCH INCORPORATED (HRI),                                *   
C=* ONE UNIVERSITY PLACE, RENSSELAER, NY 12144-3455.                   *
d13 1
a13 3
C=* Email:  spider@@wadsworth.org                                       *
C=*                                                                    *
C=* This program is free software; you can redistribute it and/or      *
d18 1
a18 1
C=* This program is distributed in the hope that it will be useful,    *
d20 1
a20 1
C=* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  *
a21 1
C=*                                                                    *
d23 1
a23 3
C=* along with this program; if not, write to the                      *
C=* Free Software Foundation, Inc.,                                    *
C=* 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.      *
@


1.29
log
@GPL License fixed
@
text
@d1 1
a1 1
C++*********************************************************************
d3 1
a3 1
C $$ PR3DB.FOR
d30 4
a33 3
C TO CALCULATE THE 3-D PHASE RESIDUE OUTSIDE MISSING CONE, PR OF FOURIER
C RINGS(RADIUS, DIRECTION RELATIVE TO Z) AND OF FOURIER SHELLS(RADIUS) IS
C CALCULATED. 
a34 3
C IMAGE_PROCESSING_ROUTINE
C
C        1         2         3         4         5         6         7
d37 1
a37 3
C
C $$ PR3DB.FOR
C
d39 2
a40 2
     &  AVSUM,LSD,NSAM,NROW,NSLICE,DSCALE,NSCALE,SCALE1,SSANG,
     &  INC,Y1,WI,SER)
d51 1
a51 1
C
d55 4
a58 3
C for 2D case set NS2 to one
        NS2=MAX0(1,NSLICE/2)
C
d60 4
a63 4
           LR(L)=0
           CSUM(L)=0.0
           CSUM1(L)=0.0
           CSUM2(L)=0.0
d67 1
a67 1
              AMP(NSC,L)=0.0
d70 1
a70 1
C
d79 1
d81 20
a100 15
                 III=(I-1)/2
C skip Hermitian related values
         IF(III.GT.0 .OR.(IIK.GE.0 .AND. (IIJ.GE.0 .OR. IIK.NE.0))) THEN

                PII=(FLOAT(III)/FLOAT(ND2))**2
                R=SQRT(PII+PJ+PK)*0.5
                R1=SQRT(PII+PK)*0.5          ! r1=(x^2+z^2)^0.5
			 !if(r1.gt.0.05) goto 3
                IF(SER.EQ.'C')  THEN
                   IF(ACOS(AMIN1(1.0,SQRT(PK)/R)).LT.ZANG)  GO TO 3
                ELSEIF(SER.EQ.'W')  THEN
                   IF(R1.EQ.0.0)  THEN
                    FI=ACOS(1.0)
                   ELSE
                    FI=ACOS(AMIN1(1.0,SQRT(PK)/R1))
a101 2
                   IF(FI.LT.ZANG)  GO TO 3
                ENDIF
d103 36
a138 33
                L=NINT(R*2*(INC-1))+1
                IF(L.GT.INC)  GO TO 3
                LR(L)=LR(L)+1
                IF(A(I,J,K).NE.0.0)THEN
                   PHA=ATAN2(A(I+1,J,K),A(I,J,K))*RAD_TO_DGR
                ELSE
                   PHA=0
                ENDIF 
                IF(B(I,J,K).NE.0.0)THEN
                   PHB=ATAN2(B(I+1,J,K),B(I,J,K))*RAD_TO_DGR
                ELSE
                   PHB=0.0
                ENDIF 
                DPH=PHA-PHB
                IF(DPH.GT.180.0)  DPH=360.0-DPH
                IF(DPH.LT.-180.0) DPH=360.0+DPH

                QA=SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
                QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)

                CSUM(L)=CSUM(L)+A(I,J,K)*B(I,J,K)+A(I+1,J,K)*B(I+1,J,K)
                CSUM1(L)=CSUM1(L)+QA*QA
                CSUM2(L)=CSUM2(L)+QB*QB
C SCALES
                DPH=DPH*DPH
                DO  NSC=1,NSCALE
                   SCALE=SCALE1+(NSC-1)*DSCALE
                   QBS=QB*SCALE
                   AVSUM(NSC,L)=AVSUM(NSC,L)+ABS(QA-QBS)
                   PR(NSC,L)=PR(NSC,L)+((QA+QBS)/2.)*DPH
                   AMP(NSC,L)=AMP(NSC,L)+((QA+QBS)/2.)
                ENDDO
          ENDIF
@


1.28
log
@HRI GPL License used
@
text
@a1 1
C++************************************************************************
a5 3
C **************************************************************************
C * SPIDER - MODULAR IMAGE PROCESSING SYSTEM.  AUTHOR: J.FRANK         *
C *  SPIDER - MODULAR IMAGE PROCESSING SYSTEM.  AUTHOR: J.FRANK            *
d9 1
a9 1
C=* HEALTH RESEARCH INCORPORATED (HRI),                                *  
a28 7

C *  COPYRIGHT (C)1981,1987, WADSWORTH CENTER FOR LABORATORIES AND         *
C *  RESEARCH, NEW YORK STATE DEPARTMENT OF HEALTH, ALBANY, NY 12201.      *
C *  THE CONTENTS OF THIS DOCUMENT ARE PROPRIETARY TO THE CENTER FOR       *
C *  LABORATORIES AND RESEARCH AND ARE NOT TO BE DISCLOSED TO OTHERS OR    *
C *  USED FOR PURPOSES OTHER THAN INTENDED WITHOUT WRITTEN APPROVAL OF     *
C *  THE CENTER FOR LABORATORIES AND RESEARCH                              *
a29 1
C **************************************************************************
a38 1
C--************************************************************************
d104 1
a104 1
                LR(L)=LR(L)+2
@


1.27
log
@3-sigma criterion pp corrected
@
text
@d1 1
d6 1
d8 1
d10 24
d40 1
d50 1
@


1.26
log
@pp's determ. changes
@
text
@d88 1
a88 1
                LR(L)=LR(L)+1
@


1.25
log
@bug in W fixed
@
text
@d43 1
a43 1
C for 2D case set NS2 to zero
d60 1
a60 1
           IF(IIK.GT.NS2)IIK=IIK-NSLICE
d64 1
a64 1
              IF(IIJ.GT.NR2)IIJ=IIJ-NROW
d69 1
a69 5



         IF(IIJ.NE.0 .OR. IIK.NE.0 .OR. III.GT.0) THEN

d73 5
a77 5
                R1=SQRT(PII+PK)*0.5    
                IF(R.GE.0.5)  GO TO 4
                IF(SER.EQ.'C')THEN
                   FI=ACOS(AMIN1(1.0,SQRT(PK)/R))
                ELSE
a82 2
                ENDIF
                IF(ZANG.NE.0.)THEN
d85 3
a87 1
                L=MIN0(MAX0(NINT(R*Y1/WI)+1,1),INC)
d106 1
a106 1
             CSUM(L)=CSUM(L)+A(I,J,K)*B(I,J,K)+A(I+1,J,K)*B(I+1,J,K)
a117 1

a120 2

4             CONTINUE
@


1.24
log
@bug in option W fixed
@
text
@d83 1
a83 1
	            FI=ACOS(1.0)
d86 1
a86 1
	           ENDIF
d89 1
a89 1
                   IF(FI.LT.ZANG)  GO TO 4
d124 1
a124 1

@


1.23
log
@adapted for dynamical memory allocation
@
text
@d82 5
a86 1
                   FI=ACOS(AMIN1(1.0,SQRT(PK)/R1))
@


1.22
log
@*** empty log message ***
@
text
@d17 4
d26 1
a26 1
	SUBROUTINE PR3DB(A,B,PR,AMP,CSUM1,LR,CSUM,CSUM2,
d29 7
a35 5
	DIMENSION A(LSD,NROW,NSLICE),B(LSD,NROW,NSLICE)
	DIMENSION PR(NSCALE,INC),AMP(NSCALE,INC),AVSUM(NSCALE,INC)
	DIMENSION CSUM1(INC),CSUM2(INC),LR(INC)
	DIMENSION CSUM(INC)
	CHARACTER*1 SER
d38 1
a38 1
	PARAMETER (DGR_TO_RAD = (QUADPI/180))
d40 1
a40 1
	ZANG=(90.0-SSANG)*DGR_TO_RAD
d46 22
a67 22
	DO  L=1,INC
	 LR(L)=0
	 CSUM(L)=0.0
	 CSUM1(L)=0.0
	 CSUM2(L)=0.0
	  DO  NSC=1,NSCALE
	   PR(NSC,L)=0.0
	   AVSUM(NSC,L)=0.0
	   AMP(NSC,L)=0.0
	  ENDDO
	ENDDO
C
	DO 4 K=1,NSLICE
	 IIK=(K-1)
	 IF(IIK.GT.NS2)IIK=IIK-NSLICE
	 PK=(FLOAT(IIK)/FLOAT(NS2))**2
	  DO 4 J=1,NROW
	   IIJ=(J-1)
	   IF(IIJ.GT.NR2)IIJ=IIJ-NROW
	   PJ=(FLOAT(IIJ)/FLOAT(NR2))**2
	    DO 41 I=1,LSD,2
	     III=(I-1)/2
d69 40
a108 35
	IF(IIJ.EQ.0 .AND. IIK.EQ.0 .AND. III.LE.0)  GOTO 41
	     PII=(FLOAT(III)/FLOAT(ND2))**2
	     R=SQRT(PII+PJ+PK)*0.5
             R1=SQRT(PII+PK)*0.5    
	     IF(R.GE.0.5)  GO TO 4
	     IF(SER.EQ.'C')THEN
	      FI=ACOS(AMIN1(1.0,SQRT(PK)/R))
	     ELSE
	      FI=ACOS(AMIN1(1.0,SQRT(PK)/R1))
	     ENDIF
	     IF(ZANG.NE.0.)THEN
	       IF(FI.LT.ZANG)  GO TO 4
	     ENDIF
	     L=MIN0(MAX0(NINT(R*Y1/WI)+1,1),INC)
	     LR(L)=LR(L)+1
	     IF(A(I,J,K).NE.0.0)THEN
               PHA=ATAN2(A(I+1,J,K),A(I,J,K))*RAD_TO_DGR
             ELSE
               PHA=0
             ENDIF 
	     IF(B(I,J,K).NE.0.0)THEN
              PHB=ATAN2(B(I+1,J,K),B(I,J,K))*RAD_TO_DGR
             ELSE
              PHB=0.0
             ENDIF 
	     DPH=PHA-PHB
	     IF(DPH.GT.180.0)  DPH=360.0-DPH
	     IF(DPH.LT.-180.0) DPH=360.0+DPH
C
	     QA=SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
	     QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
C
	     CSUM(L)=CSUM(L)+A(I,J,K)*B(I,J,K)+A(I+1,J,K)*B(I+1,J,K)
	     CSUM1(L)=CSUM1(L)+QA*QA
	     CSUM2(L)=CSUM2(L)+QB*QB
d110 17
a126 11
	     DPH=DPH*DPH
	     DO  NSC=1,NSCALE
	      SCALE=SCALE1+(NSC-1)*DSCALE
	      QBS=QB*SCALE
	      AVSUM(NSC,L)=AVSUM(NSC,L)+ABS(QA-QBS)
	      PR(NSC,L)=PR(NSC,L)+((QA+QBS)/2.)*DPH
	      AMP(NSC,L)=AMP(NSC,L)+((QA+QBS)/2.)
	    ENDDO
41	  CONTINUE
4	CONTINUE
	END
@


1.21
log
@*** empty log message ***
@
text
@d32 1
d34 1
a34 2
	PI=4.0*DATAN(1.0D0)
	ZANG=(90.0-SSANG)*PI/180.0
@


1.20
log
@int->nint
@
text
@d30 2
d79 1
a79 1
               PHA=ATAN2(A(I+1,J,K),A(I,J,K))*180./PI
d84 1
a84 1
              PHB=ATAN2(B(I+1,J,K),B(I,J,K))*180./PI
@


1.19
log
@new version
@
text
@d74 1
a74 1
	     L=MIN0(MAX0(INT(R*Y1/WI)+1,1),INC)
@


1.18
log
@argumnet of ACOS limited for DEC workstations.
@
text
@a29 1
CNO_SAVE
d31 2
a32 2
	PI=4.0*ATAN(1.00)
	ZANG=(90-SSANG)*PI/180.0
d35 2
a36 1
        NS2=NSLICE/2
d39 9
a47 8
	LR(L)=0
	CSUM(L)=0.0
	CSUM1(L)=0.0
	CSUM2(L)=0.0
	DO  NSC=1,NSCALE
	PR(NSC,L)=0.0
	AVSUM(NSC,L)=0.0
	AMP(NSC,L)=0.0
a48 1
	ENDDO
d51 9
a59 9
	IIK=(K-1)
	IF(IIK.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)/FLOAT(NS2))**2
	DO 4 J=1,NROW
	IIJ=(J-1)
	IF(IIJ.GT.NR2)IIJ=IIJ-NROW
	PJ=(FLOAT(IIJ)/FLOAT(NR2))**2
	DO 41 I=1,LSD,2
	III=(I-1)/2
d62 27
a88 27
	PII=(FLOAT(III)/FLOAT(ND2))**2
	R=SQRT(PII+PJ+PK)*0.5
        R1=SQRT(PII+PK)*0.5    
	IF(R.GE.0.5)  GO TO 4
	IF(SER.EQ.'C')THEN
	FI=ACOS(AMIN1(1.0,SQRT(PK)/R))
	ELSE
	FI=ACOS(AMIN1(1.0,SQRT(PK)/R1))
	ENDIF
	IF(ZANG.NE.0.)THEN
	  IF(FI.LT.ZANG)  GO TO 4
	ENDIF
	L=MIN0(MAX0(INT(R*Y1/WI)+1,1),INC)
	LR(L)=LR(L)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I+1,J,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I+1,J,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
	DPH=PHA-PHB
	IF(DPH.GT.180.0)  DPH=360.0-DPH
	IF(DPH.LT.-180.0) DPH=360.0+DPH
d90 2
a91 2
	QA=SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
d93 3
a95 3
	CSUM(L)=CSUM(L)+A(I,J,K)*B(I,J,K)+A(I+1,J,K)*B(I+1,J,K)
	CSUM1(L)=CSUM1(L)+QA*QA
	CSUM2(L)=CSUM2(L)+QB*QB
d97 9
a105 9
	DPH=DPH*DPH
	DO  NSC=1,NSCALE
	SCALE=SCALE1+(NSC-1)*DSCALE
	QBS=QB*SCALE
	AVSUM(NSC,L)=AVSUM(NSC,L)+ABS(QA-QBS)
	PR(NSC,L)=PR(NSC,L)+((QA+QBS)/2.)*DPH
	AMP(NSC,L)=AMP(NSC,L)+((QA+QBS)/2.)
	ENDDO
41	CONTINUE
@


1.17
log
@freq fixed
@
text
@d67 1
a67 1
	FI=ACOS(SQRT(PK)/R)
d69 1
a69 1
	FI=ACOS(SQRT(PK)/R1)
@


1.16
log
@modified intrinisic function call for f90 compatibility
@
text
@d53 1
a53 1
	PK=(FLOAT(IIK)*0.5/FLOAT(NS2+1))**2
d57 1
a57 1
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NR2+1))**2
d62 3
a64 3
	PII=(FLOAT(III)*0.5/FLOAT(ND2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
@


1.15
log
@*** empty log message ***
@
text
@d74 1
a74 1
	L=MIN0(MAX0(JNINT(R*Y1/WI)+1,1),INC)
@


1.14
log
@corrected
@
text
@d38 1
a38 1
	DO 945 L=1,INC
d43 1
a43 1
	DO 945 NSC=1,NSCALE
d46 3
a48 1
945	AMP(NSC,L)=0.0
d98 1
a98 1
	DO 44 NSC=1,NSCALE
d103 2
a104 1
44	AMP(NSC,L)=AMP(NSC,L)+((QA+QBS)/2.)
@


1.13
log
@fourier radius greater than 0.5 removed.
@
text
@d23 1
a23 1
     &  AVSUM,NSAM,NROW,NSLICE,DSCALE,NSCALE,SCALE1,SSANG,
d25 4
a28 5
	DIMENSION A(NSAM,NROW,NSLICE),B(NSAM,NROW,NSLICE)
	DIMENSION PR(NSCALE,INC),AMP(NSCALE,INC),LR(INC)
	DIMENSION CSUM1(NSCALE,INC),CSUM2(NSCALE,INC)
	DIMENSION CSUM(NSCALE,INC),AVSUM(NSCALE,INC)
	LOGICAL IFNS,IFNR,IFND
a33 18
        IFNR=MOD(NROW,2).EQ.0
        IFND=MOD(NSAM,2).EQ.0
	IFNS=MOD(NSLICE,2).EQ.0
        IF(IFND)  THEN
        LBD=2
        ELSE
        LBD=1
        ENDIF
        IF(IFNR)  THEN
        LBR=2
        ELSE
        LBR=1
        ENDIF
        IF(IFNS)  THEN
        LBS=2
        ELSE
        LBS=1
        ENDIF
d40 3
a43 3
	CSUM(NSC,L)=0.0
	CSUM1(NSC,L)=0.0
	CSUM2(NSC,L)=0.0
d51 1
a51 1
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
d55 2
a56 2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 41 I=3,NSAM-1,2
d58 3
a60 1
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
d63 1
a63 1
	IF(R.GE.0.5)GO TO 4
d70 1
a70 1
	  IF(FI.LT.ZANG)GO TO 4
d72 1
a72 1
	L=JINT(R*Y1/WI)+1
a73 5
C SCALES
	DO 44 NSC=1,NSCALE
	SCALE=SCALE1+(NSC-1)*DSCALE
	F21=B(I,J,K)*SCALE
	F22=B(I+1,J,K)*SCALE
d79 2
a80 2
	IF(F21.NE.0.0)THEN
          PHB=ATAN2(F22,F21)*180./PI
d84 4
a87 3
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360.0-DPH
                IF (DPH.LT.-180.0) DPH=DPH+360.0
d89 1
a89 1
	QB=SQRT(F21**2+F22**2)
d91 11
a101 8
	CSUM(NSC,L)=CSUM(NSC,L)+A(I,J,K)*F21+
     &  A(I+1,J,K)*F22
	CSUM1(NSC,L)=CSUM1(NSC,L)+QA**2
	CSUM2(NSC,L)=CSUM2(NSC,L)+QB**2
	AVSUM(NSC,L)=AVSUM(NSC,L)+ABS(QA-QB)
	PR(NSC,L)=PR(NSC,L)+((QA+QB)/2.)*DPH**2
	AMP(NSC,L)=AMP(NSC,L)+((QA+QB)/2.)
44	CONTINUE
a102 44
	IF(.NOT.IFND)THEN
	PII=(FLOAT(ND2)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
	IF(R.GE.0.5)GO TO 4
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
	IF(ZANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 4
	ENDIF
	L=JINT(R*Y1/WI)+1
	LR(L)=LR(L)+1
C SCALES
	DO 55 NSC=1,NSCALE
	SCALE=SCALE1+(FLOAT(NSC-1))*DSCALE
	F21=B(NSAM,J,K)*SCALE
	F22=B(2,J,K)*SCALE
	IF(A(NSAM,J,K).NE.0.0)THEN
          PHA=ATAN2(A(2,J,K),A(NSAM,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(F21.NE.0.0)THEN
          PHB=ATAN2(F22,F21)*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360.0-DPH
                IF (DPH.LT.-180.0) DPH=360.0+DPH
	QA=SQRT(A(NSAM,J,K)**2+A(2,J,K)**2)
	QB=SQRT(F21**2+F22**2)
	CSUM(NSC,L)=CSUM(NSC,L)+A(NSAM,J,K)*F21+
     &  A(2,J,K)*F22
	CSUM1(NSC,L)=CSUM1(NSC,L)+QA**2
	CSUM2(NSC,L)=CSUM2(NSC,L)+QB**2
	AVSUM(NSC,L)=AVSUM(NSC,L)+ABS(QA-QB)
	PR(NSC,L)=PR(NSC,L)+((QA+QB)/2.)*DPH**2
	AMP(NSC,L)=AMP(NSC,L)+((QA+QB)/2.)
55	CONTINUE
	ENDIF
a103 199
C
	DO 20 I=1,LBD
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	DO 20 J=1,LBR
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 201 K=3,NSLICE-1,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	R=SQRT(PII+PJ+PK)
	R1=SQRT(PII+PK)	
	IF(R.GE.0.5)GO TO 20
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
  	FI=ACOS(SQRT(PK)/R1)  
	ENDIF
	IF(ZANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 20
	ENDIF
	L=JINT(R*Y1/WI)+1
	LR(L)=LR(L)+1
C SCALES
	DO 134 NSC=1,NSCALE
	SCALE=SCALE1+(FLOAT(NSC-1))*DSCALE
	F22=B(I,J,K+1)*SCALE
	F21=B(I,J,K)*SCALE
C
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
C
	IF(F21.NE.0.0)THEN
          PHB=ATAN2(F22,F21)*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360.0-DPH
                IF (DPH.LT.-180.0) DPH=360.0+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(F21**2+F22**2)
	CSUM(NSC,L)=CSUM(NSC,L)+A(I,J,K)*F21+
     &  A(I,J,K+1)*F22
	CSUM1(NSC,L)=CSUM1(NSC,L)+QA**2
	CSUM2(NSC,L)=CSUM2(NSC,L)+QB**2
	AVSUM(NSC,L)=AVSUM(NSC,L)+ABS(QA-QB)
	PR(NSC,L)=PR(NSC,L)+((QA+QB)/2.)*DPH**2
	AMP(NSC,L)=AMP(NSC,L)+((QA+QB)/2.)
134	CONTINUE
201	CONTINUE	
	IF(.NOT.IFNS)THEN
	PK=(FLOAT(NS2)*0.5/FLOAT(NSLICE/2+1))**2
	R=SQRT(PII+PJ+PK)
	R1=SQRT(PII+PK)	
	IF(R.GE.0.5)GO TO 20
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
  	FI=ACOS(SQRT(PK)/R1)  
	ENDIF
	IF(ZANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 20
	ENDIF
	L=JINT(R*Y1/WI)+1
	LR(L)=LR(L)+1
C SCALES
	DO 189 NSC=1,NSCALE
	F22=B(I,J,2)*SCALE
	F21=B(I,J,NSLICE)*SCALE
	IF(A(I,J,NSLICE).NE.0.0)THEN
          PHA=ATAN2(A(I,J,2),A(I,J,NSLICE))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(F21.NE.0.0)THEN
          PHB=ATAN2(F22,F21)*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360.0-DPH
                IF (DPH.LT.-180.0) DPH=360.0+DPH
	QA=SQRT(A(I,J,NSLICE)**2+A(I,J,2)**2)
	QB=SQRT(F22**2+F21**2)
	CSUM(NSC,L)=CSUM(NSC,L)+A(I,J,NSLICE)*F21+
     &  A(I,J,2)*F22
	CSUM1(NSC,L)=CSUM1(NSC,L)+QA**2
	CSUM2(NSC,L)=CSUM2(NSC,L)+QB**2
	PR(NSC,L)=PR(NSC,L)+((QA+QB)/2.)*DPH**2
	AVSUM(NSC,L)=AVSUM(NSC,L)+ABS(QA-QB)
	AMP(NSC,L)=AMP(NSC,L)+((QA+QB)/2.)
189	CONTINUE
	ENDIF
20	CONTINUE
C
	DO 3 I=1,LBD
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	DO 3 K=1,NSLICE
	IIK=(K-1)
	IF(IIK.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 31 J=3,NROW-1,2
	IIJ=(J-1)/2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	R=SQRT(PII+PJ+PK)
	R1=SQRT(PII+PK)
	IF(R.GE.0.5)GO TO 3
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1) 
	ENDIF
	IF(ZANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 3
	ENDIF
	L=JINT(R*Y1/WI)+1
	LR(L)=LR(L)+1
C SCALES
	DO 156 NSC=1,NSCALE
	SCALE=SCALE1+(FLOAT(NSC-1))*DSCALE
	F22=B(I,J+1,K)*SCALE
	F21=B(I,J,K)*SCALE
C
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J+1,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
C
	IF(F21.NE.0.0)THEN
          PHB=ATAN2(F22,F21)*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360.0-DPH
                IF (DPH.LT.-180.0) DPH=360.0+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J+1,K)**2)
	QB=SQRT(F21**2+F22**2)
	CSUM(NSC,L)=CSUM(NSC,L)+A(I,J,K)*F21+
     &  A(I,J+1,K)*F22
	CSUM1(NSC,L)=CSUM1(NSC,L)+QA**2
	CSUM2(NSC,L)=CSUM2(NSC,L)+QB**2
	AVSUM(NSC,L)=AVSUM(NSC,L)+ABS(QA-QB)
	PR(NSC,L)=PR(NSC,L)+((QA+QB)/2.)*DPH**2
	AMP(NSC,L)=AMP(NSC,L)+((QA+QB)/2.)
156	CONTINUE
31	CONTINUE
	IF(.NOT.IFNR)THEN
	PJ=(FLOAT(NR2)*0.5/FLOAT(NROW/2+1))**2
	R=SQRT(PII+PJ+PK)
	R1=SQRT(PII+PK)
	IF(R.GE.0.5)GO TO 3
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1) 
	ENDIF
	IF(ZANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 3
	ENDIF
	L=JINT(R*Y1/WI)+1
	LR(L)=LR(L)+1
C SCALES
	DO 143 NSC=1,NSCALE
	SCALE=SCALE1+(FLOAT(NSC-1))*DSCALE
	F21=B(I,NROW,K)*SCALE
	F22=B(I,2,K)*SCALE
	IF(A(I,NROW,K).NE.0.0)THEN
          PHA=ATAN2(A(I,2,K),A(I,NROW,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(F21.NE.0.0)THEN
          PHB=ATAN2(F22,F21)*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360.0-DPH
                IF (DPH.LT.-180.0) DPH=360.0+DPH
	QA=SQRT(A(I,2,K)**2+A(I,NROW,K)**2)
	QB=SQRT(F22**2+F21**2)
	CSUM(NSC,L)=CSUM(NSC,L)+A(I,2,K)*F22+
     &  A(I,NROW,K)*F21
	CSUM1(NSC,L)=CSUM1(NSC,L)+QA**2
	CSUM2(NSC,L)=CSUM2(NSC,L)+QB**2
	AVSUM(NSC,L)=AVSUM(NSC,L)+ABS(QA-QB)
	PR(NSC,L)=PR(NSC,L)+((QA+QB)/2.)*DPH**2
	AMP(NSC,L)=AMP(NSC,L)+((QA+QB)/2.)
143	CONTINUE
	ENDIF
3	CONTINUE
C
@


1.12
log
@included scale search for each shell
@
text
@d80 1
a80 1
	IF(R.GT.0.5)GO TO 4
d125 1
a125 1
	IF(R.GT.0.5)GO TO 4
d178 1
a178 1
	IF(R.GT.0.5)GO TO 20
d224 1
a224 1
	IF(R.GT.0.5)GO TO 20
d277 1
a277 1
	IF(R.GT.0.5)GO TO 3
d323 1
a323 1
	IF(R.GT.0.5)GO TO 3
@


1.11
log
@changed FRC to old formula
@
text
@d23 2
a24 1
     &  NSAM,NROW,NSLICE,SSANG,INC,Y1,WI,SER)
d26 3
a28 2
	DIMENSION PR(INC),AMP(INC),LR(INC),CSUM1(INC),CSUM(INC)
	DIMENSION CSUM2(INC)
a57 4
	CSUM(L)=0.0
	CSUM1(L)=0.0
	CSUM2(L)=0.0
	PR(L)=0.0
d59 7
a65 1
945	AMP(L)=0.0
d90 6
d101 2
a102 2
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I+1,J,K),B(I,J,K))*180./PI
d107 2
a108 2
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
d110 11
a120 8
	QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
	CSUM(L)=CSUM(L)+A(I,J,K)*B(I,J,K)+
     &  A(I+1,J,K)*B(I+1,J,K)
	CSUM1(L)=CSUM1(L)+QA**2
	CSUM2(L)=CSUM2(L)+QB**2
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
41	LR(L)=LR(L)+1
d135 6
d146 2
a147 2
	IF(B(NSAM,J,K).NE.0.0)THEN
          PHB=ATAN2(B(2,J,K),B(NSAM,J,K))*180./PI
d152 2
a153 2
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
d155 9
a163 8
	QB=SQRT(B(NSAM,J,K)**2+B(2,J,K)**2)
	CSUM(L)=CSUM(L)+A(NSAM,J,K)*B(NSAM,J,K)+
     &  A(2,J,K)*B(2,J,K)
	CSUM1(L)=CSUM1(L)+QA**2
	CSUM2(L)=CSUM2(L)+QB**2
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
d188 7
d200 3
a202 2
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
d207 2
a208 2
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
d210 10
a219 8
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	CSUM(L)=CSUM(L)+A(I,J,K)*B(I,J,K)+
     &  A(I,J,K+1)*B(I,J,K+1)
	CSUM1(L)=CSUM1(L)+QA**2
	CSUM2(L)=CSUM2(L)+QB**2
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
201	LR(L)=LR(L)+1
d234 5
d244 2
a245 2
	IF(B(I,J,NSLICE).NE.0.0)THEN
          PHB=ATAN2(B(I,J,2),B(I,J,NSLICE))*180./PI
d250 2
a251 2
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
d253 9
a261 8
	QB=SQRT(B(I,J,NSLICE)**2+B(I,J,2)**2)
	CSUM(L)=CSUM(L)+A(I,J,NSLICE)*B(I,J,NSLICE)+
     &  A(I,J,2)*B(I,J,2)
	CSUM1(L)=CSUM1(L)+QA**2
	CSUM2(L)=CSUM2(L)+QB**2
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
d277 1
a277 1
	IF(R.GT.0.5)GO TO3
d287 7
d299 3
a301 2
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J+1,K),B(I,J,K))*180./PI
d306 2
a307 2
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
d309 10
a318 8
	QB=SQRT(B(I,J,K)**2+B(I,J+1,K)**2)
	CSUM(L)=CSUM(L)+A(I,J,K)*B(I,J,K)+
     &  A(I,J+1,K)*B(I,J+1,K)
	CSUM1(L)=CSUM1(L)+QA**2
	CSUM2(L)=CSUM2(L)+QB**2
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
31	LR(L)=LR(L)+1
d323 1
a323 1
	IF(R.GT.0.5)GO TO3
d333 6
d344 2
a345 2
	IF(B(I,NROW,K).NE.0.0)THEN
          PHB=ATAN2(B(I,2,K),B(I,NROW,K))*180./PI
d350 2
a351 2
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
d353 9
a361 8
	QB=SQRT(B(I,2,K)**2+B(I,NROW,K)**2)
	CSUM(L)=CSUM(L)+A(I,2,K)*B(I,2,K)+
     &  A(I,NROW,K)*B(I,NROW,K)
	CSUM1(L)=CSUM1(L)+QA**2
	CSUM2(L)=CSUM2(L)+QB**2
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
a364 8
	DO 6751 L=1,INC
	IF(AMP(L).NE.0.)THEN
	PR(L)=SQRT(PR(L)/AMP(L))
	ENDIF
	IF(CSUM1(L).NE.0.OR.CSUM2(L).NE.0.)THEN
	CSUM1(L)=CSUM(L)/SQRT(CSUM1(L)*CSUM2(L))
	ENDIF
6751	CONTINUE
@


1.10
log
@nosave
@
text
@d22 1
a22 1
	SUBROUTINE PR3DB(A,B,PR,AMP,CSUM1,CSUM2,LR,CSUM,
d25 2
a26 2
	DIMENSION PR(INC),AMP(INC),LR(INC),CSUM2(INC),CSUM1(INC)
	COMPLEX CSUM(INC)
d101 3
a103 3
	CSUM(L)=CSUM(L)+(CMPLX(A(I,J,K),A(I+1,J,K))*
     &  CMPLX(B(I,J,K),-B(I+1,J,K)))
	CSUM1(L)=CSUM1(L)+QA*QB
d137 3
a139 3
	CSUM(L)=CSUM(L)+(CMPLX(A(NSAM,J,K),A(2,J,K))*
     &  CMPLX(B(NSAM,J,K),-B(2,J,K)))
	CSUM1(L)=CSUM1(L)+QA*QB
d183 3
a185 3
	CSUM(L)=CSUM(L)+(CMPLX(A(I,J,K),A(I,J,K+1))*
     &  CMPLX(B(I,J,K),-B(I,J,K+1)))
	CSUM1(L)=CSUM1(L)+QA*QB
d219 3
a221 3
	CSUM(L)=CSUM(L)+(CMPLX(A(I,J,NSLICE),A(I,J,2))*
     &  CMPLX(B(I,J,NSLICE),-B(I,J,2)))
	CSUM1(L)=CSUM1(L)+QA*QB
d266 3
a268 3
	CSUM(L)=CSUM(L)+(CMPLX(A(I,J,K),A(I,J+1,K))*
     &  CMPLX(B(I,J,K),-B(I,J+1,K)))
	CSUM1(L)=CSUM1(L)+QA*QB
d302 3
a304 3
	CSUM(L)=CSUM(L)+(CMPLX(A(I,NROW,K),A(I,2,K))*
     &  CMPLX(B(I,NROW,K),-B(I,2,K)))
	CSUM1(L)=CSUM1(L)+QA*QB
d316 3
a318 3
c	IF((CSUM1(L)*CSUM2(L)).NE.0.)THEN
	CSUM1(L)=CSUM(L)/CSUM1(L)
c	ENDIF
@


1.9
log
@changed to new f.s. formula and 3 sigma
@
text
@d1 21
d29 1
a319 1
	RETURN
@


1.8
log
@fixed
@
text
@d81 1
a81 1
	CSUM1(L)=CSUM1(L)+QA**2
d117 1
a117 1
	CSUM1(L)=CSUM1(L)+QA**2
d163 1
a163 1
	CSUM1(L)=CSUM1(L)+QA**2
d199 1
a199 1
	CSUM1(L)=CSUM1(L)+QA**2
d246 1
a246 1
	CSUM1(L)=CSUM1(L)+QA**2
d282 1
a282 1
	CSUM1(L)=CSUM1(L)+QA**2
d294 3
a296 3
	IF((CSUM1(L)*CSUM2(L)).NE.0.)THEN
	CSUM1(L)=REAL(CSUM(L))/SQRT(CSUM1(L)*CSUM2(L))
	ENDIF
@


1.7
log
@fourier ring correlation added
@
text
@d60 1
a60 1
	IF(SSANG.NE.0.)THEN
d96 1
a96 1
	IF(SSANG.NE.0.)THEN
d142 1
a142 1
	IF(SSANG.NE.0.)THEN
d178 1
a178 1
	IF(SSANG.NE.0.)THEN
d225 1
a225 1
	IF(SSANG.NE.0.)THEN
d261 1
a261 1
	IF(SSANG.NE.0.)THEN
@


1.6
log
@*** empty log message ***
@
text
@a296 4
	FNC=(L-1)*WI/Y1
	CRIT=2./SQRT(PI*WI*(FLOAT(L)-0.5))
	WRITE(6,500)L,FNC,PR(L),CSUM1(L),CRIT,LR(L)
500	FORMAT(2X,I3,4(2X,F12.5),I6)
@


1.5
log
@/
@
text
@d1 2
a2 2
	SUBROUTINE PR3DB(A,B,PR,AMP,LR,NSAM,NROW,NSLICE,SSANG,
     &  	INC,Y1,WI,SER)
d4 2
a5 1
	DIMENSION PR(INC),AMP(INC),LR(INC)
d14 19
d34 3
a40 12
	IF(IFND) THEN
	 IF(IFNR)THEN
C
C***********************************************************************
C******************NSAM, NROW ARE EVEN**********************************
C************************************************************************
C
	NR2=NROW/2
	ND2=NSAM/2
	NS2=NSLICE/2
C
C
d43 1
a43 1
	IF(K.GT.NS2)IIK=IIK-NSLICE
d47 1
a47 1
	IF(J.GT.NR2)IIJ=IIJ-NROW
d49 1
a49 1
	DO 4 I=3,NSAM,2
a50 2
C	TT2=TT2+A(I,J,K)**2+A(I+1,J,K)**2
C
a51 1
c
a53 1
c
a54 1
C
d57 1
a57 1
	else
d59 1
a59 4
	endif
C
C CHECKING FOR MISSING CONE
C
a62 2
C
C
d79 4
d85 3
a87 18
	LR(L)=LR(L)+1
4	CONTINUE
C
C
	IF(IFNS)THEN
C
C*********************NSLICE IS EVEN***********************************
	DO 20 K=3,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 20 J=1,2
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 20 I=1,2
	III=(I-1)*ND2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
C
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
d89 2
a90 4
	R1=SQRT(PII+PK)	
c
	IF(R.GT.0.5)GO TO 20
C
d94 1
a94 1
  	FI=ACOS(SQRT(PK)/R1)  
a95 3
C
C CHECKING FOR MISSING CONE
C
d97 1
a97 1
	  IF(FI.LT.ZANG)GO TO 20
a98 1
C
d100 2
a101 2
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
d105 2
a106 2
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
d113 6
a118 2
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
a121 24
20	CONTINUE
C
	ELSE
C
C***********************NSLICE IS ODD************************************
C
C
	DO 200 K=2,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 200 J=1,2
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 200 I=1,2
	III=(I-1)*ND2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK) 
  	IF(R.GT.0.5)GO TO 200 
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)  
d123 1
a123 2
c
C CHECKING FOR MISSING CONE
d125 1
a125 36
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 200
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
200	CONTINUE
C
	ENDIF
C
C************************************************************************
	DO 3 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 3 J=3,NROW,2
	IIJ=(J-1)/2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 3 I=1,2
a126 2
C	TT4=TT4+A(I,J,K)**2+A(I,J+1,K)**2
C
d128 1
a128 105
	R=SQRT(PII+PJ+PK)
	R1=SQRT(PII+PK)
	IF(R.GT.0.5)GO TO3
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	else
	FI=ACOS(SQRT(PK)/R1) 
	ENDIF
C
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 3
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J+1,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J+1,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J+1,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J+1,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

3	CONTINUE

C
	ELSE
C
C******************************************************************************
C*********************NSAM IS EVEN AND NROW IS ODD*************************
C******************************************************************************
C
	NR2=NROW/2
	ND2=NSAM/2
	NS2=NSLICE/2
C
C
	DO 74 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 74 J=1,NROW
	IIJ=(J-1)
	IF(J.GT.NR2)IIJ=IIJ-NROW
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 74 I=3,NSAM,2
	III=(I-1)/2
C	TT2=TT2+A(I,J,K)**2+A(I+1,J,K)**2
C
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK) 
	IF(R.GT.0.5)GO TO 74
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)  
	ENDIF
c
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 74
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I+1,J,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I+1,J,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

74	CONTINUE
C
	IF(IFNS)THEN
C
C*********************NSLICE IS EVEN***********************************
C
	J=1
d131 1
a131 1
	DO 720 K=3,NSLICE,2
a133 4
	DO 720 I=1,2
	III=(I-1)*ND2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
d135 2
a136 2
        R1=SQRT(PII+PK)
	IF(R.GT.0.5)GO TO 720
d140 1
a140 1
 	FI=ACOS(SQRT(PK)/R1)    
a141 3
C
C CHECKING FOR MISSING CONE
C
d143 1
a143 1
	  IF(FI.LT.ZANG)GO TO 720
a144 1
C
d161 4
d167 3
a169 17
	LR(L)=LR(L)+1
720	CONTINUE
C
	ELSE
C
C***********************NSLICE IS ODD************************************
C
	J=1
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 7200 K=2,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 7200 I=1,2
	III=(I-1)*ND2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
d171 2
a172 2
        R1=SQRT(PII+PK)  
 	IF(R.GT.0.5)GO TO 7200	
d176 1
a176 1
	FI=ACOS(SQRT(PK)/R1)  
a177 3
C
C CHECKING FOR MISSING CONE
C
d179 1
a179 1
	  IF(FI.LT.ZANG)GO TO 7200
a180 1
C
d182 2
a183 2
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
d187 2
a188 2
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
d195 6
a200 2
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
a203 2
7200	CONTINUE
C
d205 1
d207 1
a207 9
C************************************************************************
	DO 73 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 73 J=2,NROW,2
	IIJ=(J-1)/2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 73 I=1,2
a208 1
C	TT4=TT4+A(I,J,K)**2+A(I,J+1,K)**2
d210 1
a210 49
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)
	IF(R.GT.0.5)GO TO 73
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
 	FI=ACOS(SQRT(PK)/R1)   
	ENDIF
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 73
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J+1,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J+1,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J+1,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J+1,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

73	CONTINUE
C
	ENDIF
	ELSE
	IF(IFNR)THEN
C******************************************************************************
C*********************NSAM IS ODD AND NROW IS EVEN*************************
C******************************************************************************
C
	NR2=NROW/2
	ND2=NSAM/2
	NS2=NSLICE/2
C
C
	DO 44 K=1,NSLICE
d212 1
a212 1
	IF(K.GT.NS2)IIK=IIK-NSLICE
d214 1
a214 157
	DO 44 J=1,NROW
	IIJ=(J-1)
	IF(J.GT.NR2)IIJ=IIJ-NROW
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 44 I=2,NSAM,2
	III=(I-1)/2
C	TT2=TT2+A(I,J,K)**2+A(I+1,J,K)**2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)
	IF(R.GT.0.5)GO TO 44	
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)  
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 44
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I+1,J,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I+1,J,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
44	CONTINUE
C
	IF(IFNS)THEN
C
C*********************NSLICE IS EVEN***********************************
C
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	DO 209 K=3,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 209 J=1,2
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 209
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 209
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

209	CONTINUE
C
	ELSE
C
C***********************NSLICE IS ODD************************************
C
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	DO 2008 K=2,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 2008 J=1,2
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 2008
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 2008
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

2008	CONTINUE
C
	ENDIF
C
C************************************************************************
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	DO 39 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 39 J=3,NROW,2
a216 1
C	TT4=TT4+A(I,J,K)**2+A(I,J+1,K)**2
d218 2
a219 2
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 39	
d223 1
a223 1
	FI=ACOS(SQRT(PK)/R1)
a224 3
C
C CHECKING FOR MISSING CONE
C
d226 1
a226 1
	  IF(FI.LT.ZANG)GO TO 39
a227 1
C
d244 4
d250 3
a252 25
	LR(L)=LR(L)+1
39	CONTINUE
C
	ELSE
C******************************************************************************
C*********************NSAM AND NROW ARE BOTH ODD*******************************
C*****************************************************************************
C
	NR2=NROW/2
	ND2=NSAM/2
	NS2=NSLICE/2
C
C
	DO 49 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 49 J=1,NROW
	IIJ=(J-1)
	IF(J.GT.NR2)IIJ=IIJ-NROW
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 49 I=2,NSAM,2
	III=(I-1)/2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
C	TT2=TT2+A(I,J,K)**2+A(I+1,J,K)**2
d254 2
a255 2
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 49
d259 1
a259 1
	FI=ACOS(SQRT(PK)/R1)
a260 3
C
C CHECKING FOR MISSING CONE
C
d262 1
a262 1
	  IF(FI.LT.ZANG)GO TO 49
a263 1
C
d265 2
a266 2
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I+1,J,K),A(I,J,K))*180./PI
d270 2
a271 2
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I+1,J,K),B(I,J,K))*180./PI
d278 6
a283 2
	QA=SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
a286 25

49	CONTINUE
	IF(IFNS)THEN
C
C*********************NSLICE IS EVEN***********************************
C
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
C
	J=1
	IIJ=(J-1)
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C
	DO 202 K=3,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 202	
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)	
	ELSE
	FI=ACOS(SQRT(PK)/R1)
d288 1
a289 134
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 202
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
202	CONTINUE
C
	ELSE
C
C***********************NSLICE IS ODD************************************
C
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
C
	J=1
	IIJ=(J-1)
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C
	DO 3200 K=2,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)  
	IF(R.GT.0.5)GO TO 3200   
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 3200
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
3200	CONTINUE
C
	ENDIF
C
C************************************************************************
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
C
	DO 33 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 33 J=2,NROW,2
	IIJ=(J-1)/2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C	TT4=TT4+A(I,J,K)**2+A(I,J+1,K)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)    
	IF(R.GT.0.5)GO TO 33
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
 	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 33
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J+1,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J+1,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J+1,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J+1 ,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
33	CONTINUE
C
	ENDIF
	ENDIF
C
C
d294 7
@


1.4
log
@*** empty log message ***
@
text
@a18 4
        LBD=2
        ELSE
        LBD=1
        ENDIF
d20 5
a24 9
        LBR=2
        ELSE
        LBR=1
        ENDIF
	IF(IFNS)THEN
	LBS=2
	ELSE
	LBS=1
	ENDIF
d29 1
d38 1
a38 1
	DO 4 I=3,NSAM-1,2
d40 4
a43 1
432	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
d46 1
d48 1
d51 1
a51 1
	ELSE
d53 2
a54 1
	ENDIF
d56 1
d60 2
d63 1
a63 5
	IF(A(I,J,K).EQ.0.0)PHA=0.0
 	IF(III.EQ.ND2)THEN
	IF(A(2,J,K).EQ.0.0)PHA=0.0
	  PHA=ATAN2(A(2,J,K),A(NSAM,J,K))*180./PI
         ELSE
d65 4
a68 6
	ENDIF
	IF(B(I,J,K).EQ.0.0)PHB=0.0
 	IF(III.EQ.ND2)THEN
	IF(B(2,J,K).EQ.0.0)PHB=0.0
          PHB=ATAN2(B(2,J,K),B(NSAM,J,K))*180./PI
	ELSE
d70 3
a72 1
	ENDIF
a75 4
	IF(III.EQ.ND2)THEN
	QA=SQRT(A(2,J,K)**2+A(NSAM,J,K)**2)
	QB=SQRT(B(2,J,K)**2+B(NSAM,J,K)**2)
	ELSE
a77 1
	ENDIF
d83 8
a90 1
	DO 20 J=1,LBR
d93 1
a93 1
	DO 20 I=1,LBD
d95 2
a97 3
	DO 20 K=3,NSLICE-1,2
	IIK=(K-1)/2
355	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
d100 1
d102 1
d108 1
d110 1
d114 1
d116 40
a155 4
	IF(A(I,J,K).EQ.0.0) PHA=0.0
	IF(IIK.EQ.NS2)THEN
	IF(A(I,J,2).EQ.0.0) PHA=0.0
          PHA=ATAN2(A(I,J,2),A(I,J,NSLICE))*180./PI
d157 11
d169 109
d279 42
a320 4
	IF(B(I,J,K).EQ.0.0)PHB=0.0
	IF(IIK.EQ.NS2)THEN
	IF(B(I,J,2).EQ.0.0)PHB=0.0
          PHA=ATAN2(B(I,J,2),B(I,J,NSLICE))*180./PI
d322 16
d339 40
d380 12
a394 4
	IF(IIK.EQ.NS2)THEN
	QA=SQRT(A(I,J,2)**2+A(I,J,NSLICE)**2)
	QB=SQRT(B(I,J,2)**2+B(I,J,NSLICE)**2)
	ELSE
d397 31
d429 17
d449 14
a462 1
20	CONTINUE
d464 1
a464 1
	DO 3 K=1,NSLICE
d468 100
a567 1
	DO 3 I=1,LBD
d570 5
a574 2
	DO 3 J=3,NROW-1,2
765	IIJ=(J-1)/2
d576 1
d578 2
a579 2
	R1=SQRT(PII+PK)
	IF(R.GT.0.5)GO TO3
d583 1
a583 1
	FI=ACOS(SQRT(PK)/R1) 
d585 1
d587 1
d589 1
a589 1
	  IF(FI.LT.ZANG)GO TO 3
d591 1
d593 7
a599 4
	IF(A(I,J,K).EQ.0.0)PHA=0.0
	IF(IIJ.EQ.NR2)THEN
	IF(A(I,2,K).EQ.0.0)PHA=0.0
          PHA=ATAN2(A(I,2,K),A(I,NROW,K))*180./PI
d601 44
d646 2
d649 2
a650 4
	IF(B(I,J,K).EQ.0.0)PHB=0.0
	IF(IIJ.EQ.NR2)THEN
	IF(B(I,2,K).EQ.0.0)PHB=0.0
          PHB=ATAN2(B(I,2,K),B(I,NROW,K))*180./PI
d652 1
a652 1
          PHB=ATAN2(B(I,J+1,K),B(I,J,K))*180./PI
a656 4
	IF(IIJ.EQ.NR2)THEN
	QA=SQRT(A(I,2,K)**2+A(I,NROW,K)**2)
	QB=SQRT(B(I,2,K)**2+B(I,NROW,K)**2)
	ELSE
d659 195
d855 17
d875 5
a879 1
3	CONTINUE
@


1.3
log
@*** empty log message ***
@
text
@d19 4
d24 9
a32 5
C
C***********************************************************************
C******************NSAM, NROW ARE EVEN**********************************
C************************************************************************
C
a36 1
C
d45 1
a45 1
	DO 4 I=3,NSAM,2
d47 1
a47 4
C	TT2=TT2+A(I,J,K)**2+A(I+1,J,K)**2
C
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
c
a49 1
c
a50 1
C
d53 1
a53 1
	else
d55 1
a55 2
	endif
C
a56 1
C
a59 2
C
C
d61 5
a65 1
	IF(A(I,J,K).NE.0.0)THEN
d67 6
a72 4
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
d74 1
a74 3
          ELSE
          PHB=0
        ENDIF 
d78 4
d84 1
d90 1
a90 8
C
	IF(IFNS)THEN
C
C*********************NSLICE IS EVEN***********************************
	DO 20 K=3,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 20 J=1,2
d93 1
a93 1
	DO 20 I=1,2
a94 2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
C
d96 3
a100 1
c
a101 1
C
a106 1
C
a107 1
C
a110 1
C
d112 5
a116 1
	IF(A(I,J,K).NE.0.0)THEN
d118 6
a123 4
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
d125 1
a125 3
          ELSE
          PHB=0
        ENDIF 
d129 4
d135 1
a140 54
	ELSE
C
C***********************NSLICE IS ODD************************************
C
C
	DO 200 K=2,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 200 J=1,2
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 200 I=1,2
	III=(I-1)*ND2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK) 
  	IF(R.GT.0.5)GO TO 200 
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)  
	ENDIF
c
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 200
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
200	CONTINUE
C
	ENDIF
C
C************************************************************************
d145 1
a145 4
	DO 3 J=3,NROW,2
	IIJ=(J-1)/2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 3 I=1,2
a146 2
C	TT4=TT4+A(I,J,K)**2+A(I,J+1,K)**2
C
d148 3
d156 1
a156 1
	else
a158 2
C
C
a159 1
C
a162 1
C
d164 5
a168 1
	IF(A(I,J,K).NE.0.0)THEN
a169 69
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J+1,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J+1,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J+1,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

3	CONTINUE

C
	ELSE
C
C******************************************************************************
C*********************NSAM IS EVEN AND NROW IS ODD*************************
C******************************************************************************
C
	NR2=NROW/2
	ND2=NSAM/2
	NS2=NSLICE/2
C
C
	DO 74 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 74 J=1,NROW
	IIJ=(J-1)
	IF(J.GT.NR2)IIJ=IIJ-NROW
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 74 I=3,NSAM,2
	III=(I-1)/2
C	TT2=TT2+A(I,J,K)**2+A(I+1,J,K)**2
C
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK) 
	IF(R.GT.0.5)GO TO 74
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)  
	ENDIF
c
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 74
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I+1,J,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I+1,J,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
d171 4
a174 98
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

74	CONTINUE
C
	IF(IFNS)THEN
C
C*********************NSLICE IS EVEN***********************************
C
	J=1
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 720 K=3,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 720 I=1,2
	III=(I-1)*ND2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)
	IF(R.GT.0.5)GO TO 720
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
 	FI=ACOS(SQRT(PK)/R1)    
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 720
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
720	CONTINUE
C
	ELSE
C
C***********************NSLICE IS ODD************************************
C
	J=1
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 7200 K=2,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 7200 I=1,2
	III=(I-1)*ND2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)  
 	IF(R.GT.0.5)GO TO 7200	
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)  
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 7200
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
a175 47
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
7200	CONTINUE
C
	ENDIF
C
C************************************************************************
	DO 73 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 73 J=2,NROW,2
	IIJ=(J-1)/2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 73 I=1,2
	III=(I-1)*ND2
C	TT4=TT4+A(I,J,K)**2+A(I,J+1,K)**2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)
	IF(R.GT.0.5)GO TO 73
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
 	FI=ACOS(SQRT(PK)/R1)   
	ENDIF
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 73
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J+1,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
a176 164
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J+1,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J+1,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

73	CONTINUE
C
	ENDIF
	ELSE
	IF(IFNR)THEN
C******************************************************************************
C*********************NSAM IS ODD AND NROW IS EVEN*************************
C******************************************************************************
C
	NR2=NROW/2
	ND2=NSAM/2
	NS2=NSLICE/2
C
C
	DO 44 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 44 J=1,NROW
	IIJ=(J-1)
	IF(J.GT.NR2)IIJ=IIJ-NROW
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 44 I=2,NSAM,2
	III=(I-1)/2
C	TT2=TT2+A(I,J,K)**2+A(I+1,J,K)**2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)
	IF(R.GT.0.5)GO TO 44	
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)  
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 44
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I+1,J,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I+1,J,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
44	CONTINUE
C
	IF(IFNS)THEN
C
C*********************NSLICE IS EVEN***********************************
C
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	DO 209 K=3,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 209 J=1,2
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 209
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 209
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

209	CONTINUE
C
	ELSE
C
C***********************NSLICE IS ODD************************************
C
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	DO 2008 K=2,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 2008 J=1,2
	IIJ=(J-1)*NR2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 2008
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 2008
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
d181 3
a183 27
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1

2008	CONTINUE
C
	ENDIF
C
C************************************************************************
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
	DO 39 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 39 J=3,NROW,2
	IIJ=(J-1)/2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C	TT4=TT4+A(I,J,K)**2+A(I,J+1,K)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 39	
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
a184 23
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 39
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J+1,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J+1,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
a186 40
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
39	CONTINUE
C
	ELSE
C******************************************************************************
C*********************NSAM AND NROW ARE BOTH ODD*******************************
C*****************************************************************************
C
	NR2=NROW/2
	ND2=NSAM/2
	NS2=NSLICE/2
C
C
	DO 49 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 49 J=1,NROW
	IIJ=(J-1)
	IF(J.GT.NR2)IIJ=IIJ-NROW
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
	DO 49 I=2,NSAM,2
	III=(I-1)/2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
C	TT2=TT2+A(I,J,K)**2+A(I+1,J,K)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 49
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 49
a187 17
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I+1,J,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I+1,J,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I+1,J,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I+1,J,K)**2)
d191 1
a191 160

49	CONTINUE
	IF(IFNS)THEN
C
C*********************NSLICE IS EVEN***********************************
C
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
C
	J=1
	IIJ=(J-1)
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C
	DO 202 K=3,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)     
	IF(R.GT.0.5)GO TO 202	
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)	
	ELSE
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 202
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
202	CONTINUE
C
	ELSE
C
C***********************NSLICE IS ODD************************************
C
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
C
	J=1
	IIJ=(J-1)
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C
	DO 3200 K=2,NSLICE,2
	IIK=(K-1)/2
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
C	TT3=TT3+A(I,J,K)**2+A(I,J,K+1)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)  
	IF(R.GT.0.5)GO TO 3200   
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 3200
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J,K+1),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J,K+1),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J,K+1)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J,K+1)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
3200	CONTINUE
C
	ENDIF
C
C************************************************************************
	I=1
	III=(I-1)*ND2
	PII=(FLOAT(III)*0.5/FLOAT(NSAM/2+1))**2
C
	DO 33 K=1,NSLICE
	IIK=(K-1)
	IF(K.GT.NS2)IIK=IIK-NSLICE
	PK=(FLOAT(IIK)*0.5/FLOAT(NSLICE/2+1))**2
	DO 33 J=2,NROW,2
	IIJ=(J-1)/2
	PJ=(FLOAT(IIJ)*0.5/FLOAT(NROW/2+1))**2
C	TT4=TT4+A(I,J,K)**2+A(I,J+1,K)**2
	R=SQRT(PII+PJ+PK)
        R1=SQRT(PII+PK)    
	IF(R.GT.0.5)GO TO 33
	IF(SER.EQ.'C')THEN
	FI=ACOS(SQRT(PK)/R)
	ELSE
 	FI=ACOS(SQRT(PK)/R1)
	ENDIF
C
C CHECKING FOR MISSING CONE
C
	IF(SSANG.NE.0.)THEN
	  IF(FI.LT.ZANG)GO TO 33
	ENDIF
C
	L=JINT(R*Y1/WI)+1
	IF(A(I,J,K).NE.0.0)THEN
          PHA=ATAN2(A(I,J+1,K),A(I,J,K))*180./PI
          ELSE
          PHA=0
        ENDIF 
	IF(B(I,J,K).NE.0.0)THEN
          PHB=ATAN2(B(I,J+1,K),B(I,J,K))*180./PI
          ELSE
          PHB=0
        ENDIF 
                DPH=PHA-PHB
                IF (DPH.GT.180.0) DPH=360-DPH
                IF (DPH.LT.-180.0) DPH=360+DPH
	QA=SQRT(A(I,J,K)**2+A(I,J+1,K)**2)
	QB=SQRT(B(I,J,K)**2+B(I,J+1 ,K)**2)
	PR(L)=PR(L)+(QA+QB)*DPH**2
	AMP(L)=AMP(L)+QA+QB
	LR(L)=LR(L)+1
33	CONTINUE
C
	ENDIF
	ENDIF
C
@


1.2
log
@accomodates mixed radix volumes and also for missing wedges.
@
text
@@


1.1
log
@Initial revision
@
text
@d1 6
a6 1
C SUBROUTINE:PR3DB
d8 9
a16 6
C*********************************************************************
C THE SUBROUTINE OF "PR3D" WHICH CALCULATE THE 3-D PHASE RESIDUE OF RINGS
C PR(R,THETA) AND SHELLS(R) OUTSIDE MISSING CONE.  
C*******************************************************************
	SUBROUTINE PR3DB(A,B,PR,PR2,RINGN,MIN,MAX,AMP,AMP2,DIMEN3,SSANG,WI,WA,
     $                   MAXA,NSAM,NROW,NSLICE)
d18 2
a19 6
	INTEGER  DIMEN3
	DIMENSION A(DIMEN3),B(DIMEN3),PR(NSAM/2),AMP(NSAM/2),
     $	          PR2(1:NSAM/2,1:MAXA),AMP2(1:NSAM/2,1:MAXA),
     $            RINGN(1:NSAM/2,1:MAXA)
      REAL      SSANG, WI
      COMPLEX   QA,QB,GET3_P
d21 3
a23 8
      PI    =4.0*DATAN(1.0D0)
      ZANGLE=SSANG*PI/180 
      IMENDX=NSAM/2
      IMENDY=NROW/2
      IMENDZ=NSLICE/2
      ICENTX=IMENDX+1
      ICENTY=IMENDY+1
      ICENTZ=IMENDZ+1
d25 3
a27 4
C---------------INPUT DATA ARE IN THE MATRIX A AND B
C  3-D FFT
        CALL  FFTR3_P(A,NSAM,NROW,NSLICE,1)
        CALL  FFTR3_P(B,NSAM,NROW,NSLICE,1)
d29 14
a42 8
C----------------clear buffer
      DO 5 I=1,NSAM/2
      DO 6 J=1,MAXA
       AMP2(I,J)=0
       RINGN(I,J)=0
6      PR2(I,J)=0
        PR(I)=0
5       AMP(I)=0
d44 2
a45 2
      MIN=INT(WI/2)+1
      MAX=IMENDX-MIN
d47 1
a47 32
      DO 10 I=1,ICENTX
         IIX=I-1
         DO 20 J=1,NROW
            IIY=J-1
            IF(IIY.GT.IMENDY)  IIY=IIY-NROW
            IF(IIY.LT.0.AND.(IIX.EQ.0 .OR. IIX.EQ.IMENDX))  GOTO 20
            DO 30 K=1,NSLICE
               IIZ=K-1
               IF(IIZ.GT.IMENDZ)  IIZ=IIZ-NSLICE
               IF((IIX.EQ.0.OR.IIX.EQ.IMENDX).AND.(IIY.EQ.0.OR.IIY
     $           .EQ.IMENDY).AND.IIZ.LT.0)  GOTO 30
                  R=SQRT(FLOAT(IIX*IIX+IIY*IIY+IIZ*IIZ))
               IF (R.LT.0.000001) GOTO  30
                FI=ACOS(FLOAT(IABS(IIZ))/R)
               IF (FI.LT.ZANGLE)  GOTO 30
	       IF (R.GT.IMENDX) GOTO 30
                QA=GET3_P(A,NSAM,NROW,NSLICE,IIX,IIY,IIZ)
                QB=GET3_P(B,NSAM,NROW,NSLICE,IIX,IIY,IIZ)
	        IF (CABS(QA).NE.0) THEN 
                PHA=ATAN2(AIMAG(QA),REAL(QA))*180./PI
 	        ELSE
	        PHA=0
 	        ENDIF 
	        IF (CABS(QB).NE.0) THEN 
	        PHB=ATAN2(AIMAG(QB),REAL(QB))*180./PI
 	        ELSE
	        PHB=0
 	        ENDIF 
	        DPH=PHA-PHB
	        IF (DPH.GT.180) DPH=360-DPH
	        IF (DPH.LT.-180) DPH=360+DPH
C  ----so, only half(X) volume with R-<NSAM/2 outside missing cone is read
d49 51
a99 20
C  ----now,calculate phase residue of sphere shells(R) and rings(R,Z)  
C  outside missing cone. ring cross section diameter=WI,angle increment=WA
7	        LL=JMAX0(INT(R-WI/2+1),MIN)
                LH=JMIN0(INT(R+WI/2),MAX)
       	       DO 40 L=LL,LH	
                PR(L)=PR(L)+(CABS(QA)+CABS(QB))*DPH**2
                AMP(L)=AMP(L)+CABS(QA)+CABS(QB)
	         DO 41 M=1,MAXA
                   ANG=FLOAT(M-1)*WA*PI/180
	           DIST=SQRT((R*SIN(FI)-FLOAT(L)*COS(ANG))**2
     $                    +(R*COS(FI)-FLOAT(L)*SIN(ANG))**2)
                   IF (DIST.GT.WI/2) GOTO 41
                   PR2(L,M)=PR2(L,M)+(CABS(QA)+CABS(QB))*DPH**2
                   AMP2(L,M)=AMP2(L,M)+CABS(QA)+CABS(QB)
	           RINGN(L,M)=RINGN(L,M)+1
41               CONTINUE  
40	       CONTINUE    
30           CONTINUE
20        CONTINUE
10     CONTINUE
d101 787
a887 11
        DO 45 L=MIN,MAX
        DO 50 M=1,MAXA
	  IF (AMP2(L,M).EQ.0) THEN
	  PR2(L,M)=0
	  GOTO 50
	  ENDIF
          PR2(L,M)=SQRT(PR2(L,M)/AMP2(L,M))
50        CONTINUE
          PR(L)=SQRT(PR(L)/AMP(L))
45        CONTINUE
      END
@
