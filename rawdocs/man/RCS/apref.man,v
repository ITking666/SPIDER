head	1.29;
access;
symbols
	best-code:1.10
	pre-named-reg:1.9
	pre_GPL:1.9;
locks; strict;
comment	@# @;


1.29
date	2013.01.28.15.11.10;	author leith;	state Exp;
branches;
next	1.28;

1.28
date	2012.09.14.12.48.43;	author leith;	state Exp;
branches;
next	1.27;

1.27
date	2012.04.23.12.55.47;	author leith;	state Exp;
branches;
next	1.26;

1.26
date	2012.04.05.15.41.02;	author leith;	state Exp;
branches;
next	1.25;

1.25
date	2012.01.05.19.48.46;	author leith;	state Exp;
branches;
next	1.24;

1.24
date	2011.06.20.18.39.00;	author leith;	state Exp;
branches;
next	1.23;

1.23
date	2011.02.24.15.46.33;	author leith;	state Exp;
branches;
next	1.22;

1.22
date	2011.02.23.14.14.32;	author leith;	state Exp;
branches;
next	1.21;

1.21
date	2011.02.09.12.53.47;	author leith;	state Exp;
branches;
next	1.20;

1.20
date	2011.01.21.16.03.11;	author leith;	state Exp;
branches;
next	1.19;

1.19
date	2010.12.20.14.10.57;	author leith;	state Exp;
branches;
next	1.18;

1.18
date	2010.12.17.20.27.04;	author leith;	state Exp;
branches;
next	1.17;

1.17
date	2010.11.22.15.55.28;	author leith;	state Exp;
branches;
next	1.16;

1.16
date	2010.08.16.19.19.18;	author leith;	state Exp;
branches;
next	1.15;

1.15
date	2010.08.16.15.42.11;	author leith;	state Exp;
branches;
next	1.14;

1.14
date	2009.09.02.13.51.11;	author leith;	state Exp;
branches;
next	1.13;

1.13
date	2008.06.03.16.50.16;	author leith;	state Exp;
branches;
next	1.12;

1.12
date	2006.10.04.16.12.29;	author leith;	state Exp;
branches;
next	1.11;

1.11
date	2006.09.19.17.38.57;	author leith;	state Exp;
branches;
next	1.10;

1.10
date	2006.02.23.14.34.09;	author leith;	state Exp;
branches;
next	1.9;

1.9
date	2005.02.16.17.41.39;	author leith;	state Exp;
branches;
next	1.8;

1.8
date	2005.01.19.16.04.12;	author leith;	state Exp;
branches;
next	1.7;

1.7
date	2004.10.28.18.28.59;	author leith;	state Exp;
branches;
next	1.6;

1.6
date	2004.10.28.18.14.51;	author leith;	state Exp;
branches;
next	1.5;

1.5
date	2004.08.20.19.26.34;	author leith;	state Exp;
branches;
next	1.4;

1.4
date	2004.08.16.17.31.19;	author leith;	state Exp;
branches;
next	1.3;

1.3
date	2004.04.15.19.03.45;	author leith;	state Exp;
branches;
next	1.2;

1.2
date	2004.03.19.18.45.37;	author leith;	state Exp;
branches;
next	1.1;

1.1
date	2004.03.18.14.50.52;	author leith;	state Exp;
branches;
next	;


desc
@@


1.29
log
@*** empty log message ***
@
text
@AP REF    Alignment - multi-reference,  rotation & shift ||*     AP REF
                                                                 01/05/121

PURPOSE:  Compares a set of experimental images with a set of reference images.
          For each experimental image, it finds the in-plane Euler rotation which
          aligns the experimental image with the most-similar reference image. Then,
          if translation search is specified, it finds the X & Y shifts which align
          the reference image with the rotated experimental image.
	  Can restrict angular range of projections. Can restrict checking of
          a mirror image.  
          (See '<a href='"'../align_overview.html'"'>'align_overview.html'</a>' 
          for comparison of 'AP' operations.)

SEE ALSO:  VO EA  
           VO MD  
           AP I 
           AP SH 

USAGE:    AP REF
           '&'nbsp;'&'nbsp; <or>                                '<br />'    
          AP REF [spi],[theta][phi],[np],[exp],[cpsi],[x],[y],[nproj],[ang],[cc],... '<br />'
           '&'nbsp;'&'nbsp; <or>                                '<br />'    
          AP REFD [spi],[theta][phi],[np],[exp],[cpsi],[x],[y],[nproj],[ang],[cc],...
 
          .TEMPLATE FOR REFERENCE IMAGES: REF***
          [Give the template name of the existing file series of 
           reference images (typically projections).]

          .FILE NUMBERS OR SELECTION DOC. FILE NAME: Selectref
          [Enter numbers of reference files. The file numbers can also
           be read from a selection document file where file numbers 
           are contained in the first register (not the keys).]

          .TRANSLATION SEARCH RANGE (ZERO FOR NONE): 5
          [For translational alignment enter limit on translational shift. A
           response of '0' will give same alignment as obsolete 'AP MD', 'AP RD' or
           'AP RN' operations.]

          .FIRST, LAST RING, & RING SKIP: 5, 30, 1
          [Only data at radii in the range 5-30 will be analyzed. 
           If skip=0 or 1, then every radial ring between 5 and 30 will be taken;
           for skip=2, every second ring, etc.]

         .OPTIONAL REFERENCE IMAGES ANGLES DOCUMENT FILE: Refangles
          [Optional input file.  Enter name of the doc file containing 
          Eulerian angles (psi, theta, phi) for the reference images.
          Enter '*' if you do not have any reference angles doc file.

          .OPTIONAL REFERENCE-RINGS INPUT FILE: REF001
          [Give name of reference-rings file. If the file
           exists, SPIDER will read the  reference-rings data from this 
           file and will not read the actual reference image files.  If 
           this file does not exist, SPIDER will create/store  the 
           reference-rings data in incore memory. If 
           SPIDER is unable to allocate sufficient memory for the 
           reference-rings data then a reference-rings file will be created
           and used during this alignment run.  More than one 
           SPIDER run can use the same reference-rings file.             '<br>'
           Note that old responses 'W', 'Y', & 'N' are now obsolete.

          .TEMPLATE FOR IMAGE SERIES TO BE ALIGNED:  data001@@****
          [Give the template name of the existing file series of 
           experimental images.  These images will be checked for 
           alignment versus the reference images.]

          .FILE NUMBERS OR SELECTION DOC. FILE NAME:  1-2100
          [Enter numbers of experimental image files. The file numbers can also
           be read from a selection document file where file numbers are contained 
           in the first register (not the keys).]

          .OPTIONAL EXPERIMENTAL IMAGES ALIGNMENT DOCUMENT FILE:   angles001
          [Optional input file.  If '*' is given then this operation is
           similar to obsolete 'AP MD'.  If you desire to restrict the range of
           angular search for projections then this doc file is necessary.  It
           must contain the current Eulerian angles of experimental images 
           (projections): psi, theta, phi) and optionally the current 
           inplane rotation, shifts and other alignment parameters.  
           The output files from 'AP SH' and 'AP REF' contain such info.]

          .RANGE OF PROJECTION ANGLE SEARCH & ANGLE CHANGE THRESHOLD:  20.0, 5.0
          [Experimental images will be compared with only these
           reference images whose normal is within the specified degree range. 
           If a '0.0' range
           is input then there is NO restriction on which of the projections
           are compared.  The angle change threshold is an optional input which
           is used solely to record how many angular projections differ by more
           than the specified threshold from their previous orientation.]

         .CHECK MIRRORED POSITIONS?, SHIFT AND ROTATE INPUT? (Y/N): Y,N
          [Optional check of the mirrored reference image. By using this check and
           only providing reference images from one hemisphere of projection 
           directions, speed can be doubled (See Note: 1 below). '<br />'
           The second answer is an optional request 
           to rotate and shift input images according to parameters in the 
           experimental images alignment doc. file before determining alignment.
           (If this is 'Y' there is no need for 'dala' files.)   For 
           backward compatibility the legacy '0/1' response is still accepted for 
           CHECK MIRRORED POSITIONS and second response defaults to 'N'.]

      If register variables were specified on the operation line then
      no output document file is created.  Instead the registers
      receive the output that normally would be put into the
      document file. This is useful when only a single image is 
      being aligned. If you really want both register and document file output
      you can over-ride this with operation: 'AP REFD'.

         .OUTPUT ALIGNMENT DOCUMENT FILE: align_doc_01
          [Document file containing optimal alignment parameters for each 
           experimental image.  Will append to an existing output file of 
           same name. This document file contains 15 register columns:                                                     
#INCLUDE apdocout_include.also          

NOTE:   1. Reference projections of the existing structure 
           can be created using 'VO EA' and 'PJ 3Q' operations.  'VO EA'
           creates an angular document file with quasi-evenly spaced
           projection directions and 'PJ 3Q' creates projections
           of the volume according to this doc. file.

        2.  In 3D space the projection with the direction: (psi, theta, phi)
            has its mirrored (around Y-axis) counterpart in the direction: 
            (-psi, 180+theta, phi)                                  '<br />'
            To save time, the operation can take this into account if you
            speciify 'check mirrored positions'. In this case each experimental
            projection is compared with the reference projection and its
            mirrored version at the same time.  Thus, only half of the total 
            number of reference projections are required; namely, only those
            with 0 < theta < 90.                                           '<br />'
            If the best match was with the mirrored reference projection,
            then the value stored in the 15th register of the document file
            is negative and 
            the projection direction reported in the 1st register column is the 
            proper projection direction for the image.               '<br />'

        3. The operation switches automatically between in-core and on-disk
           versions depending on the memory available.  The reference rings
           file name is created/required in either case but it may not be
           created if there is adequate incore memory is available.

        4. The operation is computationally intensive and parallelized for use 
           with either OpenMP or MPI.

        5. The alignment parameters from the output doc. file can be used as 
           input to further 'AP SH' or 'AP REF' runs during a refinement.

        6. Implemented by: Paul Penczek and ArDean Leith

        7. This operation never was written to provide comprehensive
           sub-pixel resolution.  Normally only about 50% of the shifts 
           are refined to provide sub-pixel estimates.

        8. Sequence of steps in alignment used inside this operation:         '<br />'

           Load gallery of reference images created by projection of 
           the reference volume.                                              '<br />'

           Load sample image.                                                 '<br />'

           Perform a cross correlation in Fourier space on reference and 
           sample data.                                                       '<br />'
           
           Find location of highest peak from cross correlation and 
           map it to a X & Y shift for the sample image.                      '<br />'

           Shift the sample image.                                            '<br />'

           Extract radial rings from a window of the reference image, 
           converting image to a polar representation.                        '<br />'

           Take Fourier transform of the ring data and weight the data 
           corresponding to length and radius.                                '<br />'

           Extract radial rings from shifted sample image, converting 
           image to a polar representation.                                   '<br />'

           Take Fourier transform of the ring data and weight the data 
           corresponding to length and radius.                                '<br />'

           Perform a cross correlation in Fourier space on reference 
           and shifted sample data.                                           '<br />'

           Find location of highest peak from cross correlation and 
           map it to a rotation angle for the sample image. You now have 
           sample shift and rotation.                                         '<br />'

           Repeat with single pixel and some sub-pixel image shifts.               '<br />' 

           Find location of highest peak from cross correlation and 
           map it to a rotation angle for the sample image. You now have 
           sample shift and rotation.                               '<br />'

           Repeat for all sample images.                                      '<br />'

SUBROUTINE: APMASTER, APRINGS, APREF_PM, APREF_P,  AP_END, 
            APSHIFT, CROSRNG_2, NORMAS, ALRQS, FRNGS, PRB1D, 
            FMRS, CCRS, PKSR3, APCC

CALLER:     UTIL4

@


1.28
log
@y axis
@
text
@d25 1
a25 1
          .ENTER TEMPLATE FOR REFERENCE IMAGES: REF***
d29 1
a29 1
          .ENTER FILE NUMBERS OR SELECTION DOC. FILE NAME: Selectref
d44 1
a44 1
         .REFERENCE IMAGES ANGLES DOCUMENT FILE: Refangles
d49 1
a49 1
          .REFERENCE-RINGS FILE: REF001
d61 1
a61 1
          .ENTER TEMPLATE FOR IMAGE SERIES TO BE ALIGNED:  data001@@****
d66 1
a66 1
          .ENTER FILE NUMBERS OR SELECTION DOC. FILE NAME:  1-2100
d71 1
a71 1
          .EXPERIMENTAL IMAGES ALIGNMENT DOCUMENT FILE:   angles001
d107 5
a111 78
          .OUTPUT ALIGNMENT DOCUMENT FILE: align002
          [This is the only output produced by this operation.
           (Will append to existing output file of same name).
           It contains 15 register columns:                            '<br />'

            1. Eulerian angle (psi) of nearest reference image.        '<br />'
               When no matching projection was found within
               the angular range specified, this column will 
               contain the experimental
               image's previous Eulerian angle (if any) or 0.0.        '<br />'

            2. Eulerian angle (theta) of nearest reference image.      '<br />'
               When no matching projection was found within
               the angular range specified, this column will contain 
               the experimental
               image's previous Eulerian angle (if any) or 0.0.        '<br />'

            3. Eulerian angle (phi) of nearest reference image.        '<br />'
               When no matching projection was found within
               the angular range specified, this column will contain 
               the experimental 
               image's previous Eulerian angle (if any) or 0.0.        '<br />'
                                      
            4. Number of the most similar reference projection.        '<br />'
               When no matching projection was found within
               the angular range specified, this column will contain 
               a 0.0                                                   '<br />'

            5. Experimental projection number.                         '<br />'
 
            6. Cumulative In-plane rotation angle (psi).               '<br />'
               This is the sum of any rotation from the experimental 
               images align. document file and the current rotation.   
               To use in 3D reconstruction programs invert the sign.   '<br />'                           '<br>'

            7. Cumulative X shift                                      '<br />'
               Cumulative X translation of image.  This is the sum 
               of any shift from the experimental images alignment 
               doc. file and any current shift.                        '<br />'

            8. Cumulative Y shift                                      '<br />'
               Cumulative Y translation of image.  This is the 
               sum of any shift from the experimental images  
               alignment doc. file and any current shift.              '<br />'

            9. Number of projections searched.                         '<br />'
               The number of projections searched can vary when 
               there is a restriction on angular search.               '<br />'

           10. Angular change for projection.                          '<br />'
               Angular difference between previous and current 
               projection. This will be -1.0 if the previous 
               projection angles were not specified.                   '<br />'

           11. Not-normalized correlation coefficient from 
               rotational search. Can be used as a similarity measure. '<br />'                    '<br />'

       '<p>' Following values are seldom used by existing procedures:  '</p>'

           12. Current In-plane rotation angle (psi).                  '<br />'        
               This is the rotation necessary to align the experimental 
               image with the current reference projection.            '<br />'

           13. Current X shift                                         '<br />'
               This is the X shift necessary to align the experimental 
               image with the current reference projection.            '<br />'

           14. Current Y shift                                         '<br />'
               This is the Y shift necessary to align the experimental 
               image with the current reference projection.            '<br />'

           15. Shift normalized CC Peak Height & Current Mirroring.    '<br />'
               This is the normalized cross correlation peak height 
               from the totated  and shifted image.  This value can 
               be used as a 
               similarity measure. If mirroring was necessary to 
               align the experimental image with the reference 
               projection this value is given a negative sign.         '<br />'
d122 2
a123 1
            To save time, the program takes this into account, and each data
d127 1
a127 1
            with 0<theta<90.                                           '<br />'
d129 1
a129 1
            then the number stored in the 15th register of the document file
d131 2
a132 2
            the projection direction reported in the 1st register column  is the 
            proper projection direction  for the mirrored image.       '<br />'
a145 1

@


1.27
log
@sub-pixel
@
text
@d192 15
a206 1
        2. The operation switches automatically between in-core and on-disk
d211 1
a211 1
        3. The operation is computationally intensive and parallelized for use 
d214 1
a214 1
        4. The alignment parameters from the output doc. file can be used as 
d217 1
a217 1
        5. Implemented by: Paul Penczek and ArDean Leith
d220 1
a220 1
        6. This operation never was written to provide comprehensive
d224 1
a224 1
        7. Sequence of steps in alignment used inside this operation:         '<br />'
@


1.26
log
@spell
@
text
@d205 6
a210 1
        6. Sequence of steps in alignment used inside this operation:         '<br />'
d244 1
a244 1
           Repeat with single pixel and sub-pixel image shifts.               '<br />' 
d248 1
a248 1
           sub-pixel sample shift and rotation.                               '<br />'
@


1.25
log
@rotfirst
@
text
@d7 1
a7 1
          if translation search is specifed, it finds the X & Y shifts which align
@


1.24
log
@*** empty log message ***
@
text
@d2 1
a2 1
                                                                 02/13/11
d92 2
a93 1
           directions, speed can be doubled (See Note: 1 below). Optional request 
d97 1
a97 1
           backward compatibility older '0/1' response is still accepted for 
d145 1
a145 1
               doc. file and any current shift.                   '<br />'
d150 1
a150 1
               alignment doc. file and any current shift.            '<br />'
d162 1
a162 2
               rotational search.                                      '<br />'                 
               Can be used as a similarity measure.                    '<br />'
@


1.23
log
@*** empty log message ***
@
text
@d247 3
a249 3
SUBROUTINE: APMASTER, APRINGS, AP_REF_PM, AP_REF_P,  AP_END, 
            NORMAS, ALRQS, ALPRBS, CROSRNG_3, FRNGS, PRB1D, 
            FFTR_D, FFTC_D, APPLYW
@


1.22
log
@*** empty log message ***
@
text
@d74 1
a74 1
           angular search for projections then this file is necessary.  It
d92 1
a92 1
           directions, speed can be doubled.  See note: 2 below. Optional call
d95 1
a95 1
           If this is 'Y' there is no need for 'dala' files.   (For 
d97 1
a97 1
           CHECK MIRRORED POSITIONS and second response defaults to 'N'.)]
@


1.21
log
@ SHIFT AND ROTATE INPUT
@
text
@d2 1
a2 1
                                                                 08/16/10
d45 3
a47 2
          [Enter the name of the angular document file (input file) containing the
           reference image's (projections) Eulerian angles: psi, theta, phi.]
d97 1
a97 1
           CHECK MIRRORED POSITIONS and second response defaults to 'N'.]
@


1.20
log
@ap_ref_p.f
@
text
@d88 9
a96 2
         .CHECK MIRRORED POSITIONS (0=NOCHECK / 1=CHECK)?: 1
         [Can mimic action of obsolete 'AP RD' operation.]
d98 6
a103 6
       If register variables were specified on the operation line then
       no output document file is created.  Instead the registers
       receive the output that normally would be put into the
       document file. This is useful when only a single image is 
       being aligned. If you really want both register and document file output
       you can over-ride this with 'AP REFD'.
@


1.19
log
@*** empty log message ***
@
text
@d239 1
a239 1
SUBROUTINE: APMASTER, APRINGS, DSGR_PM, DSGR_P,  AP_END, 
@


1.18
log
@subroutines called
@
text
@d42 1
a42 1
           for skip=2, every second ring; etc.]
d70 1
a70 1
          .EXPERIMENTAL IMAGES ALIGN. DOCUMENT FILE:   angles001
d129 2
a130 2
               This is the sum of any rotation from the 'experimental 
               images align. document file' and the current rotation.   
d135 2
a136 2
               of any shift from the 'experimental images align. 
               document file' and any current shift.                   '<br />'
d140 2
a141 2
               sum of any shift from the 'experimental images  
               align. document file' and any current shift.            '<br />'
d172 2
a173 1
               from the shifted image.  This value can be used as a 
d182 1
a182 1
           of the volume according to this doc file.
@


1.17
log
@*** empty log message ***
@
text
@d238 2
a239 2
SUBROUTINE: APMASTER, APRINGS, DSGR_PM, DSGR_P, DSFS_P, AP_END, 
            NORMAS, ALRQS, ALPRBS, CROSRNG_MS, CROSRNG_E, FRNGS, PRB1D, 
@


1.16
log
@REFD
@
text
@d21 1
a21 1
          AP REF [spi],[theta][phi],[np],[exp],[cpsi],[x],[y],[nproj],[ang],[cc],...
@


1.15
log
@*** empty log message ***
@
text
@d2 1
a2 1
                                                                 09/03/09
d22 2
d95 2
a96 1
       being aligned.
@


1.14
log
@*** empty log message ***
@
text
@d185 1
a185 1
        3. The operation is computationally intensive and arallelized for use 
@


1.13
log
@method added
@
text
@d2 1
a2 1
                                                                 05/21/08
d10 1
a10 1
          mirror image.  
d20 2
a21 2
           <or>                          '<br>'    
          AP REF X10,X11,X12,X13,X14,X15,X16
d27 1
a27 1
          .ENTER FILE NUMBERS OR SELECTION DOC. FILE NAME: SELECTREF
d29 2
a30 2
           be read from a selection document file where file numbers are contained in the
           first register (not the keys).]
d34 1
a34 1
           response of '0' will give same alignment as older 'AP MD', 'AP RD' or
d38 3
a40 3
          [Only rings with radii in the range 5-30 will be analyzed. 
          If skip=0 or 1, then every ring between 5 and 30 will be taken;
          for skip=2, every second ring; etc.]
d42 1
a42 1
         .REFERENCE IMAGES ANGLES DOCUMENT FILE: REFANGLES
d44 1
a44 1
           reference images (projections) Eulerian angles: psi, theta, phi.]
d49 1
a49 1
           file and will not read the reference image file series.  If 
d58 1
a58 1
          .ENTER TEMPLATE FOR IMAGE SERIES TO BE ALIGNED: data001@@****
d60 2
a61 2
          experimental images.  These images will be checked for 
          alignment versus the reference images.]
d63 1
a63 1
          .ENTER FILE NUMBERS OR SELECTION DOC. FILE NAME: 1-2100
d70 1
a70 1
           similar to old 'AP MD'.  If you desire to restrict the range of
d73 1
a73 1
           (projections: psi, theta, phi) and optionally the current 
d77 1
a77 1
          .RANGE OF PROJECTION ANGLE SEARCH & ANGLE CHANGE THRESHOLD: 20.0, 5.0
d87 1
a87 1
         [Can mimic action of older 'AP RD' operation.]
d89 1
a89 1
       If registers were specified on the operation line then
d97 2
a98 2
           (Appends to existing output file of same name).
           It contains 15 register columns:                 '<br>'
d100 1
a100 1
            1. Eulerian angle (psi) of nearest reference image. '<br>'
d102 3
a104 2
               the angular range specified, this column will contain the experimental
               image's previous Eulerian angle (if any) or 0.0.        '<br>'
d106 1
a106 1
            2. Eulerian angle (theta) of nearest reference image. '<br>'
d108 3
a110 2
               the angular range specified, this column will contain the experimental
               image's previous Eulerian angle (if any) or 0.0.        '<br>'
d112 1
a112 1
            3. Eulerian angle (phi) of nearest reference image. '<br>'
d114 3
a116 2
               the angular range specified, this column will contain the experimental
               image's previous Eulerian angle (if any) or 0.0.        '<br>'
d118 1
a118 1
            4. Number of the most similar reference projection.'<br>'
d120 2
a121 1
               the angular range specified, this column will contain a 0.0 '<br>'
d123 3
a125 3
            5. Experimental projection number.                        '<br>'

            6. Cumulative In-plane rotation angle (psi).              '<br>'                                  '<br>'
d127 2
a128 2
               images align. document file' and the current rotation.  
               To use in 3D reconstruction programs invert the sign.  '<br>'                           '<br>'
d130 22
a151 18
            7. Cumulative X shift                                    '<br>'
               Cumulative X translation of image.  This is the sum of any
               shift from the 'experimental images align. document file'
               and any current shift.                                '<br>'

            8. Cumulative Y shift                                    '<br>'
               Cumulative Y translation of image.  This is the sum of any
               shift from the 'experimental images align. document file'
               and any current shift.                                '<br>'

            9. Number of projections searched.                       '<br>'
               The number of projections searched can vary when there is a restriction
               on angular search.                                     '<br>'

           10. Angular change for projection.                        '<br>'
               Angular difference between previous and current projection.
               This will be -1.0 if the previous projection angles were
               not specified. '<br>'
d153 1
a153 2
           11. Not-normalized correlation coefficient from rotational search.'<br>'                 '<br>'
               Can be used as a similarity measure.                    '<br>'
d155 1
a155 3
       '<p>' Following values are seldom used by existing proceedures: '</p>'

           12. Current In-plane rotation angle (psi).                 '<br>'        
d157 1
a157 1
               image with the current reference projection.          '<br>'
d159 1
a159 1
           13. Current X shift                                    '<br>'
d161 1
a161 1
               image with the current reference projection.          '<br>'
d163 1
a163 1
           14. Current Y shift                                       '<br>'
d165 1
a165 1
               image with the current reference projection.          '<br>'
d167 6
a172 6
           15. Shift normalized CC Peak Height & Current Mirroring.   '<br>'
               This is the normalized cross correlation peak height from the
               shifted image.  This value can be used as a similarity measure. 
               If mirroring was necessary to align the 
               experimental image with the reference projection this value
               is given a negative sign.     '<br>'
d181 1
a181 1
           versions depending on the memory available.  The Reference rings
d183 1
a183 1
           created if there is adequate memory available.
d185 2
a186 1
        3. The operation is computationally intensive. The code is parallel.
d191 1
a191 3
        5. This operation parallelized for use with MPI.

        6. Implemented by: Paul Penczek and ArDean Leith
d193 1
a193 1
        7. Sequence of steps in alignment using this operation:'<br>'
d195 2
a196 1
           Load gallery of reference images created by projection of the reference volume.'<br>'
d198 1
a198 1
           Load sample image.'<br>'
d200 2
a201 1
           Perform a cross correlation in Fourier space on reference and sample data.'<br>'
d204 1
a204 1
           map it to a X & Y shift for the sample image.'<br>'
d206 1
a206 1
           Shift the sample image.
d208 2
a209 2
           Extract radial rings from a window of the reference image, converting image to
           a polar representation.'<br>'
d211 2
a212 2
           Take Fourier transform of the ring data and weight the data corresponding 
           to length and radius.'<br>'
d214 2
a215 2
           Extract radial rings from shifted sample image, converting image to
           a polar representation.'<br>'
d217 2
a218 2
           Take Fourier transform of the ring data and weight the data corresponding 
           to length and radius.'<br>'
d220 2
a221 2
           Perform a cross correlation in Fourier space on reference and shifted 
           sample data.'<br>'
d224 2
a225 2
           map it to a rotation angle for the sample image. You now have sample shift
           and rotation.'<br>'
d227 1
a227 1
           Repeat with single pixel and sub-pixel image shifts. '<br>' 
d230 2
a231 2
           map it to a rotation angle for the sample image. You now have sample shift
           and rotation.'<br>'
d233 1
a233 1
           Repeat for all sample images.'<br>'
@


1.12
log
@*** empty log message ***
@
text
@d1 2
a2 2
AP REF    Alignment - multi-reference,  rotation & shift ||*   AP REF
                                                                 02/21/06
d187 41
a227 1
        6. Implemented by: Paul Penczek
d230 1
a230 1
            NORMAS, ALRQS, ALPRBS, CROSRNG_MS, FRNGS, PRB1D, 
@


1.11
log
@MPI
@
text
@d1 1
a1 1
AP REF    Alignment - multi-reference,  rotation & shift ||MPI   AP REF
d20 1
a20 1
           <or>   '<br>'    
@


1.10
log
@notes
@
text
@d1 2
a2 2
AP REF    Alignment - multi-reference,  rotation & shift ||   AP REF
                                                              02/21/06
d185 3
a187 1
        5. Implemented by: Paul Penczek
@


1.9
log
@angular threshold input
@
text
@d2 1
a2 1
                                                              02/19/05
d32 1
a32 1
          .TRANSLATION SEARCH RANGE (ZERO FOR NONE): 0
d37 1
a37 1
          .FIRST, LAST RING, & RING SKIP: 5 30 1
d74 2
a75 2
          'inplane rotation, shifts and other alignment parameters).  
           The output files from 'AP SH' and 'AP REF' contain this info.]
d77 1
a77 1
          .RANGE OF PROJECTION ANGLE SEARCH & & ANGLE CHANGE THRESHOLD: 20.0  5.0
d79 2
a80 1
           reference images whose normal is within 20 degrees range. If a '0.0' range
d84 1
a84 1
           than the threhold from their previous orientation.]
d96 1
a96 1
          [This is the only output produced by this program.
d117 1
a117 1
               the angular range specified, this column will contain 0. '<br>'
d122 3
a124 3
               To use in 3D reconstruction programs invert the sign. This is the
               sum of any rotation from the 'experimental images align. document file'
               and the current rotation.                             '<br>'
d137 2
a138 2
               Number of projections searched can vary when an angular restriction
               on search is used.                                     '<br>'
d145 1
a145 1
           11. Not-normalized correlation coefficient.                 '<br>'
d156 1
a156 1
               image with the current referenceprojection.          '<br>'
d162 2
a163 2
           15. Shift CC Peak Height & Current Mirroring              '<br>'
               This is the cross correlation peak height from the
d167 1
a167 1
               is negative. Can be used as a similarity measure.     '<br>'
d169 1
a169 1
NOTE:   1. The reference projections (of the existing structure)
d177 2
a178 1
           file name is created/required in either case.
d182 2
a183 2
        4. Alignment parameters can be used as input to further 'AP SH'
           or 'AP REF' runs during refinement.
@


1.8
log
@ref rings file usage changed
@
text
@d2 1
a2 1
                                                              01/19/05
d77 1
a77 1
          .RANGE OF PROJECTION ANGLE SEARCH: 20.0
d79 1
a79 1
           reference images whose normal is within 20 degrees range. If a '0.0'
d81 3
a83 1
           are compared]
d141 1
a141 1
               This will be -1.0 if the previous projection angles was
@


1.7
log
@cols
@
text
@d2 1
a2 1
                                                              10/28/04
d6 2
a7 2
          aligns the experimental image with the most-similar reference image. Then
          if trnslation seach is specifed, it finds the x & y shift which aligns
d9 1
a9 1
	  Can restricted angular range of projections. Can restrict checking of
d34 1
a34 1
           response of 0 will give same alignment as older 'AP MD', 'AP RD' or
d43 2
a44 2
          [Enter the name of the angular document file containing Eulerian
           angles of reference images (projections): psi, theta, phi.]
d53 2
a54 3
           reference-rings data then the reference-rings file must
           exist. In that case, use operation 'AP I' to create 
           the reference-rings file. More than one 
d79 1
a79 1
           reference images whose normal is within 20 degrees range. If a 0.0
d84 1
a84 1
         Can mimic action of older 'AP RD' operation.]
d114 1
a114 3
               the angular range specified, this column will contain 0.'<br>'
               When this number is negative, the most similar image is the 
               mirrored projection (see note 1). 
d116 1
a116 1
            5. Experimental projection number.                 '<br>'
d133 1
a133 1
            9. Number of projections searched.                     '<br>'
d135 1
a135 1
               on search is used. '<br>'
d159 1
a159 1
           15. Shift CC Peak & Current Mirroring                                       '<br>'
d161 4
a164 3
               shifted image.  If mirroring was necessary to align the 
                experimental image with the reference projection this value
                is negated. Can be used as a similarity measure.     '<br>'
@


1.6
log
@update
@
text
@d6 3
a8 1
          aligns the experimental image with the most-similar reference image.
d10 1
a10 1
          mirror image. Can determine shift alignment also. 
d166 1
a166 1
                is negated.                                         '<br>'
@


1.5
log
@dsgr_p added
@
text
@d2 1
a2 1
                                                               4/15/04
d96 1
a96 1
            1. Eulerian angle (psi) of nearest reference image angle. '<br>'
d101 1
a101 1
            2. Eulerian angle (theta) of nearest reference image angle. '<br>'
d106 1
a106 1
            3. Eulerian angle (phi) of nearest reference image angle. '<br>'
d119 1
a119 1
            6. Cumulative In-plane rotation angle (-psi).              '<br>'                                  '<br>'
d140 2
a141 2
               This will be -1.0 if there were no previous projection 
               angles used. '<br>'
d148 1
a148 2
           12. Current In-plane rotation angle (-psi).              '<br>'        
               To use in 3D reconstruction programs invert the sign. 
d150 1
a150 1
               image with the current projection.          '<br>'
d154 1
a154 1
               image with the current projection.          '<br>'
d158 1
a158 1
               image with the current projection.          '<br>'
d160 5
a164 3
           15. Current Mirroring                                       '<br>'
               This is the mirroring necessary to align the experimental 
               image with the current projection. 0 is non-mirrored        '<br>'
d173 2
a174 2
           versions depending on the memory available.  The scratch.file
           is created/required in either case.
d176 1
a176 2
        3. The operation is computationally intensive. The code is
           parallel.
d183 3
a185 3
SUBROUTINE: APMASTER, APRINGS, DSGR_PM,
            DSGR_P, AP_END, DSFS_P, NORMAS, ALRQS, ALPRBS, 
            CROSRNG_MS, FRNGS, PRB1D, FFTR_D, FFTC_D, APPLYW
@


1.4
log
@cosmetic
@
text
@d183 2
a184 1
SUBROUTINE: APMASTER, APRINGS, DSGR_PM, AP_END, DSFS_P, NORMAS, ALRQS, ALPRBS, 
@


1.3
log
@*** empty log message ***
@
text
@d96 1
a96 1
            1. Eulerian angle (PSI) of nearest reference image angle. '<br>'
d106 1
a106 1
            3. Eulerian angle (PHI) of nearest reference image angle. '<br>'
@


1.2
log
@*** empty log message ***
@
text
@d2 1
a2 1
                                                               3/17/04
d93 1
d96 1
a96 1
            1. Eulerian angle (psi) of nearest reference image angle. '<br>'
d106 1
a106 1
            3. Eulerian angle (phi) of nearest reference image angle. '<br>'
d114 2
d117 1
a117 2
            5. Not-normalized correlation coefficient.                 '<br>'
               Can be used as a similarity measure.                    '<br>'
a129 1
               Y translation determined. 
d134 3
a136 4
            9. Cumulative Mirroring                                   '<br>'
               Cumulative mirroring of image.  This is the sum of any
               mirroring from the 'experimental images align. document file'
               and current mirroring.                                '<br>'
d139 8
a146 1
               Angular difference between previous and current projection. '<br>'
d148 1
a148 1
           11. Current In-plane rotation angle (-psi).              '<br>'                                  '<br>'
d153 1
a153 1
           12. Current X shift                                    '<br>'
d157 1
a157 1
           13. Current Y shift                                       '<br>'
d161 1
a161 1
           14. Current Mirroring                                       '<br>'
@


1.1
log
@Initial revision
@
text
@d171 2
a172 3
        4. An example of the SPIDER batch program which can be used to produce
           an angular document file from the output document file of this
           operation is included in the manual chapter for the operation 'VO MD'.
@
