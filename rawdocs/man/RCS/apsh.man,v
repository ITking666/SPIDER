head	1.42;
access;
symbols
	best-code:1.12
	pre-named-reg:1.12
	pre_GPL:1.12;
locks; strict;
comment	@# @;


1.42
date	2013.05.10.16.24.57;	author leith;	state Exp;
branches;
next	1.41;

1.41
date	2013.01.28.15.11.36;	author leith;	state Exp;
branches;
next	1.40;

1.40
date	2013.01.11.14.17.20;	author leith;	state Exp;
branches;
next	1.39;

1.39
date	2012.09.14.12.48.20;	author leith;	state Exp;
branches;
next	1.38;

1.38
date	2012.04.23.12.58.23;	author leith;	state Exp;
branches;
next	1.37;

1.37
date	2012.03.07.19.50.11;	author leith;	state Exp;
branches;
next	1.36;

1.36
date	2012.01.06.14.41.15;	author leith;	state Exp;
branches;
next	1.35;

1.35
date	2012.01.05.19.50.59;	author leith;	state Exp;
branches;
next	1.34;

1.34
date	2011.05.09.16.22.57;	author leith;	state Exp;
branches;
next	1.33;

1.33
date	2011.02.23.14.14.31;	author leith;	state Exp;
branches;
next	1.32;

1.32
date	2011.01.21.16.15.48;	author leith;	state Exp;
branches;
next	1.31;

1.31
date	2010.11.29.17.00.45;	author leith;	state Exp;
branches;
next	1.30;

1.30
date	2010.07.19.14.45.49;	author leith;	state Exp;
branches;
next	1.29;

1.29
date	2010.03.02.15.48.20;	author leith;	state Exp;
branches;
next	1.28;

1.28
date	2010.02.26.17.25.07;	author leith;	state Exp;
branches;
next	1.27;

1.27
date	2009.11.24.15.02.44;	author leith;	state Exp;
branches;
next	1.26;

1.26
date	2009.09.09.17.04.43;	author leith;	state Exp;
branches;
next	1.25;

1.25
date	2009.09.02.13.16.44;	author leith;	state Exp;
branches;
next	1.24;

1.24
date	2009.08.28.15.38.30;	author leith;	state Exp;
branches;
next	1.23;

1.23
date	2009.08.26.14.14.53;	author leith;	state Exp;
branches;
next	1.22;

1.22
date	2009.03.10.14.43.47;	author leith;	state Exp;
branches;
next	1.21;

1.21
date	2009.03.10.11.25.13;	author leith;	state Exp;
branches;
next	1.20;

1.20
date	2008.11.04.16.26.22;	author leith;	state Exp;
branches;
next	1.19;

1.19
date	2008.06.23.12.08.45;	author leith;	state Exp;
branches;
next	1.18;

1.18
date	2008.06.23.12.01.26;	author leith;	state Exp;
branches;
next	1.17;

1.17
date	2008.06.18.14.37.39;	author leith;	state Exp;
branches;
next	1.16;

1.16
date	2008.06.03.16.50.24;	author leith;	state Exp;
branches;
next	1.15;

1.15
date	2006.10.04.16.12.31;	author leith;	state Exp;
branches;
next	1.14;

1.14
date	2006.09.19.17.38.51;	author leith;	state Exp;
branches;
next	1.13;

1.13
date	2006.09.08.18.28.36;	author leith;	state Exp;
branches;
next	1.12;

1.12
date	2005.06.23.18.28.25;	author leith;	state Exp;
branches;
next	1.11;

1.11
date	2005.03.17.20.25.56;	author leith;	state Exp;
branches;
next	1.10;

1.10
date	2005.02.22.17.23.28;	author leith;	state Exp;
branches;
next	1.9;

1.9
date	2005.01.27.16.09.27;	author leith;	state Exp;
branches;
next	1.8;

1.8
date	2005.01.19.16.11.16;	author leith;	state Exp;
branches;
next	1.7;

1.7
date	2004.10.28.18.29.11;	author leith;	state Exp;
branches;
next	1.6;

1.6
date	2004.08.18.19.25.29;	author leith;	state Exp;
branches;
next	1.5;

1.5
date	2004.08.16.17.31.07;	author leith;	state Exp;
branches;
next	1.4;

1.4
date	2004.07.23.12.39.01;	author leith;	state Exp;
branches;
next	1.3;

1.3
date	2004.04.15.19.03.44;	author leith;	state Exp;
branches;
next	1.2;

1.2
date	2004.03.19.18.45.39;	author leith;	state Exp;
branches;
next	1.1;

1.1
date	2004.03.18.14.50.51;	author leith;	state Exp;
branches;
next	;


desc
@@


1.42
log
@*** empty log message ***
@
text
@
AP SH     Alignment - multi-reference, exhaustive rotation & shift ||*   AP SH
                                                             01/05/12

PURPOSE:  Determines optimal shifts and rotations to align a series of 
          experimental images with a series of reference images.  
          For each experimental image, it finds the in-plane Euler
          rotation angle, and X, Y translational shifts which align the image 
          with the most-similar reference image.  
          Exhaustively checks all requested rotations and shifts. 
          Can restrict angular range of projections and inplane rotation range. 
          Can restrict checking of mirror image. '<br />'

          (See '<a href='"'../align_overview.html'"'>'align_overview.html'</a>' 
           for comparison of 'AP' operations.)

SEE ALSO:  AP SHC
           VO EA  
           VO MD  
           AP REF
           OR SH
           PJ 3Q
           RT SF

USAGE:    AP SH

         .TEMPLATE FOR REFERENCE IMAGES: REF***
          [Give the template for the name of the existing file series of 2D 
           reference images (typically projections).]

         .FILE NUMBERS OR SELECTION DOC. FILE NAME: SELECTREF
          [Enter numbers of reference files. The file numbers can also
           be read from a selection document file where file numbers 
           are contained in the first register (not the keys).]

	 .TRANSLATION SEARCH RANGE IN X, IN Y (OPTIONAL), STEP SIZE': 6,2 
         [The search for translation parameters will be restricted to
           +/- search range, performed every "step size" pixel. '<br />'
           Restrictions:                                        '<br />'
           1. Search range + last ring <= NX/2-2               '<br />' 
           2. Search range has to be divisible by step size.]   '<br />'
           Speed will depend on square of the number of positions searched.   
          Use of 'step size' greater than one can speed up
          alignment determination with little effect on
          final reconstruction resolution.  The input for Y shift is
          optional, if only two inputs are present the second one is
          interpreted as the step size. ]

         .FIRST, LAST RING, RING STEP, & RAY STEP: 5,15,1,1
          [The search for rotational alignment will be restricted to
          pixels  with radii in the specified range (here: 5-15), performed 
          every 'ring step' radius and on every 'ray step' radial ray.  '<br />'
          Restrictions on 'ray' search, every: 1,2,4,8,16 'th radial
          ray can be included in search.                                '<br />'
          Use of 'ring step' and 'ray step' greater than one can speed up
          alignment determination on large images with minimal effect on
          final reconstruction resolution.]
               
         .OPTIONAL REFERENCE IMAGES ANGLES DOCUMENT FILE: Refangles
          [Optional input file.  Enter name of the doc file containing 
          Eulerian angles (psi, theta, phi) for the reference images.
          Enter '*' if you do not have any reference angles doc file.
 
         .TEMPLATE FOR IMAGE SERIES TO BE ALIGNED: DAT***
          [Give the template name of the existing file series of 
          experimental images.  These images will be checked for 
          alignment versus the reference images.]

         .FILE NUMBERS OR SELECTION DOC. FILE NAME: 1-2100
          [Enter numbers of experimental files. The file numbers can also
           be read from a selection document file where file numbers are 
           contained in the first register (not the keys).]

         .OPTIONAL EXPERIMENTAL IMAGES ALIGNMENT DOCUMENT FILE:   angles001
          [Optional input file.  If '*' is given then this operation is
           similar to old 'AP MQ'.  If you desire to restrict the range of
           angular search for projections then this file is necessary.  It
           must contain the current Eulerian angles of experimental images 
           (projections: psi, theta, phi) and optionally the current 
           inplane rotation, shifts and other alignment parameters.  
           The output files from 'AP SH' and 'AP REF' contain this info.]

         .RANGE OF PROJECTION ANGLE SEARCH & ANGLE CHANGE THRESHOLD: 20.0, 14.0
          [Experimental images will be compared with only those 
           reference images whose normal is within specified range (in degrees). 
           If a 0.0
           is entered, then there is NO restriction on which of the projections
           are compared. The "angle change threshold" is only used to report what
           percentage of the rotational changes exceed this specified threshold.  This
           value can later be used to halt the iterations.  The value is placed in
           a comment key at the end of the operations output file.  It is
           not used for any other purpose.]

         .CHECK MIRRORED POSITIONS?, SHIFT/ROTATE INPUT? (Y/N): Y, Y
          [Optional check of the mirrored reference image. By using this check and
           only providing reference images from one hemisphere of projection 
           directions, speed can be doubled.  See note: 1 below. '<br />' 
           The second prompt 
           requests that the input files first be rotated/shifted by the alignment 
           parameters from the experimental images alignment document file before
           use.  This is equivalent to running the 'RT SQ' operation before using
           'AP SH'. If this is 'Y' there is no need for 'dala' files.   (For 
           backward compatibility the legacy '0/1' response is still accepted for 
           CHECK MIRRORED POSITIONS and second response defaults to 'N'.)]

         .OUTPUT ALIGNMENT DOCUMENT FILE: align_doc_01
          [Document file containing optimal alignment parameters for each 
           experimental image.  Will append to an existing output file of 
           same name. This document file contains 15 register columns:                                                     
#INCLUDE apdocout_include.also          


NOTES:  1. In 3D space the projection with the direction: (psi, theta, phi)
            has its mirrored (around Y-axis) counterpart in the direction: 
            (-psi, 180+theta, phi)                                  '<br />'
            To save time, the operation can take this into account if you
            speciify 'check mirrored positions'. In this case each experimental
            projection is compared with the reference projection and its
            mirrored version at the same time.  Thus, only half of the total 
            number of reference projections are required; namely, only those
            with 0 < theta < 90.                                           '<br />'
            If the best match was with the mirrored reference projection,
            then the value stored in the 15th register of the document file
            is negative and 
            the projection direction reported in the 1st register column is the 
            proper projection direction for the image.               '<br />'

        2. The reference projections of an existing structure 
           can be created using 'VO EA' and 'PJ 3Q' operations.  'VO EA'
           creates an angular document file with quasi-evenly spaced
           projection directions and 'PJ 3Q' creates projections
           of the volume according to this doc file.

        3. Alignment parameters (angle and translation included in
           columns 6-8 of the output document file) can be used with
           operation 'RT SQ' to align images.

        4. Alignment parameters can be used as input to further 'AP SH'
           or 'AP REF' operations during refinement.

        5. This operation parallelized for use with MPI.

        6. Setting a angular search limit of 180 degrees with checking of mirrored
           positions does not give same results as an unlimited search, since the
           limited search only looks at the nearer projection. This is not a bug.

        7. This operation never was written to provide comprehensive
           sub-pixel resolution.  Normally only about 50% of the shifts 
           are refined to provide sub-pixel estimates.

        8. Sequence of steps in the alignment carried out by this operation:   '<br />'

           Load gallery of reference images created by projection of 
           the reference volume.                                     '<br />'

           Extract radial rings from a window of each reference image, 
           converting image to
           a polar representation.                                   '<br />'

           Take fourier transform of the ring data and weight the 
           data corresponding to length and radius.                  '<br />'

           Load a sample image.                                      '<br />'

           Extract radial rings from a window of sample image, 
           coverting image to a polar representation.                '<br />'

           Take Fourier transform of the ring data and weight the 
           data corresponding to length and radius.                  '<br />'

           Perform a cross correlation in Fourier space of the 
           reference and sample data.                                '<br />'

           Find location of highest peak from cross correlation and 
           map it to a rotation angle for the sample image.          '<br />'

           Repeat for all requested X & Y shifts of the sample image. 
           You now have sample shift and rotation.                   '<br />'

           Repeat for next sample image.                              '<br />'

SUBROUTINE: APMASTER, APSH_PS, APSH_SS, APRINGS, NORMASC, NORMAS, 
            CROSRNG_MS, FRNGS, AP_END, AP_STAT,    
            RINGWE, APPLYWS, PARABLD, AP_GETANGAS, AP_GETDATA

CALLER:     UTIL4

@


1.41
log
@INCLUDE apdocout_include.also
@
text
@d182 1
a182 1
SUBROUTINE: APMASTER, APSH_PS, APSH_SS, APRINGS, NORMASC, NORMASS, 
@


1.40
log
@*** empty log message ***
@
text
@d27 1
a27 1
         .ENTER TEMPLATE FOR REFERENCE IMAGES: REF***
d31 1
a31 1
         .ENTER FILE NUMBERS OR SELECTION DOC. FILE NAME: SELECTREF
d59 1
a59 1
         .REFERENCE IMAGES ANGLES DOCUMENT FILE: Refangles
d64 1
a64 1
         .ENTER TEMPLATE FOR IMAGE SERIES TO BE ALIGNED: DAT***
d69 1
a69 1
         .ENTER FILE NUMBERS OR SELECTION DOC. FILE NAME: 1-2100
d74 1
a74 1
         .EXPERIMENTAL IMAGES ALIGNMENT DOCUMENT FILE:   angles001
d94 1
a94 1
         .CHECK MIRRORED POSITIONS?, SHIFT/ROTATE INPUT? (Y/N): Y,Y
d106 1
a106 1
         .OUTPUT ALIGNMENT DOCUMENT FILE: align_doc_001
d108 3
a110 2
           experimental image.  See NOTES for explanation of columns in 
           document file.  Will append to an existing output file of same name.] 
d113 1
a113 89
NOTES:      1. Output document file produced by this operation contains 
               15 register columns:                                                     
          
           '<ol>'
           '<li>' Eulerian angle (psi) of nearest reference image.         '<br />'
               When no matching projection was found within the 
               angular range specified, this column will contain 
               the experimental image's previous Eulerian angle 
               (if any) or 0.0.                                            '</li>'

            '<li>'Eulerian angle (theta) of nearest reference image.       '<br />'
               When no matching projection was found within the
               angular range specified, this column will contain 
               the experimental image's previous Eulerian angle 
               (if any) or 0.0.                                            '</li/>'

            '<li>'Eulerian angle (phi) of nearest reference image.         '<br />'
               When no matching projection was found within
               the angular range specified, this column will contain 
               the experimental
               image's previous Eulerian angle (if any) or 0.0.            '</li>'
                                      
            '<li>'Number of the most similar reference projection.         '<br />'
               When no matching projection was found within
               the angular range specified, this column will contain 0.    '</li>'

            '<li>'Experimental projection number.                          '</li>'

            '<li>'Cumulative In-plane rotation angle (psi).                '<br />' 
               To use in 3D reconstruction programs invert the sign. 
               This is the sum of any rotation from the 'experimental 
               images align. document file' and the current rotation.      '</li>' 
           
            '<li>'Cumulative X shift.                                      '<br />'
               This is the sum of any shift from the 'experimental 
               images align. document file' and any current shift.         '<br />'
               Note that the shifts reported here have been adjusted
               to compensate for any rotation, so that they are
               appropriate for use with SPIDER operations such as
               'RT SQ'.  For this reason the current shifts may be
               outside than the shift range that you requested above.       '</li>'

            '<li>'Cumulative Y shift. 				           '<br />'
               This is the sum of any shift from the 'experimental 
               images align. document file' and any current shift.         '</li>'

            '<li>'Number of reference projections searched.		   '<br />'
               This number can vary when an angular restriction
               on search is used.                                          '</li>'

           '<li>'Angular change for projection.			           '<br />'
               Angular difference between previous and current 
               projection. This will be -1.0 if the previous 
               projection angles were not specified.                       '</li>'

           '<li>'Not-normalized alignment correlation coefficient.	   '<br />'
               Can be used as a similarity measure.  (Normalization 
               gives a significant time penalty and there are reports 
               that normalization  decreases value of the statistic 
               in distinguishing best fit.)                                '</li>'

       '<p>' Following values are seldom used by existing procedures:      '</p>'

           '<li>'Current In-plane rotation angle (psi).		           '<br />'	   
               This is the rotation necessary to align the experimental 
               image with the current reference projection.                '</li>'

           '<li>'Current X shift.					   '<br />'
               X shift necessary to align the experimental 
               image with the current reference projection.             
               Note that the shifts reported here have been adjusted
               to compensate for any rotation, so that they are
               appropriate for use with SPIDER operations such as
               'RT SQ'.  For this reason the current shifts may be
               greater than this shift range that you applied above.       '</li>'

           '<li>'Current Y shift.                                          '<br />'
               Y shift necessary to align the experimental 
               image with the current reference projection.                 '</li>'

           '<li>'Current Mirroring.					    '<br />'
               This value is negative if mirroring was necessary to 
               align the experimental image with the reference 
               projection. Otherwise it is positive.                        '</li>'

         '</ol>'


        2.  In 3D space the projection with the direction: (psi, theta, phi)
d116 2
a117 1
            To save time, the program takes this into account, and each data
d121 1
a121 1
            with 0<theta<90.                                           '<br />'
d123 1
a123 1
            then the number stored in the 15th register of the document file
d125 2
a126 2
            the projection direction reported in the 1st register column  is the 
            proper projection direction  for the mirrored image.       '<br />'
d128 1
a128 1
        3. The reference projections of an existing structure 
d134 1
a134 1
        4. Alignment parameters (angle and translation included in
d138 1
a138 1
        5. Alignment parameters can be used as input to further 'AP SH'
d141 1
a141 1
        6. This operation parallelized for use with MPI.
d143 1
a143 1
        7. Setting a angular search limit of 180 degrees with checking of mirrored
d147 1
a147 1
        8. This operation never was written to provide comprehensive
d151 1
a151 1
        9. Sequence of steps in the alignment carried out by this operation:   '<br />'
@


1.39
log
@y axis
@
text
@d5 9
a13 7
PURPOSE:  Compares a series of experimental images with a series of reference
          images.  For each experimental image, it finds the in-plane Euler
          rotation angle, and X, Y translational shifts which align the image with the 
          most-similar reference image.  
          Exhaustively checks all requested rotations and shifts.
          Can restrict angular range of projections. 
          Can restrict checking of mirror image.'<br />'
@


1.38
log
@subpixel note
@
text
@d199 1
a199 1
            has its mirrored (around X-axis) counterpart in the direction: 
@


1.37
log
@*** empty log message ***
@
text
@d231 5
a235 1
        8. Sequence of steps in the alignment carried out by this operation:   '<br />'
@


1.36
log
@nx
@
text
@d9 3
a11 2
           Exhaustively checks all requested rotations and shifts.
          Can restrict angular range of projections. Can restrict checking of mirror image.'<br />'
d15 2
a16 1
SEE ALSO:  VO EA  
d21 1
a21 1
           AP SHC
d42 1
a42 1
          alignment determination with minimal effect on
d105 20
a124 3
          [This is the only output produced by this operation.  (Will append to 
           existing output file of same name).  
           It contains 15 register columns:                             '<br />'
d126 1
a126 1
            1. Eulerian angle (psi) of nearest reference image.         '<br />'
d130 1
a130 13
               image's previous Eulerian angle (if any) or 0.0.         '<br />'

            2. Eulerian angle (theta) of nearest reference image.       '<br />'
               When no matching projection was found within
               the angular range specified, this column will contain 
               the experimental
               image's previous Eulerian angle (if any) or 0.0.         '<br />'

            3. Eulerian angle (phi) of nearest reference image.         '<br />'
               When no matching projection was found within
               the angular range specified, this column will contain 
               the experimental
               image's previous Eulerian angle (if any) or 0.0.         '<br />'
d132 1
a132 1
            4. Number of the most similar reference projection.         '<br />'
d134 1
a134 1
               the angular range specified, this column will contain 0. '<br />'
d136 1
a136 1
            5. Experimental projection number.                          '<br />'
d138 1
a138 1
            6. Cumulative In-plane rotation angle (psi).                '<br />' 
d141 3
a143 3
               images align. document file' and the current rotation.   '<br />'                             '<br />'

            7. Cumulative X shift.                                      '<br />'
d145 1
a145 1
               images align. document file' and any current shift.                                   '<br />'
d150 1
a150 1
               greater than this shift range that you applied above.
d152 1
a152 1
            8. Cumulative Y shift.                                      '<br />'
d154 1
a154 1
               images align. document file' and any current shift.                                   '<br />'
d156 1
a156 1
            9. Number of reference projections searched.                '<br />'
d158 1
a158 1
               on search is used.                                       '<br />'
d160 1
a160 1
           10. Angular change for projection.                           '<br />'
d163 1
a163 1
               projection angles were not specified.                                           '<br />'
d165 1
a165 1
           11. Not-normalized alignment correlation coefficient.        '<br />'
d169 1
a169 1
               in distinguishing best fit.)                             '<br />'
d171 1
a171 1
       '<p>' Following values are seldom used by existing procedures:   '</p>'
d173 1
a173 1
           12. Current In-plane rotation angle (psi).                   '<br />'        
d175 1
a175 1
               image with the current reference projection.             '<br />'
d177 1
a177 1
           13. Current X shift.                                         '<br />'
d184 1
a184 1
               greater than this shift range that you applied above.    '<br />'
d186 1
a186 1
           14. Current Y shift.                                         '<br />'
d188 1
a188 1
               image with the current reference projection.             '<br />'
d190 1
a190 1
           15. Current Mirroring.                                       '<br />'
d193 4
a196 1
               projection. Otherwise it is positive.'<br />'
d198 1
a198 1
NOTE:   1.  In 3D space the projection with the direction: (psi, theta, phi)
d212 1
a212 1
        2. The reference projections (of an existing structure)
d218 1
a218 1
        3. Alignment parameters (angle and translation included in
d222 1
a222 1
        4. Alignment parameters can be used as input to further 'AP SH'
d225 1
a225 1
        5. This operation parallelized for use with MPI.
d227 1
a227 1
        6. Setting a angular search limit of 180 degrees with checking of mirrored
d231 1
a231 1
        7. Sequence of steps in the alignment carried out by this operation:   '<br />'
d262 1
a262 1
SUBROUTINE: APMASTER, APSH_PS, APSH_SS, APRINGS, NORMASC, NORMASS, ALRQ_MS,
d264 1
a264 1
            RINGWE, APPLYWS, PARABLD, AP_GETDATS, AP_GETDAT
@


1.35
log
@rot first
@
text
@d8 3
a10 2
          most-similar reference image.  Exhaustively checks all requested rotations and shifts.
          Can restrict angular range of projections. Can restrict checking of mirror image.   '<br />'
d36 1
a36 1
           1. Search range + last ring <=NSAM/2-2               '<br />' 
@


1.34
log
@subroutines
@
text
@d3 1
a3 1
                                                             02/23/11
d89 1
a89 1
         .CHECK MIRRORED POSITIONS (0=NOCHECK / 1=CHECK)?: 1
d92 8
a99 1
           directions, speed can be doubled.  See note: 1 below.
d101 1
a101 1
         .OUTPUT ALIGNMENT DOCUMENT FILE: PARM101
@


1.33
log
@*** empty log message ***
@
text
@d244 3
a246 3
SUBROUTINE: APMASTER, AP_SH_PS, AP_SH_SS, APRINGS, NORMASC, NORMASS, ALRQ_MS,
            CROSRNG_MS, CROSRNG_E, FRNGS, AP_END, AP_STAT,    
            RINGWE, APPLYWS, PARABLD, AP_GETANGA, AP_GETDATS, AP_GETDAT
@


1.32
log
@renamed mrqli..
@
text
@d3 1
a3 1
                                                             07/20/10
d55 4
a58 3
          [Enter the name of the document file containing Eulerian
           angles for the reference images: psi, theta, phi.]

@


1.31
log
@\
@
text
@d243 1
a243 1
SUBROUTINE: APMASTER, MRQLI_PS, MRQLI_SS, APRINGS, NORMASC, NORMASS, ALRQ_MS,
@


1.30
log
@ap shc link
@
text
@d9 1
a9 1
          Can restrict angular range of projections. Can restrict checking of mirror image.   '<br \>'
d33 4
a36 4
           +/- search range, performed every "step size" pixel. '<br \>'
           Restrictions:                                        '<br \>'
           1. Search range + last ring <=NSAM/2-2               '<br \>' 
           2. Search range has to be divisible by step size.]   '<br \>'
d47 1
a47 1
          every 'ring step' radius and on every 'ray step' radial ray.  '<br \>'
d49 1
a49 1
          ray can be included in search.                                '<br \>'
d125 1
a125 1
               images align. document file' and the current rotation.   '<br />'                             '<br \>'
@


1.29
log
@note about shift modifications
@
text
@d3 1
a3 1
                                                             03/02/10
d18 1
@


1.28
log
@x & y shift input
@
text
@d3 1
a3 1
                                                             02/26/10
d127 7
a133 3
               This is the sum of any
               shift from the 'experimental images align. document file'
               and any current shift.                                   '<br />'
d136 2
a137 3
               This is the sum of any
               shift from the 'experimental images align. document file'
               and any current shift.                                   '<br />'
d162 6
a167 1
               image with the current reference projection.             '<br />'
@


1.27
log
@normalization msg
@
text
@d3 1
a3 1
                                                                      11/24/09
d30 2
a31 2
         .TRANSLATION SEARCH RANGE, STEP SIZE: 6,2
          [The search for translation parameters will be restricted to
d39 3
a41 1
          final reconstruction resolution.]
@


1.26
log
@*** empty log message ***
@
text
@d3 1
a3 1
                                                                      08/26/09
d139 3
a141 3
               Angular difference between previous and current projection.
               This will be -1.0 if the previous projection angles was
               not specified.                                           '<br />'
d144 4
a147 1
               Can be used as a similarity measure.                     '<br />'
@


1.25
log
@*** empty log message ***
@
text
@d16 1
a16 2
           OR MQ
           OR NQ
@


1.24
log
@*** empty log message ***
@
text
@d37 1
a37 1
           Speed will depend on square of the number of positions searched.] 
d53 2
a54 2
          [Enter the name of the angular document file containing Eulerian
           angles of reference images (projections): psi, theta, phi.]
d63 2
a64 2
           be read from a selection document file where file numbers are contained in the
           first register (not the keys).]
d76 4
a79 3
          [Experimental images will be compared with only these
           reference images whose normal is within specified range (in degrees). If a 0.0
           is input, then there is NO restriction on which of the projections
d92 3
a94 3
          [This is the only output produced by this operation.  (Appends to existing output
           file of same name).  
           It contains 15 register columns:                            '<br \>'
d96 1
a96 1
            1. Eulerian angle (psi) of nearest reference image.         '<br \>'
d98 3
a100 2
               the angular range specified, this column will contain the experimental
               image's previous Eulerian angle (if any) or 0.0.         '<br \>'
d102 1
a102 1
            2. Eulerian angle (theta) of nearest reference image.       '<br \>'
d104 3
a106 2
               the angular range specified, this column will contain the experimental
               image's previous Eulerian angle (if any) or 0.0.         '<br \>'
d108 1
a108 1
            3. Eulerian angle (phi) of nearest reference image.         '<br \>'
d110 3
a112 2
               the angular range specified, this column will contain the experimental
               image's previous Eulerian angle (if any) or 0.0.         '<br \>'
d114 1
a114 1
            4. Number of the most similar reference projection.          '<br \>'
d116 1
a116 1
               the angular range specified, this column will contain 0.  '<br \>'
d118 1
a118 1
            5. Experimental projection number.                         '<br \>'
d120 4
a123 4
            6. Cumulative In-plane rotation angle (psi).               '<br \>' 
               To use in 3D reconstruction programs invert the sign. This is the
               sum of any rotation from the 'experimental images align. document file'
               and the current rotation.                              '<br \>'
d125 1
a125 1
            7. Cumulative X shift.                                     '<br \>'
d128 1
a128 1
               and any current shift.                                 '<br \>'
d130 1
a130 1
            8. Cumulative Y shift.                                     '<br \>'
d133 1
a133 1
               and any current shift.                                 '<br \>'
d135 1
a135 1
            9. Number of reverence projections searched.              '<br \>'
d137 1
a137 1
               on search is used.                                      '<br \>'
d139 1
a139 1
           10. Angular change for projection.                         '<br \>'
d142 1
a142 1
               not specified.                                        '<br \>'
d144 2
a145 2
           11. Not-normalized alignment correlation coefficient.      '<br \>'
               Can be used as a similarity measure.                   '<br />'
d147 1
a147 1
       '<p>' Following values are seldom used by existing procedures: '</p>'
d149 1
a149 1
           12. Current In-plane rotation angle (psi).                  '<br />'        
d151 1
a151 1
               image with the current reference projection.           '<br />'
d153 1
a153 1
           13. Current X shift.                                        '<br />'
d155 1
a155 1
               image with the current reference projection.            '<br />'
d157 1
a157 1
           14. Current Y shift.                                        '<br />'
d159 1
a159 1
               image with the current reference projection.           '<br />'
d161 1
a161 1
           15. Current Mirroring.                                      '<br />'
d168 1
a168 1
            (-psi, 180+theta, phi)                                '<br />'
d173 1
a173 1
            with 0<theta<90.                                         '<br />'
d178 1
a178 1
            proper projection direction  for the mirrored image.     '<br />'
d195 2
a196 2
        6. Setting a anglular search limit of 180 degrees with checking of mirrored
           positions does not give same rulsts as an unlimited search, since the
d201 2
a202 1
           Load gallery of reference images created by projection of the reference volume. '<br />'
d204 2
a205 1
           Extract radial rings from a window of each reference image, converting image to
d208 2
a209 2
           Take fourier transform of the ring data and weight the data corresponding 
           to length and radius.                                     '<br />'
d213 2
a214 2
           Extract radial rings from a window of sample image, coverting image to
           a polar representation.                                   '<br />'
d216 2
a217 2
           Take Fourier transform of the ring data and weight the data corresponding 
           to length and radius.                                     '<br />'
d219 2
a220 2
           Perform a cross correlation in Fourier space of the reference and 
           sample data.                                                '<br />'
d223 1
a223 1
           map it to a rotation angle for the sample image.            '<br />'
d225 2
a226 2
           Repeat for all requested X & Y shifts of the sample image. You now have 
           sample shift and rotation.                                 '<br />'
@


1.23
log
@*** empty log message ***
@
text
@d131 1
a131 1
            9. Number of projections searched.                        '<br \>'
d176 1
a176 3
        2. Images need not have power-of-two dimensions.

        3. The reference projections (of an existing structure)
d182 1
a182 1
        5. Alignment parameters (angle and translation included in
d186 1
a186 1
        6. Alignment parameters can be used as input to further 'AP SH'
d189 5
a193 1
        7. This operation parallelized for use with MPI.
d195 1
a195 1
        8. Sequence of steps in the alignment carried out by this operation:   '<br />'
@


1.22
log
@mirror angles wrong in Note 1
@
text
@d3 1
a3 1
                                                               03/09/09
d37 1
a37 1
           Speed will depend on square of the number of posistions searched.] 
d42 1
a42 1
         .FIRST, LAST RING, RING STEP & RAY STEP: 5,15,1,1
d87 2
a88 2
           only providing reference images from one hemisphere of projection directions
           speed can be doubled.  See note: 1 below.
d121 1
a121 1
            7. Cumulative X shift                                     '<br \>'
d126 1
a126 1
            8. Cumulative Y shift                                     '<br \>'
d132 1
a132 1
               Number of projections searched can vary when an angular restriction
d149 3
a151 3
           13. Current X shift                                        '<br />'
               This is the X shift necessary to align the experimental 
               image with the current referenceprojection.            '<br />'
d153 2
a154 2
           14. Current Y shift                                        '<br />'
               This is the Y shift necessary to align the experimental 
d157 4
a160 4
           15. Current Mirroring                                      '<br />'
               If mirroring was necessary to align the experimental 
               image with the reference projection in use, this value
               is negative.                                           '<br />'
d171 1
a171 1
            then the number stored in the 15th column of the document file
d178 1
a178 1
        3. The reference projections (of the existing structure)
d193 1
a193 1
        8. Sequence of steps in the alignment using this operation:   '<br />'
@


1.21
log
@*** empty log message ***
@
text
@d9 1
a9 1
          Can restrict angular range of projections. Can restrict checking of mirror image.  '<br>'
d33 4
a36 4
           +/- search range, performed every "step size" pixel.'<br>'
           Restrictions:'<br>'
           1. Search range + last ring <=NSAM/2-2'<br>'
           2. Search range has to be divisible by step size.]'<br>'
d40 1
a40 1
          final reconstruction resolution. ]
d45 1
a45 1
          every 'ring step' radius and on every 'ray step' radial ray.'<br>'
d47 1
a47 1
          ray can be included in search. '<br>'
d50 1
a50 1
          final reconstruction resolution. ]
d93 1
a93 1
           It contains 15 register columns:                           '<br>'
d95 1
a95 1
            1. Eulerian angle (psi) of nearest reference image.        '<br>'
d98 1
a98 1
               image's previous Eulerian angle (if any) or 0.0.        '<br>'
d100 1
a100 1
            2. Eulerian angle (theta) of nearest reference image.      '<br>'
d103 1
a103 1
               image's previous Eulerian angle (if any) or 0.0.        '<br>'
d105 1
a105 1
            3. Eulerian angle (phi) of nearest reference image.        '<br>'
d108 1
a108 1
               image's previous Eulerian angle (if any) or 0.0.        '<br>'
d110 1
a110 1
            4. Number of the most similar reference projection.         '<br>'
d112 1
a112 1
               the angular range specified, this column will contain 0. '<br>'
d114 1
a114 1
            5. Experimental projection number.                        '<br>'
d116 1
a116 1
            6. Cumulative In-plane rotation angle (psi).              '<br>' 
d119 1
a119 1
               and the current rotation.                             '<br>'
d121 1
a121 1
            7. Cumulative X shift                                    '<br>'
d124 1
a124 1
               and any current shift.                                '<br>'
d126 1
a126 1
            8. Cumulative Y shift                                    '<br>'
d129 1
a129 1
               and any current shift.                                '<br>'
d131 1
a131 1
            9. Number of projections searched.                       '<br>'
d133 1
a133 1
               on search is used. '<br>'
d135 1
a135 1
           10. Angular change for projection.                        '<br>'
d138 1
a138 1
               not specified. '<br>'
d140 2
a141 2
           11. Not-normalized alignment correlation coefficient.     '<br>'
               Can be used as a similarity measure.                  '<br>'
d145 1
a145 1
           12. Current In-plane rotation angle (psi).                 '<br>'        
d147 1
a147 1
               image with the current reference projection.          '<br>'
d149 1
a149 1
           13. Current X shift                                       '<br>'
d151 1
a151 1
               image with the current referenceprojection.           '<br>'
d153 1
a153 1
           14. Current Y shift                                       '<br>'
d155 1
a155 1
               image with the current reference projection.          '<br>'
d157 1
a157 1
           15. Current Mirroring                                     '<br>'
d160 1
a160 1
               is negative.                                          '<br>'
d163 2
a164 3
            has its mirrored (around X-axis) counterpart in the direction: '<br>'
            (-psi, 180+theta, phi+180) '<small>'(which is equivalent in usage to:  
            (-psi, 180-theta, phi+180)'</small>'. '<br>'
d169 1
a169 1
            with 0<theta<90.                                        '<br>'
d174 1
a174 1
            proper projection direction  for the mirrored image. <br>'
d193 1
a193 1
        8. Sequence of steps in the alignment using this operation:    '<br>'
d195 1
a195 1
           Load gallery of reference images created by projection of the reference volume.'<br>'
d198 1
a198 1
           a polar representation.                                  '<br>'
d201 1
a201 1
           to length and radius.                                    '<br>'
d203 1
a203 1
           Load a sample image.                                     '<br>'
d206 1
a206 1
           a polar representation.                                  '<br>'
d209 1
a209 1
           to length and radius.                                    '<br>'
d212 1
a212 1
           sample data.                                               '<br>'
d215 1
a215 1
           map it to a rotation angle for the sample image.           '<br>'
d218 1
a218 1
           sample shift and rotation.                                '<br>'
d220 1
a220 1
           Repeat for next sample image.                             '<br>'
@


1.20
log
@*** empty log message ***
@
text
@d3 1
a3 1
                                                               06/21/08
d88 1
a88 1
           speed can be doubled.]
d92 2
a93 2
           file of same name). 
           It contains 15 register columns:                 '<br>'
d95 1
a95 1
            1. Eulerian angle (psi) of nearest reference image. '<br>'
d100 1
a100 1
            2. Eulerian angle (theta) of nearest reference image. '<br>'
d105 1
a105 1
            3. Eulerian angle (phi) of nearest reference image. '<br>'
d110 1
a110 1
            4. Number of the most similar reference projection.'<br>'
d116 1
a116 1
            6. Cumulative In-plane rotation angle (psi).              '<br>'                                  '<br>'
d163 3
a165 2
            has its mirrored (around X-axis) counterpart in the direction:'<br>'
                       (-psi, 180-theta, phi+180).'<br>'
d173 3
a175 1
            is negative.                                            '<br>'
d194 1
a194 1
        8. Sequence of steps in the alignment using this operation:'<br>'
d199 1
a199 1
           a polar representation.'<br>'
d202 1
a202 1
           to length and radius.'<br>'
d204 1
a204 1
           Load a sample image.'<br>'
d207 1
a207 1
           a polar representation.'<br>'
d210 1
a210 1
           to length and radius.'<br>'
d213 1
a213 1
           sample data.'<br>'
d216 1
a216 1
           map it to a rotation angle for the sample image.'<br>'
d219 1
a219 1
           sample shift and rotation.'<br>'
d221 1
a221 1
           Repeat for next sample image.'<br>'
@


1.19
log
@*** empty log message ***
@
text
@d18 1
a18 1
           PJ SQ
@


1.18
log
@*** empty log message ***
@
text
@d46 2
@


1.17
log
@check of the mirrored
@
text
@d3 1
a3 1
                                                               05/21/08
d36 13
a48 4
           2. Search range has to be divisible by step size.] 

         .FIRST AND LAST RING: 5,15
          [Only pixels with radii in the range 5-15 will be analyzed.]
d84 3
a86 1
          [Optional check of the mirrored reference image.]
d110 1
a110 3
               the angular range specified, this column will contain 0.
               '<b>'No longer reports mirrored references here as the actual
                reference projection angles are reported in col. 1...3'</b>'  '<br>'
d112 1
a112 1
            5. Experimental projection number. (Often same as key number)     '<br>'
d138 2
a139 2
           11. Not-normalized correlation coefficient.                 '<br>'
               Can be used as a similarity measure.                    '<br>'
d141 1
a141 1
       '<p>' Following values are seldom used by existing proceedures: '</p>'
d218 2
a219 2
SUBROUTINE: APMASTER, MRQLI_PS, MRQLI_SS,  APRINGS, NORMASC, NORMASS, ALRQ_MS,
            CROSRNG_MS, CROSRNG_E, FRNGS,  AP_END, AP_STAT,    
@


1.16
log
@method added
@
text
@d3 1
a3 1
                                                                     05/21/08
d75 1
a75 1
          [Can mimic action of obsolete 'AP MD' operation.]
@


1.15
log
@*** empty log message ***
@
text
@d3 1
a3 1
                                                                     09/08/06
d180 32
a211 3
SUBROUTINE: APMASTER, MRQLI_PS, MRQLI_SS, AP_END, NORMAS, NORMASC, ALRQ_M, ALRQ_MS,
            CROSRNG_MS, CROSRNG_DS, CROSRNG_DS, FRNG, FRNGS, 
            APPLYWS, ALRQS, PARABLD, RINGWE
@


1.14
log
@MPI
@
text
@d2 1
a2 1
AP SH     Alignment - multi-reference, exhaustive rotation & shift ||MPI   AP SH
@


1.13
log
@added see also OR
@
text
@d2 1
a2 1
AP SH     Alignment - multi-reference, exhaustive rotation & shift ||   AP SH
d50 1
a50 1
         .ENTER FILE NUMBERS OR SELECTION DOC. FILE NAME: 1-21
d178 2
@


1.12
log
@angle change threshold note
@
text
@d3 1
a3 1
                                                                     03/17/05
d16 2
d161 1
a161 1
            is negative.'<br>'
@


1.11
log
@explanations improved
@
text
@d62 1
a62 1
         .RANGE OF ANGULAR SEARCH FOR PROJECTIONS: 20.0
d66 5
a70 1
           are compared.]
@


1.10
log
@emphasized lack of mirror flag
@
text
@d3 1
a3 1
                                                               02/22/05
d7 2
a8 2
          rotation angle, and X, Y shifts which align the image with the most-similar 
          reference image.  Exhaustively checks all specified rotations and shifts.
d37 1
a37 1
          [Only rings with radii in the range 5-15 will be analyzed.]
d64 1
a64 1
           reference images whose normal is within 20 degrees range. If a 0.0
d66 1
a66 1
           are compared]
d173 1
a173 1
            CROSRNG_MS, CROSRMG_DS, CROSRNG_DS, FRNG, FRNGS, 
@


1.9
log
@peak
@
text
@d3 1
a3 1
                                                               01/27/05
d93 3
a95 1
               the angular range specified, this column will contain 0.'<br>'
d97 1
a97 1
            5. Experimental projection number.                 '<br>'
d141 2
a142 2
               If mirroring was necessary to align the 
               experimental image with the reference projection, this value
@


1.8
log
@mirror note
@
text
@d3 1
a3 1
                                                                      01/20/05
d5 1
a5 1
PURPOSE:  Compares a series of experimental images with a series of references
d7 1
a7 1
          rotation angle and X, Y shifts which align the image with the most-similar 
d20 2
a21 2
          .ENTER TEMPLATE FOR REFERENCE IMAGES: REF***
          [Give the template name of the existing file series of 2D 
d24 1
a24 1
          .ENTER FILE NUMBERS OR SELECTION DOC. FILE NAME: SELECTREF
d29 1
a29 1
          .TRANSLATION SEARCH RANGE, STEP SIZE: 6,2
d36 1
a36 1
          .FIRST AND LAST RING: 5,15
d39 1
a39 1
          .REFERENCE IMAGES ANGLES DOCUMENT FILE: Refangles
d43 1
a43 1
          .ENTER TEMPLATE FOR IMAGE SERIES TO BE ALIGNED: DAT***
d48 1
a48 1
          .ENTER FILE NUMBERS OR SELECTION DOC. FILE NAME: 1-21
d59 1
a59 1
          'inplane rotation, shifts and other alignment parameters.  
d62 1
a62 1
        .RANGE OF ANGULAR SEARCH FOR PROJECTIONS: 20.0
d65 1
a65 1
           is input then there is NO restriction on which of the projections
d69 1
a69 1
         [Can mimic action of older 'AP MD' operation.]
d71 2
a72 2
          .OUTPUT ALIGNMENT DOCUMENT FILE: PARM101
          [This is the only output produced by this program.  (Appends to existing output
d138 1
a138 3
           15. Shift CC Peak & Current Mirroring                     '<br>'
               This is the cross correlation peak height from the
               shifted image.   Can be used as a similarity measure.
d141 1
a141 1
               is negated.     '<br>'
d150 1
a150 1
            with 0<theta<90.'<br>'
d158 1
a158 1
           can be created using 'VO EA' and 'PJ 3Q' commands.  'VO EA'
d164 2
a165 2
           columns 6-8 of the output document file) can be used in
           command 'RT SQ' to align images.
d168 1
a168 1
           or 'AP REF' runs during refinement.
@


1.7
log
@cols
@
text
@d2 2
a3 2
AP SH     Alignment - multi-reference, exhaustive rotation & shift ||    AP SH
                                                                      10/28/04
d8 1
a8 1
          reference image.  Exhautively checks all specified rotations and shifts.
d69 1
a69 1
         Can mimic action of older 'AP MD' operation.]
a93 2
               When this number is negative, the most similar image is the 
               mirrored projection (see note 1). 
d103 1
a103 1
               Cumulative X translation of image.  This is the sum of any
d108 1
a108 1
               Cumulative Y translation of image.  This is the sum of any
d112 1
a112 1
            9. Number of projections searched.                     '<br>'
d130 1
a130 1
           13. Current X shift                                    '<br>'
d132 1
a132 1
               image with the current referenceprojection.          '<br>'
d138 1
a138 1
           15. Shift CC Peak & Current Mirroring                                       '<br>'
d140 4
a143 3
               shifted image.  If mirroring was necessary to align the 
                experimental image with the reference projection this value
                is negated. Can be used as a similarity measure.     '<br>'
d154 2
a155 4
            then the number stored in the fourth column of the document file
            is negative (see included batch program).
            When no matching projection was found within
            the angular range specified, this column will contain 0.'<br>'
@


1.6
log
@*** empty log message ***
@
text
@d2 2
a3 2
AP SH     Alignment - multi-reference ||                     AP SH
                                                             4/15/04
d8 2
a9 2
          reference image.  Can restrict angular range of projections.  
          Can restrict checking of mirror image.  '<br>'
d76 1
a76 1
            1. Eulerian angle (psi) of nearest reference image angle. '<br>'
d81 1
a81 1
            2. Eulerian angle (theta) of nearest reference image angle. '<br>'
d86 1
a86 1
            3. Eulerian angle (phi) of nearest reference image angle. '<br>'
d99 1
a99 1
            6. Cumulative In-plane rotation angle (-psi).              '<br>'                                  '<br>'
d120 2
a121 2
               This will be -1.0 if there were no previous projection 
               angles used. '<br>'
d128 1
a128 2
           12. Current In-plane rotation angle (-psi).              '<br>'        
               To use in 3D reconstruction programs invert the sign. 
d130 1
a130 1
               image with the current projection.          '<br>'
d134 1
a134 1
               image with the current projection.          '<br>'
d138 1
a138 1
               image with the current projection.          '<br>'
d140 5
a144 3
           15. Current Mirroring                                       '<br>'
               This is the mirroring necessary to align the experimental 
               image with the current projection. 0 is non-mirrored        '<br>'
d155 1
a155 1
            then the number stored in the first column of the document file
@


1.5
log
@cosmetic
@
text
@d53 1
a53 1
         .EXPERIMENTAL IMAGES ALIGN. DOCUMENT FILE:   angles001
@


1.4
log
@mq
@
text
@d76 1
a76 1
            1. Eulerian angle (PSI) of nearest reference image angle. '<br>'
d86 1
a86 1
            3. Eulerian angle (PHI) of nearest reference image angle. '<br>'
@


1.3
log
@*** empty log message ***
@
text
@d55 1
a55 1
           similar to old 'AP MD'.  If you desire to restrict the range of
d59 1
a59 1
          'inplane rotation, shifts and other alignment parameters).  
@


1.2
log
@*** empty log message ***
@
text
@d2 2
a3 2
AP SH     Alignment - multi-reference                      ||  AP SH
                                                             3/17/04
d8 1
a8 1
          reference image.  Can restricted angular range of projections.  
d72 2
a73 1
          [This is the only output produced by this program.
d94 2
d97 1
a97 2
            5. Not-normalized correlation coefficient.                 '<br>'
               Can be used as a similarity measure.                    '<br>'
a109 1
               Y translation determined. 
d114 3
a116 4
            9. Cumulative Mirroring                                   '<br>'
               Cumulative mirroring of image.  This is the sum of any
               mirroring from the 'experimental images align. document file'
               and current mirroring.                                '<br>'
d119 8
a126 1
               Angular difference between previous and current projection. '<br>'
d128 1
a128 1
           11. Current In-plane rotation angle (-psi).              '<br>'                                  '<br>'
d133 1
a133 1
           12. Current X shift                                    '<br>'
d137 1
a137 1
           13. Current Y shift                                       '<br>'
d141 1
a141 1
           14. Current Mirroring                                       '<br>'
@


1.1
log
@Initial revision
@
text
@d161 1
a161 1
           columns 3-5 of the output document file) can be used in
d164 2
a165 3
        6. An example of the SPIDER batch program which can be used to produce
           an angular document file from the output document file of this
           command is included in the manual chapter for the command 'VO MD'.
@
