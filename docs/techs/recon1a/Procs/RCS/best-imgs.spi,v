head	1.19;
access;
symbols
	Pre_gold:1.16
	GPL_update:1.7
	pre_rewrite_2010:1.6
	pre_more_stack:1.2
	best-code:1.1
	no-named-regs:1.1
	pre_GPL:1.1
	tag_version1_0:1.1;
locks;
comment	@# @;


1.19
date	2016.07.07.14.46.11;	author leith;	state Exp;
branches;
next	1.18;

1.18
date	2016.07.05.19.14.30;	author leith;	state Exp;
branches;
next	1.17;

1.17
date	2016.03.25.17.40.00;	author leith;	state Exp;
branches;
next	1.16;

1.16
date	2014.08.13.20.03.40;	author tapu;	state Exp;
branches;
next	1.15;

1.15
date	2013.12.13.15.53.59;	author leith;	state Exp;
branches;
next	1.14;

1.14
date	2013.11.20.18.36.11;	author leith;	state Exp;
branches;
next	1.13;

1.13
date	2013.11.19.20.32.28;	author leith;	state Exp;
branches;
next	1.12;

1.12
date	2013.11.13.19.41.47;	author leith;	state Exp;
branches;
next	1.11;

1.11
date	2013.11.13.16.52.50;	author leith;	state Exp;
branches;
next	1.10;

1.10
date	2013.11.12.14.03.23;	author leith;	state Exp;
branches;
next	1.9;

1.9
date	2013.11.08.19.26.22;	author leith;	state Exp;
branches;
next	1.8;

1.8
date	2012.05.23.03.10.54;	author tapu;	state Exp;
branches;
next	1.7;

1.7
date	2010.01.19.18.52.00;	author leith;	state Exp;
branches;
next	1.6;

1.6
date	2009.01.26.13.22.36;	author leith;	state Exp;
branches;
next	1.5;

1.5
date	2007.02.02.14.21.33;	author leith;	state Exp;
branches;
next	1.4;

1.4
date	2007.01.18.16.38.55;	author leith;	state Exp;
branches;
next	1.3;

1.3
date	2007.01.17.16.35.40;	author leith;	state Exp;
branches;
next	1.2;

1.2
date	2006.09.27.16.41.55;	author leith;	state Exp;
branches;
next	1.1;

1.1
date	2005.07.08.12.27.06;	author leith;	state Exp;
branches;
next	;


desc
@new july 2005 a leith replaces b19.spi
@


1.19
log
@comments
@
text
@ ; <html><head><title>Choose best images per direction</title></head><body><pre>
 ;
 ; SOURCE:      spider/docs/techs/recon1/Procs/best-imgs.spi      
 ;
 ; PURPOSE:     Limits particles from each reference direction  
 ;              Continue with reconstruction following this limitation using:
 ;              <i><a href="recon-regroup.spi">recon-regroup.spi</a></i>
 ;
 ; USAGE:       spider spi/dat @@best-imgs
 ;
 ; REQUIRES:    spider/docs/techs/recon1/Procs/verify-settings.spi
 ;
 ; INPUTS:  (Where ### denotes view   *** denotes group)
 ;  [ref_view_list]     [rec_dir]/sel_proj               Projection/view list       (one)
 ;  [sel_group]         [win_dir]/sel_group              Old group selection file   (one)
 ;  [sel_part]          [win_dir]/sel_part_***           Particle selection list    (one/group)
 ;  [good_particles]    views/prj###/sel_part_byv_good   Selection & CCC files (if using verify) (one/view)
 ;     or               views/prj###/sel_part_byv_goodB  Selection & CCC files (if using verify & recheck) (one/view)
 ;     or               views/prj###/sel_part_byv_sort   Selection files       (if not using verify) (one/view)
 ;
 ; OUTPUTS:  
 ;  [sel_group_best]    sel_group_best'                  New group selection file      (one)
 ;  [sel_part_best]     sel_part_best_***'               New particle selection files  (one/group)
 ;  [best_particles]    views/prj###/sel_part_byv_best'  Selection & CCC files         (one/view)
 ;  [parts_vsview_best] views/parts_vsview_best'         Total # of good particles     (one/view)

 ; <b> -------------- Parameters -------------------------------------

 [maxim] = -1                ; Max number of images/reference-view to retain (<0 == all)

 ; Type of verification used determines particle selection file name 
 [use-particles] = 0         ; Use:  (sorted particles == 0 ), (class verified == 1) (class verified & rechecked == 2)
 
 ;  -------------------- END BATCH HEADER --------------------

 MD
   TR OFF                                   ; Decrease results file output
 MD
   VB OFF                                   ; Decrease results file output

 ; Set common filenames & parameters
 @@verify-settings

 ; Evaluate whether input suffix is: sorted, good,  or  goodB

 [particles] = [sorted_particles]           ; No classification verification

 IF ( [use-particles] == 1 ) THEN
    [particles] = [good_particles]          ; Used classification verification
 ELSEIF  ( [use-particles] == 2 ) THEN
    [particles] = [new_good_particles]      ; Used classification verification with recheck
 ENDIF


 sys
  echo "  Using: [particles]"  ; echo


 ; Set temporary files
 [sel_part_prev]           = '[sel_part]_prev'       ; Renamed old particle selection files (one/group)
 [temp_parts_byview]       = 'tmpdoc_byview_incore'
 [temp_sorted_byview]      = 'tmpdoc_byview_sorted'
 [temp_combined]           = 'tmpdoc_combined'
 [temp_grouplist_unsorted] = 'tmpdoc_bygrp_unsort{***[grp]}'

 ; Delete pre-existing files
 DE
   [sel_group_best]
 SD /      GROUP_NUM     AFTER_LIM     BEFORE_LIM     PERCENT
   [sel_group_best]
 DE
   [temp_combined]
 DE
   [parts_vsview_best]
 SD /      AFTER_LIM     BEFORELIM      PERCENT
   [parts_vsview_best]

 UD N [views]                       ; Get number of views
   [ref_view_list]                  ; Doc file                    (input)

 IF ( [maxim] > 0 ) THEN
   SYS
     echo -n '  Keeping up to: {%I0%[maxim]} particles from: {%I0%[views]} views    ' ; date
 else
   SYS
     echo -n '  Keeping all particles from: {%I0%[views]} views    ' ; date
 endif

 ; Initialize counters
 [totview-before] = 0
 [totview-after]  = 0
 [part-counter]   = 0                 ; File    (output) key counter
 [zero]           = 0
 [dum]            = 0

 DO [view]=1,[views]                  ; Loop over all views for this group

    UD N [view-parts]                 ; Get number of images for this view
      [particles][view]               ; Listing file                (input)

    IF ( [view-parts] <=  0 ) THEN
      ; Write to summary
      SD [view], [zero],[zero],[zero]
        [parts_vsview_best]           ; File      (output)
        
      ; Create empty file
      SYS
        touch [best_particles][view].$DATEXT
      ; (Downstream batch files may look for this file.)

      CYCLE                           ; Skip to next view
    ENDIF
    
    ; Initialize in-core stack
    SD IC NEW
      [temp_parts_byview]
      7, [view-parts]                 ; Incore file    (output) 
    
    ; Retain only best particles
    IF ( [view-parts] > [maxim] ) THEN

      IF ( [maxim] > 0 ) THEN
        ; Only keep maxim images

        DOC SORT
          [particles][view]            ; Particle listing file        (input)
          [temp_sorted_byview]         ; Temp sorted listing file     (output)
          -4                           ; Column to be sorted (CCROT)
          Y                            ; Compress & renumber keys

        DO [pkey2] = 1,[maxim]
          UD IC [pkey2], [view-slice2],[glo-num2],[grp-slice2],[ccrot],[mirror],[grp-num2],[view-num2]
            [temp_sorted_byview]       ; Listing file          (input)

          SD IC [pkey2], [view-slice2],[glo-num2],[grp-slice2],[ccrot],[mirror],[grp-num2],[view-num2]
            [temp_parts_byview]

          [part-counter] = [part-counter] + 1

          !SD [part-counter], [grp-slice2],[view-slice2],[grp-num2],[view-num2],[glo-num2]
          SD [part-counter], [dum],[dum],[dum],[glo-num2],[dum]
            [temp_combined]                 ; File    (output)
        ENDDO
            
        [percent-kept]   = ([maxim]/[view-parts])*100
        [totview-before] = [totview-before] + [view-parts]
        [totview-after]  = [totview-after] + [maxim]
            
        ; Write to summary
        SD [view], [maxim],[view-parts],[percent-kept]
          [parts_vsview_best]
            
        ; Close docs
        UD ICE
          [temp_sorted_byview]          ; Temp sorted listing file (closed)
        DE
          [temp_sorted_byview]

        GOTO LB1
      ENDIF
    ENDIF
            
    ; Retain all particles (if [maxim] <= 0 OR [view-parts] > [maxim])

    DO  [pkey6] = 1,[view-parts]
      UD IC [pkey6], [view-slice6],[glo-num6],[grp-slice6],[ccrot],[mirror],[grp-num6],[view-num6]
        [particles][view]             ; Listing file            (input)

      SD IC [pkey6], [view-slice6],[glo-num6],[grp-slice6],[ccrot],[mirror],[grp-num6],[view-num6]
        [temp_parts_byview]

      [part-counter] = [part-counter] + 1
      
      !SD [part-counter], [grp-slice6],[view-slice6],[grp-num6],[view-num6],[glo-num6]
      SD [part-counter], [dum],[dum],[dum],[glo-num6]
        [temp_combined]
        ; TO DO: check if DOC COMBINE + SD IC is faster
    ENDDO

    [percent-kept]   = 100
    [totview-before] = [totview-before] + [view-parts]
    [totview-after]  = [totview-after] + [view-parts]
    
    ; Write to summary
    SD [view], [view-parts],[view-parts],[percent-kept]
      [parts_vsview_best]
    
    ; Close docs
    UD ICE
      [particles][view]                ; Temp sorted listing file
    
  LB1

 
    ; Close docs
    SD IC COPY
      [temp_parts_byview]
      [best_particles][view]
    SD IC E
      [temp_parts_byview]
    SD /      VIEW_WIN     GLOBAL_NUM     GRP_WIN         CCROT        MIRROR        GRP_NUM       VIEW
      [best_particles][view]
    SD E
      [best_particles][view]
 ENDDO                    ; End view-loop -------------------------------------

 SYS
   echo "  Kept: {%I0%[totview-after]} Out of: {%I0%[totview-before]} particles In: {%I0%[views]} views"

 ; Close docs
 [dummy] = -[views]
 SD /           AFTER_LIM     BEFORELIM
   [parts_vsview_best]
 SD [dummy], [totview-after],[totview-before]
   [parts_vsview_best]
 SD E
   [parts_vsview_best]
 SD E
   [temp_combined]


 ; GENERATE GROUP PARTICLE DOCS xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

 ; Get # of groups
 UD N [num-grps]
   [sel_group]

 SYS
   echo ; echo -n "  Keeping good particles from: {%I0%[num-grps]}  groups    " ; echo
 
 MD
   VB ON

 ; Initialize counters
 [totgrp-before] = 0
 [totgrp-after]  = 0

 ; Loop through groups
 DO  [grp] = 1,[num-grps]        ; Loop through groups ---------------------------------

    ; Get # of particles before in this group
    UD N [grpparts-before]
      [sel_part][grp]
    
    ; Intersect group particle list with combined list
    DOC AND
      [sel_part][grp]            ; File    (input)
      [temp_combined]            ; File    (input)
      [temp_grouplist_unsorted]  ; File    (output)
      4                          ; Column # to intersect: global #
    
    ; Check if previous file exists
    IQ FI [sel-exists]
      [sel_part_best][grp]       ; File  (input)
    IF ( [sel-exists] == 1 ) THEN
      ; If it exists, rename
      SYS                        ; Rename existing selection file 
        \mv -v [sel_part_best][grp].$DATEXT   prev_[sel_part_best][grp].$DATEXT
    ENDIF

   !SD /      APSHSLICE     MIC_SLICE     APSHGROUP      MICNUM       GLOBALNUM
    SD /        WIN          MIC_NUM       MIC_WIN      GLOBAL_NUM        GRP
      [sel_part_best][grp]       ; File  (output)
    SD E
      [sel_part_best][grp]       ; File  (closed)

    ; Renumber keys & resort
    DOC SORT A
      [temp_grouplist_unsorted]  ; File    (input)
      [sel_part_best][grp]       ; File    (output)
      4                          ; Column # to sort by: global #
      Y                          ; Renumber keys
    
    ; Clean up
    DE
      [temp_grouplist_unsorted]  ; File  (removed)

    ; Get # particles after
    UD N [grpparts-after]
      [sel_part_best][grp]       ; File  (input)
    
    ; Increment counters
    [percent-kept]  = ([grpparts-after]/[grpparts-before])*100
    [totgrp-before] = [totgrp-before] + [grpparts-before]
    [totgrp-after]  = [totgrp-after]  + [grpparts-after]
    
    ; Write to summary
    SD [grp], [grp],[grpparts-after],[grpparts-before],[percent-kept]
      [sel_group_best]         ; File  (output)
    
    SYS
      echo "  Group: {***[grp]}: Kept: {%I0%[grpparts-after]} out of: {%I0%[grpparts-before]} particles"
 ENDDO                         ; End group-loop -------------------------------------

 SYS
   echo ; echo -n "  Done -- Assigned: {%I0%[totgrp-after]} out of: {%I0%[totgrp-before]}  particles into: {%I0%[num-grps]} groups   " ; date ; echo

 ; Close docs
 DE
   [temp_combined]            ; File  (removed)

 [dummy] = -[num-grps]
 SD /           AFTER_LIM     BEFORELIM
   [sel_group_best]         ; File  (output)
 SD [dummy], [totgrp-after],[totgrp-before]
   [sel_group_best]         ; File  (output)
 SD E
   [sel_group_best]         ; File  (closed)

 EN

 ; Modified 2016-03-25
 ;    2016-03-25 (agl) -- New file locations
 ;    2013-11-28 (trs) -- bug fixes
 ;    2013-10-23 (agl) -- New file names, modernized syntax & cosmetic
 ;    2012-05-01 (trs) -- now required but added option to keep all particles

 ; </pre></body></html>
@


1.18
log
@echo formatting
@
text
@d7 1
a7 1
 ;              <i><a href="bp-regroup.spi">bp-regroup.spi</a></i>
d9 1
a9 1
 ; USAGE:       clean ; ./spider spi/dat @@best-imgs
@


1.17
log
@comments
@
text
@d55 2
a56 2
sys
  echo " Using: [particles]"  ; echo
d83 1
a83 1
     echo -n ' Keeping up to: {%I0%[maxim]} particles from: {%I0%[views]} views    ' ; date
d86 1
a86 1
     echo -n ' Keeping all particles from: {%I0%[views]} views    ' ; date
d208 1
a208 1
   echo " Kept: {%I0%[totview-after]} Out of: {%I0%[totview-before]} particles In: {%I0%[views]} views"
d229 1
a229 1
   echo ; echo -n " Keeping good particles from: {%I0%[num-grps]}  groups    " ; echo
d292 1
a292 1
      echo " Group: {***[grp]}: Kept: {%I0%[grpparts-after]} out of: {%I0%[grpparts-before]} particles"
d296 1
a296 1
   echo ; echo -n " Done -- Assigned: {%I0%[totgrp-after]} out of: {%I0%[totgrp-before]}  particles into: {%I0%[num-grps]} groups   " ; date ; echo
@


1.16
log
@Used I0 specifier for number of particles in each group
@
text
@d14 6
a19 6
 ;  [ref_view_list]     = 'sel_proj'                        ; Projection/view list       (one)
 ;  [sel_group]         = '../Alignment/sel_group'          ; Old group selection file   (one)
 ;  [sel_part]          = '../Alignment/sel_part_***'       ; Particle selection list    (one/group)
 ;  [good_particles]    = 'views/prj###/sel_part_byv_good'  ; Selection & CCC files (if using verify) (one/view)
 ;     or          ]    = 'views/prj###/sel_part_byv_goodB' ; Selection & CCC files (if using verify & recheck) (one/view)
 ;     or               = 'views/prj###/sel_part_byv_sort'  ; Selection files       (if not using verify) (one/view)
d22 4
a25 4
 ;  [sel_group_best]    = 'sel_group_best'                  ; New group selection file      (one)
 ;  [sel_part_best]     = 'sel_part_best_***'               ; New particle selection files  (one/group)
 ;  [best_particles]    = 'views/prj###/sel_part_byv_best'  ; Selection & CCC files         (one/view)
 ;  [parts_vsview_best] = 'views/parts_vsview_best'         ; Total # of good particles     (one/view)
d29 1
a29 1
 [maxim] = -1              ; Max number of images/reference-view to retain (<0 == all)
d32 1
a32 1
 [use-particles] = 0       ; Use:  (sorted particles == 0 ), (class verified == 1) (class verified & rechecked == 2)
d37 1
a37 1
   TR OFF                                             ; Decrease results file output
d39 1
a39 1
   VB OFF                                             ; Decrease results file output
d46 1
a46 1
 [particles] = [sorted_particles]            ; No classification verification
d49 1
a49 1
    [particles] = [good_particles]         ; Used classification verification
d51 1
a51 1
    [particles] = [new_good_particles]     ; Used classification verification with recheck
d60 1
a60 1
 [sel_part_prev]           = '[sel_part]_prev'        ; Renamed old particle selection files (one/group)
d312 2
a313 1
 ; Modified 2014-08-13
@


1.15
log
@Tapu's changes
@
text
@d292 1
a292 1
      echo " Group: {***[grp]}: Kept: {%I4%[grpparts-after]} out of: {%I4%[grpparts-before]} particles"
d312 1
a312 1
 ; Modified 2013-11-28
@


1.14
log
@Using: [particles]" msg, defaults to good
@
text
@d32 1
a32 1
 [use-particles] = 1       ; Use:  (sorted particles == 0 ), (class verified == 1) (class verified & rechecked == 2)
d46 2
a47 1
 [particles] = [good_particles]            ; No classification verification
d50 1
a50 1
 ELSEIF  ( [use-particles] == 2 )
d258 1
a258 1
        \mv [sel_part_best][grp].$DATEXT   prev_[sel_part_best][grp].$DATEXT
d270 1
a270 1
      [sel_part_best][grp]            ; File    (output)
d312 2
a313 1
 ; Modified 2013-10-21
@


1.13
log
@Type of verification used determines particle selection file name
@
text
@d32 1
a32 1
 [use-particles] = 0       ; Use:  (sorted particles == 0 ), (class verifyied == 1) (class verified & recheched == 2)
d49 1
a49 1
 ELSIF  ( [use-particles] == 2 )
d53 5
d309 1
a309 1
 EN D
@


1.12
log
@using_settings
@
text
@d3 1
a3 1
 ; SOURCE:      spider/docs/techs/recon1/Procs/bestim.spi      
d9 1
a9 1
 ; USAGE:       clean ; ./spider spi/dat @@bestim
d18 1
a18 1
 ;     or          ]    = 'views/prj###/sel_part_byv_best'  ; Selection & CCC files (if using verify) (one/view)
d29 4
a32 1
 [maxim] = -1      ; Max number of images/reference-view to retain (<0 == all)
d44 10
d93 1
a93 1
      [good_particles][view]          ; Listing file                (input)
d120 1
a120 1
          [good_particles][view]       ; Particle listing file        (input)
d161 1
a161 1
        [good_particles][view]             ; Listing file            (input)
d184 1
a184 1
      [good_particles][view]                ; Temp sorted listing file
@


1.11
log
@using_settings
@
text
@d13 2
a14 1
 ; INPUTS:  (Where *** denotes view   ### denotes group)
d16 4
a19 3
 ;  [sel_part]          = '../Alignment/sel_part_###'       ; Particle selection list    (one/group)
 ;  [ref_view_list]     = 'sel_proj'                        ; Projection/view list       (one)
 ;  [good_particles]    = 'views/prj***/sel_part_byv_good'  ; Selection & CCC files (if using verify) (one/view)
d21 5
a25 5
 ; OUTPUTS:  (Where *** denotes view. ### denotes group)
  ;  [sel_group_best]    = 'sel_group_best'                ; New group selection file      (one)
 ;  [sel_part_best]     = 'sel_part_best_###'              ; New particle selection files  (one/group)
 ;  [best_particles]    = 'views/prj***/sel_part_byv_best' ; Selection & CCC files         (one/view)
 ;  [parts_vsview_best] = 'views/parts_vsview_best'        ; Total # of good particles        (one/view)
d29 1
a29 1
 [maxim] = -1          ; Max number of images / reference view to retain (<0 == all)
@


1.10
log
@consolidated_filenames
@
text
@d6 2
d9 3
a11 2
 ; NOTE:        Continue with reconstruction following this limitation using:
 ;              <i><a href="recon.spi">recon.spi</a></i>
d13 12
a24 2
 ; USAGE:       clean ; ./spider spi/dat @@bestim
 
d27 1
a27 35
 [maxim] = -1        ; Max number of images per reference view to retain (<0 == all)

 ; ------------------------- Inputs -------------------------

 [sel_group]        = '../Alignment/sel_group'       ; Old group selection file   (one)

 [ref_view_list]    = 'sel_proj'                     ; Projection/view list       (one)

 [prj_dir]          = 'views/prj***'                 ; Projection/view directory  (one/view)

 ;[good_particles]  = 'views/prj***/goodsel'         ; Selection & CCC files      (one/view)
 ;[good_particles]  = '[prj_dir]/sel_part_byv_sort'  ; Selection & CCC files      (one/view)
  [good_particles]  = '[prj_dir]/sel_part_byv_good'  ; Selection & CCC files (if using verify) (one/view)

 ;  VIEW_WIN  GLOBAL_NUM  GRP_WIN    CCROT    MIRROR GRP_NUM  VIEW
 ;             used                   used

 [sel_part]         = '../Alignment/sel_part_***'    ; Particle selection list   (one/group)
 ;  WIN  MIC_NUM   MIC_WIN   GLOBAL_NUM
  
 ; ------------------------ Outputs ------------------------

 [sel_group_best]            = 'sel_group_best'               ; New group selection file      (one)

 [prj_dir]                   = 'views/prj***'                 ; View sub-directories          (one/view)

 [best_particles]            = '[prj_dir]/sel_part_byv_best'  ; Selection & CCC files         (one/view)

 [sel_part_best]             = 'sel_part_best_***'            ; New particle selection files  (one/group)
 ;  WIN   MIC_NUM               MIC_WIN   GLOBAL_NUM  GRP

 [sel_part_prev]             = '[sel_part]_prev_***'          ; Renamed old particle selection files (one/group)

![how_many_doc]              = 'how_many_best'                ; List of # of particles by view (one)
 [summary_parts_vsview_best] = 'views/parts_per_view_best'    ; Total # of good particles        (one/view)
d32 1
a32 1
   TR OFF                                ; Decrease results file output
d34 1
a34 1
   VB OFF                                ; Decrease results file output
d36 2
d39 1
a40 1

a41 1

a42 1

a44 1

d53 1
a53 1
   [summary_parts_vsview_best]
d55 1
a55 1
   [summary_parts_vsview_best]
d58 1
a58 1
   [ref_view_list]                        ; Doc file                    (input)
d60 1
a60 1
 IF ( [maxim] > 0) THEN
d71 1
a71 1
 [part-counter]   = 0                   ; File    (output) key counter
d75 1
a75 1
 DO [view]=1,[views]                    ; Loop over all views for this group
d77 2
a78 2
    UD N [view-parts]                   ; Get number of images for this view
      [good_particles][view]             ; Listing file                (input)
d83 1
a83 1
        [summary_parts_vsview_best]             ; File      (output)
d105 1
a105 1
          [good_particles][view]        ; Particle listing file        (input)
d130 1
a130 1
          [summary_parts_vsview_best]
d165 1
a165 1
      [summary_parts_vsview_best]
d192 1
a192 1
   [summary_parts_vsview_best]
d194 1
a194 1
   [summary_parts_vsview_best]
d196 1
a196 1
   [summary_parts_vsview_best]
d233 1
a233 3
      [sel_part][grp]            ; File    (input)
    
    ; If it exists, rename
d235 1
d237 1
a237 1
        \mv [sel_part][grp].$DATEXT   [sel_part_prev][grp].$DATEXT
d245 1
@


1.9
log
@rewrite_syntax_filenames
@
text
@d18 1
a18 1
 [group_list]         = '../Alignment/sel_group'       ; Old group selection file   (one)
d20 1
a20 1
 [view_list]          = 'sel_proj'                     ; Projection/view list       (one)
d22 1
a22 1
 [prj_dir]            = 'views/prj***'                 ; Projection/view directory  (one/view)
d24 3
a26 3
 ;[parts_by_view]     = 'views/prj***/goodsel'         ; Selection & CCC files      (one/view)
 ;[parts_by_view]     = '[prj_dir]/sel_part_byv_sort'  ; Selection & CCC files      (one/view)
  [parts_by_view]     = '[prj_dir]/sel_part_byv_good'  ; Selection & CCC files (if using verify) (one/view)
d28 2
a29 2
 ;   VIEW_WIN            GLOBAL_NUM  GRP_WIN    CCROT    MIRROR GRP_NUM  VIEW
 ;                       used                   used
d31 2
a32 2
 [apsh_sel_parts]     = '../Alignment/sel_part_***'    ; Particle selection list   (one/group)
 ;       WIN   MIC_NUM   MIC_WIN    GLOBAL_NUM
d36 1
a36 1
 [group_list_best]   = 'sel_group_best'                ; New group selection file      (one)
d38 1
a38 1
 [prj_dir]           = 'views/prj***'                  ; View sub-directories          (one/view)
d40 1
a40 1
 [best_by_view]      = '[prj_dir]/sel_part_byv_best'   ; Selection & CCC files         (one/view)
d42 2
a43 2
 [sel_part]          = 'sel_part_best_***'             ; New particle selection files  (one/group)
 ;  WIN   MIC_NUM       MIC_WIN   GLOBAL_NUM  GRP
d45 1
a45 4
 [sel_part_prev]     = '[sel_part]_prev_***'           ; Renamed old particle selection files (one/group)

![how_many_doc]      = 'how_many_best'                 ; List of # of particles by view (one)
 [part_per_proj_doc] = 'part_per_proj_best'            ; List of # of particles by view (one)
d47 3
d69 1
a69 1
   [group_list_best]
d71 1
a71 1
   [group_list_best]
d75 1
a75 1
   [part_per_proj_doc]
d77 1
a77 1
   [part_per_proj_doc]
d80 1
a80 1
   [view_list]                        ; Doc file                    (input)
d100 1
a100 1
      [parts_by_view][view]             ; Listing file                (input)
d105 1
a105 1
        [part_per_proj_doc]             ; File      (output)
d109 1
a109 1
        touch [best_by_view][view].$DATEXT
d127 1
a127 1
          [parts_by_view][view]        ; Particle listing file        (input)
d152 1
a152 1
          [part_per_proj_doc]
d168 1
a168 1
        [parts_by_view][view]             ; Listing file            (input)
d187 1
a187 1
      [part_per_proj_doc]
d191 1
a191 1
      [parts_by_view][view]                ; Temp sorted listing file
d199 1
a199 1
      [best_by_view][view]
d203 1
a203 1
      [best_by_view][view]
d205 1
a205 1
      [best_by_view][view]
d214 1
a214 1
   [part_per_proj_doc]
d216 1
a216 1
   [part_per_proj_doc]
d218 1
a218 1
   [part_per_proj_doc]
d227 1
a227 1
   [group_list]
d244 1
a244 1
      [apsh_sel_parts][grp]
d248 1
a248 1
      [apsh_sel_parts][grp]      ; File    (input)
d265 1
a265 1
      [sel_part][grp]            ; File  (output)
d267 1
a267 1
      [sel_part][grp]            ; File  (closed)
d271 1
a271 1
      [sel_part][grp]            ; File    (output)
d281 1
a281 1
      [sel_part][grp]            ; File  (input)
d290 1
a290 1
      [group_list_best]         ; File  (output)
d305 1
a305 1
   [group_list_best]         ; File  (output)
d307 1
a307 1
   [group_list_best]         ; File  (output)
d309 1
a309 1
   [group_list_best]         ; File  (closed)
@


1.8
log
@major overhaul for new protocol
@
text
@d1 97
a97 78
; LIMITS PARTICLES CORRESPONDING TO EACH REFERENCE PROJECTION
;
; ---------------------- Parameters ----------------------

[maxim] = -1   ; Max number of images per reference view to retain (<0==all)

; ------------------------- Inputs -------------------------

[group_list]       = '../Alignment/sel_group'             ; Group selection file

[view_list]     = '../Alignment/projlist'                 ; Listing of reference projections

[parts_by_view] = 'Views/prj{***[view]}/sortsel'          ; Selection & CCC files for each view
;[parts_by_view] = 'Views/prj{***[view]}/goodsel'          ; Selection & CCC files for each view
;       VIEWSLICE   GLOBPARTICLE    GRP_SLICE       CCROT      MIRROR_FLAG    GROUP_NUM      VIEWNUM
;                       used                        used

[apsh_grp_parts] = '../Alignment/apsh_grp_particles***'   ; Group particle list
;        APSHSLICE     MIC_SLICE     APSHGROUP      MICNUM       GLOBAL_NUM
;         copied         copied       copied        copied          used

; ------------------------ Outputs ------------------------

[best_by_view]       = 'Views/bestsel{***[view]}'         ; Selection & CCC files for each view

[sel_particles]      = 'avgd_particles_{***[grp]}'        ; Output file (one for each defocus group)
;       APSHSLICE     MIC_SLICE     APSHGROUP      MICNUM       GLOBALNUM

[sel_particles_prev] = '[sel_particles]_prev'             ; Renamed existing selection file

[how_many_doc]       = 'how_many-bestim'                  ; Listing # of particles in each view

[group_list_cclim]   = 'avgd_groups'                      ; Defocus groups selection file

; -------------------- END BATCH HEADER --------------------

MD
TR OFF                                ; Decrease results file output
MD
VB OFF                                ; Decrease results file output

FR L
[temp_parts_byview]tmpdoc_byview_incore
FR L
[temp_sorted_byview]tmpdoc_byview_sorted
FR L
[temp_combined]tmpdoc_combined
FR L
[temp_grouplist_unsorted]tmpdoc_bygrp_unsort{***[grp]}

; delete pre-existing files
DE
[group_list_cclim]
SD /      GROUP_NUM     AFTER_LIM     BEFORELIM      PERCENT
[group_list_cclim]
DE
[temp_combined]
DE
[how_many_doc]
SD /      AFTER_LIM     BEFORELIM      PERCENT
[how_many_doc]

UD N [views]                       ; Get number of views
[view_list]                        ; Doc file                    (input)

if([maxim].gt.0) then
    VM
    echo  'Keeping up to {*****[maxim]} particles from {***[views]} views' ; date
else
    VM
    echo  'Keeping all particles from {***[views]} views' ; date
endif

; initialize counters
[totview-before] = 0
[totview-after]  = 0
[part-counter]   = 0                       ; Output key counter
[zero]           = 0
a98 1
DO [view]=1,[views]                ; Loop over all views for this group
d100 1
a100 1
    [parts_by_view]                   ; Listing file                (input)
d102 4
a105 4
    IF ([view-parts] .LE. 0) THEN
        ; write to summary
        SD [view], [zero],[zero],[zero]
        [how_many_doc]
d107 4
a110 4
        ; create empty file
        VM
        touch [best_by_view].$DATEXT
        ; (Downstream batch files may look for this file.)
d112 1
a112 1
        CYCLE   ; skip to next view
d115 1
a115 1
    ; initialize in-core stack
d117 2
a118 2
    [temp_parts_byview]
    (7,[view-parts])
d120 25
a144 21
    ; retain only best particles
    IF ([view-parts] .GT. [maxim]) THEN
        if([maxim].gt.0) then
            DOC SORT
            [parts_by_view]              ; Particle listing file
            [temp_sorted_byview]         ; Temp sorted listing file
            (-4)                         ; Column to be sorted (CCROT)
            Y                            ; Compress & renumber keys

            DO LB2 [part-key2] = 1,[maxim]
                UD IC [part-key2], [view-slice2],[global-num2],[grp-slice2],[ccrot],[mirror],[grp-num2],[view-num2]
                [temp_sorted_byview]        ; Listing file                 (input)

                SD IC [part-key2], [view-slice2],[global-num2],[grp-slice2],[ccrot],[mirror],[grp-num2],[view-num2]
                [temp_parts_byview]

                [part-counter] = [part-counter] + 1

                SD [part-counter], [grp-slice2],[view-slice2],[grp-num2],[view-num2],[global-num2]
                [temp_combined]
            LB2
d146 3
a148 3
            [percent-kept] = ([maxim]/[view-parts])*100
            [totview-before] = [totview-before] + [view-parts]
            [totview-after] = [totview-after] + [maxim]
d150 3
a152 3
            ; write to summary
            SD [view], [maxim],[view-parts],[percent-kept]
            [how_many_doc]
d154 9
a162 5
            ; close docs
            UD ICE
            [temp_sorted_byview]          ; Temp sorted listing file
            DE
            [temp_sorted_byview]
d164 1
a164 3
            goto lb1
        endif
    ENDIF
d166 3
a168 5
;    ELSE
    ; retain all particles (if [maxim].le.0 OR [view-parts] .GT. [maxim])
    DO LB6 [part-key6] = 1,[view-parts]
        UD IC [part-key6], [view-slice6],[global-num6],[grp-slice6],[ccrot],[mirror],[grp-num6],[view-num6]
        [parts_by_view]             ; Listing file                 (input)
d170 1
a170 1
        SD IC [part-key6], [view-slice6],[global-num6],[grp-slice6],[ccrot],[mirror],[grp-num6],[view-num6]
d173 4
a176 3
        [part-counter] = [part-counter] + 1
        
        SD [part-counter], [grp-slice6],[view-slice6],[grp-num6],[view-num6],[global-num6]
d179 1
a179 1
    LB6
d185 1
a185 1
    ; write to summary
d187 1
a187 1
    [how_many_doc]
d189 1
a189 1
    ; close docs
d191 1
a191 1
    [parts_by_view]                ; Temp sorted listing file
d193 4
a196 3
    lb1   ; skip here if keeping subset of particles
    
    ; close docs
d198 2
a199 2
    [temp_parts_byview]
    [best_by_view]
d201 3
a203 3
    [temp_parts_byview]
    SD /      VIEWSLICE   GLOBPARTICLE    GRP_SLICE       CCROT      MIRROR_FLAG    GROUP_NUM      VIEWNUM
    [best_by_view]
d205 38
a242 38
    [best_by_view]
ENDDO
; end view-loop

vm
echo "Kept {*******[totview-after]} out of {*******[totview-before]} particles in {***[views]} views"

; close docs
[dummy] = -[views]
SD /           AFTER_LIM     BEFORELIM
[how_many_doc]
SD [dummy], [totview-after],[totview-before]
[how_many_doc]
SD E
[how_many_doc]
SD E
[temp_combined]


; GENERATE GROUP PARTICLE DOCS

vm
echo ; echo "Separating particles into groups" ; date

MD
VB ON

; initialize counters
[totgrp-before] = 0
[totgrp-after]  = 0

; get #groups
UD N [num-grps]
[group_list]

; loop through groups
DO LB7 [grp] = 1,[num-grps]
    ; get #particles before
d244 1
a244 1
    [apsh_grp_parts][grp]
d246 1
a246 1
    ; intersect group particle list with combined list
d248 4
a251 4
    [apsh_grp_parts][grp]      ; INPUT
    [temp_combined]            ; INPUT
    [temp_grouplist_unsorted]  ; OUTPUT
    (5)                        ; column# to intersect: global-num
d253 1
a253 1
    ; check if previous file exists
d255 1
a255 1
    [sel_particles]
d257 4
a260 4
    ; if it exists, rename
    IF([sel-exists].eq.1) THEN
        VM                                 ; Rename existing selection file 
        \mv [sel_particles].$DATEXT [sel_particles_prev].$DATEXT
d263 11
a273 6
    ; renumber keys & resort
    DOC SORT
    [temp_grouplist_unsorted]  ; INPUT
    [sel_particles]            ; OUTPUT
    (5)                        ; column# to sort: global#
    Y                          ; renumber keys?
d275 1
a275 1
    ; clean up
d277 1
a277 5
    [temp_grouplist_unsorted]
    SD /      APSHSLICE     MIC_SLICE     APSHGROUP      MICNUM       GLOBALNUM
    [sel_particles]
    SD E
    [sel_particles]
d279 1
a279 1
    ; get #particles after
d281 1
a281 1
    [sel_particles]
d283 1
a283 1
    ; increment counters
d288 1
a288 1
    ; write to summary
d290 1
a290 1
    [group_list_cclim]
d292 24
a315 23
    vm
    echo "Group #{***[grp]}: Kept {****[grpparts-after]} out of {****[grpparts-before]} particles"
LB7
; end group-loop

vm
echo ; echo "Done -- Assigned {*******[totgrp-after]} out of {*******[totgrp-before]} aligned particles into {***[num-grps]} groups" ; date ; echo

; close docs
DE
[temp_combined]
;DE
;[temp_grouplist_unsorted]

[dummy] = -[num-grps]
SD /           AFTER_LIM     BEFORELIM
[group_list_cclim]
SD [dummy], [totgrp-after],[totgrp-before]
[group_list_cclim]
SD E
[group_list_cclim]

EN D
d317 1
a317 2
; Modified 2012-05-02
;    2012-05-01 (trs) -- now required but added option to keep all particles
@


1.7
log
@simplify-rewrite
@
text
@d1 1
a1 1
; <html><head><title>Choose best images per direction</title></head><body><pre>
d3 3
a5 10
; SOURCE:      spider/docs/techs/recon/newprogs/bestim.spi      ArDean Leith
;
; PURPOSE:     Limits particles from each reference direction  
;
; NOTE:        Continue with reconstruction following this limitation using:
;              <i><a href="recon.spi">recon.spi</a></i>
;
; I/O PARAMETERS AND FILES ARE SET HERE:
;
; <b> -------------- Parameters -------------------------------------
d7 1
a7 1
[maxim] = 40                                      ; Max number of images / reference view to retain 
d9 1
a9 1
; -------------- Input files -------------------------------------
d11 1
a11 1
[defgrps]     = '../Alignment/sel_group'          ; Defocus groups selection file
d13 4
a16 1
[imgperview]  = 'df{***[grp]}/how_many'           ; Listing of  number of images for each view
d18 3
a20 1
[grp_sel_sel] = 'df{***[grp]}/ref_sel{***[view]}' ; Selection & CCC files for each view
d22 1
a22 1
; ----------------- Output files  -------------------------------------
d24 1
a24 2
[sel_particles]      = 'sel_particles_{***[grp]}' ; Output file (one for each defocus group)
;                                                 ; Contains the selected particle numbers
d26 2
a27 1
[sel_particles_prev] = '[sel_particles]_prev'     ; Renamed existing selection file
d29 1
a29 1
[defgrps_lim]        = 'sel_group_cclim'          ; Defocus groups selection file
d31 1
a31 1
[defgrps_lim_sorted] = 'sel_group_cclim_sorted'   ; Defocus groups selection file
d33 1
a33 1
[jnk_seltotal]       = 'df{***[grp]}/jnk_seltotal'  ; Temp file (DELETED)
d35 1
a35 1
; -------------- END BATCH HEADER -----------------------------------</b>
d42 8
a49 2
VM
echo  ' 'Choosing: {****[maxim]} particles from each reference direction ; echo  ' '     
d51 5
d57 127
a183 1
[defgrps_lim]                         ; Delete any existing defocus group sel. file
d185 2
a186 2
[totall] = 0
[totold] = 0
d188 10
a197 2
UD N [numgrps]                        ; Find number of defocus groups
[defgrps]                             ; Group selection file       (input)
a198 1
DO [numgrp] = 1,[numgrps]             ; Loop over all defocus groups
d200 1
a200 4
   UD [numgrp], [grp],[oldnum],[def]  ; Get current group number and particles 
   [defgrps]                          ; Group selection doc file     (input)
   
   [totold] = [totold] + [oldnum]     ; Total of old selected particles
d202 2
a203 2
   VM                                 ; Rename existing selection file 
   \mv [sel_particles].$DATEXT [sel_particles_prev].$DATEXT
d205 2
a206 2
   UD N [views]                       ; Get number of views
   [imgperview]                       ; Doc file                    (input)
d208 63
a270 2
   [totgrp] = 0
   [keyout] = 0                       ; Output key counter
d272 2
a273 96
   DO [view]=1,[views]                ; Loop over all views for this group

      UD N [images]                   ; Get number of images for this view
      [grp_sel_sel]                   ; Listing file                (input)

      IF ([images] .LE. 0) CYCLE
     
      IF ([images] .LE. [maxim]) THEN

         DO [image]=1,[images]
            UD IC [image],[part],[cc] ; Get particle number & CC
            [grp_sel_sel]             ; Listing file                 (input)

            [keyout] = [keyout] + 1

            SD [keyout],[part],[cc]   ; Save particle number & CC
            [sel_particles]           ; Overall limited listing file  (output)
         ENDDO

         [totgrp] = [totgrp] + [images]

         UD ICE
         [grp_sel_sel]                ; Temp sorted listing file

      ELSE

         DE
         [jnk_seltotal]               ; Temp sorted listing file
  
         DOC SORT
         [grp_sel_sel]                ; Particle listing file
         [jnk_seltotal]               ; Temp sorted listing file
         (2)                          ; Column to be sorted by (CCC for this view)
         Y                            ; Compress & renumber keys

         DO [image]=1,[maxim]
            UD IC [image],[part],[cc] ; Get particle number             (input)
            [jnk_seltotal]            ; Temp sorted listing file

            [keyout] = [keyout] + 1
            SD [keyout],[part],[cc]   ; Save particle number & CC
            [sel_particles]           ; Overall limited listing file   (output)
         ENDDO

         [totgrp] = [totgrp] + [maxim]

         UD ICE
         [jnk_seltotal]               ; Temp sorted listing file
      ENDIF
   ENDDO

   SD E
   [sel_particles]                     ; Limited listing file

   DE
   [jnk_seltotal]                     ; Temp listing working file

   [totall] = [totall] + [totgrp]

   VM
   echo  ' 'Group: {****[grp]}  Saved: {******[totgrp]}  Out of: {******[oldnum]}    

   SD [numgrp], [grp],[totgrp],[def]  ; Save group number and particles & defocus
   [defgrps_lim]                      ; Group selection doc file     (output)

ENDDO

SD E
[defgrps_lim]                            ; Finished with this file

FR L
[tmp1]order_select_jnk1                  ; Temp output file (deleted)

DOC SORT                                 ; DOC file sorting
[defgrps_lim]                            ; Defocus selection doc file   (input)
[tmp1]                                   ; Sorted Temp file             (output)
2                                        ; Sort column
Yes                                      ; Renumber keys

DE                                       ; Remove any existing output file
[defgrps_lim_sorted]

UD N, [nkey]                             ; Get number of keys in sorted     
[tmp1]                                   ; Temp file                  (input)

; Reverse sorting order of output doc file
DO [i]=1,[nkey]                          ; Loop over defocus groups 
   [grp]=[nkey]-[i]+1                    ; Reverse order

   ;            GROUP, PARTICLES, DEFOCUS              
   UD IC [grp], [grp],  [part],   [def]
   [tmp1]                                ; Doc file                  (input)

   SD    [i],   [grp],  [part],   [def]
   [defgrps_lim_sorted]                  ; Reverse sorted doc file  (output)
ENDDO
d275 11
d287 1
a287 18
[defgrps_lim_sorted]

UD ICE                                   ; Close doc files
[tmp1]
DE                                       ; Destroy temp. doc files
[tmp1]

[percent] = 100.0 * [totall] / [totold]
VM
echo  ' 'Overall Saved: {******[totall]}  Out of: {******[totold]} = {***[percent]}% 
VM
echo  ' '     

EN




d289 1
d291 2
@


1.6
log
@tapu: pasted in sorting step from dftotals
@
text
@d3 1
a3 1
; SOURCE:      bestim.spi      ArDean Leith
d5 1
a5 1
; PURPOSE:     Limits particles corresponding to each reference direction  
a6 2
; MASTER COPY: /usr1/spider/docs/techs/recon/newprogs/
;
d8 1
a8 1
;              <i><a href="deffsc.spi">deffsc.spi</a></i>
d14 1
a14 1
[maxim] = 40                                    ; Max number of images / reference view to retain 
d18 1
a18 2
FR G
[defgrps]sel_group                              ; Defocus groups selection file
d20 1
a20 2
FR G
[imgperview]df{***[grp]}/how_many               ; Listing of  number of images for each view
d22 1
a22 2
FR G
[grp_sel_sel]df{***[grp]}/select/sel{***[view]} ; Selection & CCC files for each view
d26 4
a29 3
FR G
[sel_particles]sel_particles_{***[grp]}         ; Output file (one for each defocus group)
;                                               ; Contains the selected particle numbers
d31 1
a31 2
FR G
[defgrps_lim]sel_group_cclim                    ; Defocus groups selection file
d33 1
a33 2
FR G
[defgrps_lim_sorted]sel_group_cclim_sorted  ; Defocus groups selection file
d35 1
a35 2
FR G
[jnk_seltotal]df{***[grp]}/jnk_seltotal         ; Temp file (DELETED)
d45 1
a45 3
echo  ' 'Limiting particles from each reference direction to: {****[maxim]} 
VM
echo  ' '     
d53 2
a54 2
UD N,[numgrps]                        ; Find number of defocus groups
[defgrps]                             ;                             (input)
d56 1
a56 1
DO LB1 [numgrp] = 1,[numgrps]         ; Loop over all defocus groups
d64 1
a64 1
   \mv [sel_particles].$DATEXT [sel_particles]_prev.$DATEXT
d72 1
a72 1
   DO LB2 [view]=1,[views]            ; Loop over all views for this group
d77 1
a77 1
      IF ([images] .LE. 0) GOTO LB2
d81 1
a81 1
         DO LB3[image]=1,[images]
d89 1
a89 1
         LB3
d107 1
a107 1
         DO LB4 [image]=1,[maxim]
d113 2
a114 2
            [sel_particles]            ; Overall limited listing file   (output)
         LB4
d121 1
a121 1
   LB2
d137 1
a137 1
LB1
d140 1
a140 1
[defgrps_lim]                         ; Finished
d145 1
a145 2
; DOC file sorting
DOC SORT
d158 1
a158 1
DO LB5 [i]=1,[nkey]                      ; Loop over defocus groups 
d167 1
a167 1
LB5
@


1.5
log
@changed output file, etc.
@
text
@d39 3
d151 36
@


1.4
log
@comment
@
text
@d5 1
a5 1
; PURPOSE:     Chooses highest CCC images for each reference view for one defocus group  
d9 1
a9 3
; NOTE:        To continue with another reconstruction following this limitation, rename
;              the [lim_seltotal] output file to: df{***[grp]}/seltotal before repeating
;              reconstruction starting with: 
d16 1
a16 1
[maxim] = 40                                 ; Max number of images / reference view to retain 
d21 1
a21 1
[defgrps]sel_group                           ; Defocus groups selection file
d24 1
a24 1
[imgperview]df{***[grp]}/how_many            ; Listing of  number of images for each view
d27 1
a27 1
[grp_sel_sel]df{***[grp]}/select/sel{***x10} ; Selection & CCC files for each view
d32 2
a33 1
[lim_seltotal]df{***[grp]}/limited_seltotal  ; New selection file for this defocus group
d36 4
a39 1
[jnk_seltotal]df{***[grp]}/jnk_seltotal      ; Temp file (deleted)
d48 8
d57 1
d64 7
a70 2
   UD [numgrp],[grp]                  ; Get current group number 
   [defgrps]                          ; Group selection file        (input)
d78 1
a78 1
   DO LB2 x10=1,[views]               ; Loop over all views for this group
d83 2
a84 2
      IF ([images] .LE. 0) GOTO LB1
      
a85 1
         VM                           ; No need to limit the images
d92 1
d94 1
a94 1
            [lim_seltotal]            ; Overall limited listing file  (output)
d114 1
a114 1
            UD IC [image],[part],[cc] ; Get particle number             (imput)
d119 1
a119 1
            [lim_seltotal]            ; Overall limited listing file   (output)
d130 1
a130 1
   [lim_seltotal]                     ; Limited listing file
d138 5
a142 1
   echo  ' 'Group: {****[grp]}  Particles: {******[totgrp]}    
d145 4
d150 1
a150 1
echo  ' 'Overall Particles: {******[totall]}    
d154 1
a154 1
RE
@


1.3
log
@added stacks, named variables
@
text
@d23 1
a23 1
[defgrps]sel_group                         ; Defocus groups selection file
d51 1
a51 1
DO LB1 [numgrp] = 1,[numgrps]  ; Loop over all defocus groups
@


1.2
log
@ bug if no image in a view
@
text
@d10 1
a10 1
;              the [lim_seltotal] output file to: df{***[defgrp]}/seltotal before repeating
d18 1
a18 1
[defgrp] = 1                                    ; Defocus group number
d20 1
a20 1
[maxim] = 40                                    ; Max number of images / reference view to retain 
d22 2
a23 1
; -------------- Input files -------------------------------------
d26 1
a26 1
[imgperview]df{***[defgrp]}/how_many            ; Listing of  number of images for each view
d29 1
a29 1
[grp_sel_sel]df{***[defgrp]}/select/sel{***x10} ; Selection & CCC files for each view
d34 1
a34 1
[lim_seltotal]df{***[defgrp]}/limited_seltotal  ; New selection file for this defocus group
d37 1
a37 1
[jnk_seltotal]df{***[defgrp]}/jnk_seltotal      ; Temp file (deleted)
d41 9
a49 2
MD 
VB OFF
d51 1
a51 2
UD N [views]                       ; Get number of views
[imgperview]
d53 2
a54 1
[keyout] = 0                       ; Output key counter
d56 2
a57 1
DO LB1 x10=1,[views]               ; Loop over all views for this group
d59 2
a60 2
   UD N [images]                   ; Get number of images for this view
   [grp_sel_sel]                   ; Listing file
d62 6
a67 1
   IF ([images] .LE. 0) GOTO LB1
d69 6
a74 2
   IF ([images] .LE. [maxim]) THEN
      VM                           ; No need to limit the images
d76 4
a79 3
      DO LB2 [image]=1,[images]
         UD IC [image],[part],[cc] ; Get particle number & CC
         [grp_sel_sel]             ; Listing file
d81 1
a81 4
         [keyout] = [keyout] + 1
         SD [keyout],[part],[cc]   ; Save particle number & CC
         [lim_seltotal]            ; Overall limited listing file
      LB2
d83 2
a84 2
      UD ICE
      [grp_sel_sel]                ; Temp sorted listing file
d86 1
a86 1
   ELSE
d88 2
a89 2
      DE
      [jnk_seltotal]               ; Temp sorted listing file
d91 24
a114 14
      DOC SORT
      [grp_sel_sel]                ; Particle listing file
      [jnk_seltotal]               ; Temp sorted listing file
      (2)                          ; Column to be sorted by (CCC for this view)
      Y                            ; Compress & renumber keys

      DO LB3 [image]=1,[maxim]
         UD IC [image],[part],[cc] ; Get particle number
         [jnk_seltotal]            ; Temp sorted listing file

         [keyout] = [keyout] + 1
         SD [keyout],[part],[cc]   ; Save particle number & CC
         [lim_seltotal]            ; Overall limited listing file
      LB3
d116 2
a117 2
      UD ICE
      [jnk_seltotal]               ; Temp sorted listing file
d119 4
a122 1
   ENDIF
d125 4
a128 5
SD E
[lim_seltotal]                     ; Limited listing file

DE
[jnk_seltotal]                     ; Temp listing working file
@


1.1
log
@Initial revision
@
text
@d7 1
a7 1
; MASTER COPY: /net/bali/usr1/spider/docs/techs/recon/newprogs/
d10 1
a10 1
;              the [lim_seltotal] output file to: df{***x77}/seltotal before repeating
d13 1
a13 1

d18 1
a18 1
x77 = 1                                    ; Defocus group number
d20 1
a20 1
x61 = 40                                   ; Max number of images / reference view to retain 
d25 1
a25 1
[imgperview]df{***x77}/how_many            ; Listing of  number of images for each view
d28 1
a28 1
[grp_sel_sel]df{***x77}/select/sel{***x10} ; Selection & CCC files for each view
d33 1
a33 1
[lim_seltotal]df{***x77}/limited_seltotal  ; New selection file for this defocus group
d36 1
a36 1
[jnk_seltotal]df{***x77}/jnk_seltotal      ; Temp file (deleted)
d43 1
a43 1
UD N x83                   ; Get number of views
d46 3
a48 1
x30 = 0                    ; Output key counter
d50 2
a51 1
DO LB1 x10=1,x83           ; Loop over all views for this group
d53 8
a60 5
   UD N x60                ; Get number of images for this view
   [grp_sel_sel]           ; Listing file
  
   IF (x60 .LE. x61) THEN
      VM                   ; No need to limit the images
d62 3
a64 7
      DO LB2 x66=1,x60
         UD IC x66,x50,x51 ; Get particle number & CC
         [grp_sel_sel]     ; Listing file

         x30 = x30 + 1
         SD x30,x50,x51    ; Save particle number & CC
         [lim_seltotal]    ; Overall limited listing file
d68 1
a68 1
      [grp_sel_sel]        ; Temp sorted listing file
d73 1
a73 1
      [jnk_seltotal]       ; Temp sorted listing file
d76 12
a87 12
      [grp_sel_sel]        ; Particle listing file
      [jnk_seltotal]       ; Temp sorted listing file
      (2)                  ; Column to be sorted by (CCC for this view)
      Y                    ; Compress & renumber keys

      DO LB3 x66=1,x61
         UD IC x66,x50,x51 ; Get particle number
         [jnk_seltotal]    ; Temp sorted listing file

         x30 = x30 + 1
         SD x30,x50,x51    ; Save particle number & CC
         [lim_seltotal]    ; Overall limited listing file
d91 1
a91 1
      [jnk_seltotal]       ; Temp sorted listing file
d97 1
a97 1
[lim_seltotal]             ; Limited listing file
d100 1
a100 1
[jnk_seltotal]             ; Temp listing working file
@

