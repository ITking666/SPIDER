head	1.27;
access;
symbols
	GPL_update:1.19
	pre_rewrite_2010:1.18
	pre_more_stack:1.18
	best-code:1.16
	no-named-regs:1.15
	pre_GPL:1.15
	tag_version1_0:1.15;
locks; strict;
comment	@# @;


1.27
date	2012.09.21.14.50.54;	author leith;	state Exp;
branches;
next	1.26;

1.26
date	2012.09.20.18.33.07;	author leith;	state Exp;
branches;
next	1.25;

1.25
date	2012.09.20.18.27.19;	author leith;	state Exp;
branches;
next	1.24;

1.24
date	2012.09.06.18.08.20;	author leith;	state Exp;
branches;
next	1.23;

1.23
date	2012.08.29.17.48.36;	author leith;	state Exp;
branches;
next	1.22;

1.22
date	2010.10.26.15.34.00;	author leith;	state Exp;
branches;
next	1.21;

1.21
date	2010.10.08.12.40.40;	author leith;	state Exp;
branches;
next	1.20;

1.20
date	2010.08.17.15.21.56;	author leith;	state Exp;
branches;
next	1.19;

1.19
date	2010.01.19.18.54.58;	author leith;	state Exp;
branches;
next	1.18;

1.18
date	2006.05.11.14.51.49;	author leith;	state Exp;
branches;
next	1.17;

1.17
date	2006.05.09.16.27.32;	author leith;	state Exp;
branches;
next	1.16;

1.16
date	2006.01.04.14.28.24;	author leith;	state Exp;
branches;
next	1.15;

1.15
date	2005.05.03.14.25.28;	author leith;	state Exp;
branches;
next	1.14;

1.14
date	2005.02.15.15.12.45;	author leith;	state Exp;
branches;
next	1.13;

1.13
date	2005.02.15.14.59.39;	author leith;	state Exp;
branches;
next	1.12;

1.12
date	2005.02.11.19.25.39;	author leith;	state Exp;
branches;
next	1.11;

1.11
date	2005.02.07.17.08.59;	author leith;	state Exp;
branches;
next	1.10;

1.10
date	2005.01.26.17.05.35;	author leith;	state Exp;
branches;
next	1.9;

1.9
date	2005.01.18.16.42.30;	author leith;	state Exp;
branches;
next	1.8;

1.8
date	2004.06.29.15.40.29;	author leith;	state Exp;
branches;
next	1.7;

1.7
date	2004.06.07.16.30.30;	author leith;	state Exp;
branches;
next	1.6;

1.6
date	2004.03.23.20.37.55;	author leith;	state Exp;
branches;
next	1.5;

1.5
date	2003.03.06.17.00.36;	author leith;	state Exp;
branches;
next	1.4;

1.4
date	2002.10.18.15.20.16;	author leith;	state Exp;
branches;
next	1.3;

1.3
date	2002.10.02.14.30.32;	author leith;	state Exp;
branches;
next	1.2;

1.2
date	2002.09.12.20.51.44;	author leith;	state Exp;
branches;
next	1.1;

1.1
date	2002.09.09.19.32.43;	author leith;	state Exp;
branches;
next	;


desc
@@


1.27
log
@cosmetic names
@
text
@([pixsiz],[iter],[ampenhance],[rm])
;
; <html><head><title>Merges groups at end of each refinement iteration</title></head><body><pre>
;
; SOURCE: spider/docs/techs/recon/newprogs/mergegroups.pam
;         New                                ArDean Leith  Nov 2000
;         Enhance                            ArDean Leith  Apr 2005
;         CofG centering now done here       ArDean Leith  Sep 2010
;         Ampl. enhancement moved out        ArDean Leith  Oct 2010
;         FSC, pixsiz                        ArDean Leith  Aug 2012
;
; PURPOSE: Consolidates goup volumes with CTF correction at end of each 
;          iteration into overeall volumes. Filters to limit resolution.
;          (This is not done in parallel).
;
; CALLED FROM: pub_refine  <a href="./pub_refine.pam">pub_refine.pam</a>
;
; INPUT REGISTERS:
;    [pixsiz]                        Pixel size        
;    [iter]                          Refinement step iteration counter  
;    [ampenhance]                    Flag to use amplitude enhancement  
;    [rm]                            Radius of object 
;
; '##' denotes iteration,  '##+' denotes next iteration,  '***' denotes group
; INPUT FILES:
;    [sel_group]                     input/sel_group      List of groups                
;    [temp_ctf_file_template]        work/ctf***          3D CTF files
;    [next_group_vol_template]       work/vol_##          Group volume    
;    [next_group_vol_template]_sub1  work/vol_##_sub1     Group volume, deleted at end   
;    [next_group_vol_template]_sub2  work/vol_##_sub2     Group volume, deleted at end 
;    [mask]                          input/mask           (Optional) Mask from original input volume 

; OUTPUT FILES:
;    [next_val]                      final/val##          Unfiltered volume
;    [next_vol]_sub1                 final/vol##_sub1     Unfiltered volume - subset 1
;    [next_vol]_sub2                 final/vol##_sub2     Unfiltered volume - subset 2
;    [next_vol]_filtered             final/vol##_filtered Filtered volume
;    [next_vol]                      final/vol##          Shifted, filtered volume
;    [next_fsc]                      final/fscdoc##       Resolution doc.
;    [enhance_doc]                   work/enhance_doc_##+ (Optional) Ampl filter doc. file
;    [next_val]_amps                 final/val##+_amps    (Optional) Ampl enhanced vol., unfiltered
;;
;.......................................................................

 ; All defocus groups must be present here for "TF CTS" use!

 [next-iter] = [iter] + 1          ; Next iteration

 TF CTS                            ; CTF Correction
   [next_group_vol_template]       ; Overall group volumes             (input)
   [sel_group]                     ; Group selection file              (input)
   [temp_ctf_file_template]        ; 3D CTF files                      (input)
   3                               ; SNR
   [next_val]                      ; Overall CTF'd volume              (output)

 TF CTS                            ; CTF Correction
   [next_group_vol_template]_sub1  ; Subset 1 group volumes            (input)
   [sel_group]                     ; Group selection file              (input)
   [temp_ctf_file_template]        ; 3D CTF files                      (input)
   3                               ; SNR
   [next_vol]_sub1                 ; CTF'd volume - subset 1           (output)

 TF CTS                            ; CTF Correction
   [next_group_vol_template]_sub2  ; Subset 2 group volumes            (input)
   [sel_group]                     ; Group Selection File              (input)
   [temp_ctf_file_template]        ; 3D CTF files                      (input)
   3                               ; SNR
   [next_vol]_sub2                 ; CTF'd volume - subset 2           (output)

 ; Resolution calculation
 DE
   [next_fsc]                      ; FSC doc file                      (removed) 

 FSC [half],[spfreq],[res]         ; Find phase residual &  shell correl.
   [next_vol]_sub1                 ; Volume - subset 1                  (input)
   [next_vol]_sub2                 ; Volume - subset 2                 (input)
   0.5,[rm]                        ; Shell width
   [pixsiz]                        ; Pixel size
   [next_fsc]                      ; FSC doc file                      (output)
   *                               ; No Gnuplot file

 VM
   echo " Iteration: {**[iter]}  Resolution:  {%f6.2%[res]}" 

 [gr] = 0                          ; Defocus group is zero now (none)
 SD [iter], [iter],[gr],[res]      ; Save in doc file
   [iter_resol]                    ; Resolution doc file             (output)

 IF ([ampenhance] .EQ. 0) THEN     
    ; Usual case. No amplitude enhancement.  Filter to limit resolution

    IF([spfreq] .GT. 0.35)[spfreq] = 0.4 ; Limits pass-band

    [stop-band] = [spfreq]+0.15    ; Stop band frequency

    ; Filter output volume to limit resolution
    FQ                             ; Quick filter          
      [next_val]                   ; CTF'd reconstructed volume       (input)
      [next_vol]_filtered          ; Filtered volume                  (output)
      7                            ; Butterworth Low pass filter
      [spfreq],[stop-band]         ; Pass-band and stop-band freq.

 ELSE                               
    ; Apply amplitude enhancement filter and filter to limit resolution
    @@enhance([p69],[pixsiz],[next-iter],[spfreq])  
      [next_val]                   ; CTF'd reconstructed volume       (input)
      [next_vol]_filtered          ; Filtered volume                  (output)

 ENDIF

 ; Find center of gravity of overall filtered volume
 CG PH [unused],[unused],[unused],[xcg],[ycg],[zcg]  
   [next_vol]_filtered             ; Filtered volume                  (input)

 ; Shift filtered vol to its Center of Gravity
 SH F                              ; Shift filtered vol 
   [next_vol]_filtered             ; Filtered volume                  (input)
   [next_vol]                      ; Shifted filtered volume          (output)
   -[xcg],-[ycg],-[zcg]            ; Shift distances for CofG
 
 VM                                ; Delete files to save space
   \rm [next_group_vol_template]_sub1* [next_group_vol_template]_sub2*   

 VM
   echo -n " Iter: {**[iter]}"   Shift: -{%F4.1%[xcg]},-{%F4.1%[ycg]},-{%F4.1%[zcg]} ; date '+ Time: %x  %X' 

 MY FL
 RE

; </body></pre></html>
@


1.26
log
@cosmetic
@
text
@d35 2
a37 2
;    [next_vol]_sub1                 final/vol##_sub1     Filtered volume - subset 1
;    [next_vol]_sub2                 final/vol##_sub2     Filtered volume - subset 2
d42 1
a42 1
;
@


1.25
log
@fsc softmask
@
text
@d26 6
a31 6
;    [sel_group]                     input/sel_group                List of groups                
;    [temp_ctf_file_template]        work/ctf***                    3D CTF files
;    [next_group_vol_template]       work/defgrp***/vol_##          Group volume    
;    [next_group_vol_template]_sub1  work/defgrp***/vol_##_sub1     Group volume, deleted at end   
;    [next_group_vol_template]_sub2  work/defgrp***/vol_##_sub2     Group volume, deleted at end 
;    [mask]                          input/mask  (Optional)         Mask from original input volume 
d34 8
a41 8
;    [next_val]                      final/val##                    Unfiltered volume
;    [next_vol]_filtered             final/vol##_filtered           Filtered volume
;    [next_vol]_sub1                 final/vol##_sub1               Filtered volume - subset 1
;    [next_vol]_sub2                 final/vol##_sub2               Filtered volume - subset 2
;    [next_vol]                      final/vol##                    Shifted, filtered volume
;    [next_fsc]                      final/fscdoc##                 Resolution doc.
;    [enhance_doc]                   work/enhance_doc_##+  (Optional) Ampl filter doc. file
;    [next_val]_amps                 final/val##+_amps     (Optional) Ampl enhanced vol., unfiltered
@


1.24
log
@[sel_group_sorted] --> [sel_group]
@
text
@d1 1
a1 1
([pixsiz],[iter],[ampenhance],[radius])
d19 4
a22 4
;    [pixsiz]                               Pixel size        
;    [iter]                                 Refinement step iteration counter  
;    [ampenhance]                           Flag to use amplitude enhancement  
;    [radius]                               Radius of object 
d24 1
a24 1
;  '##' denotes iteration,  '##+' denotes next iteration,  '***' denotes group
d39 1
a39 1
;    [next_fsc]                      final/fsc##                    Resolution doc.
d45 1
a45 1
  ; All defocus groups must be present here for "TF CTS" use!
d49 1
a49 1
 TF CTS                            ; Transfer Function - CTF Correction
d56 1
a56 1
 TF CTS                            ; Transfer Function - CTF Correction
d63 1
a63 1
 TF CTS                            ; Transfer Function - CTF Correction
a69 9
 @@softmask([radius])               ; Gaussian mask for resolution volumes
   [next_vol]_sub1                 ; Reconstructed group vol - subset 1 (output)
   [next_vol]_sub2                 ; Reconstructed group vol - subset 2 (output)
   _13                             ; Inline mask volume         (output)
   [next_vol]_sub1                 ; Reconstructed group vol - subset 1 (output)
   [next_vol]_sub2                 ; Reconstructed group vol - subset 2 (output)
 DE                                ; Delete incore mask volume
   _13                             ; Inline file no longer needed       (removed)

d77 1
a77 1
   0.5                             ; Shell width
@


1.23
log
@FSC, pixsiz
@
text
@d26 1
a26 1
;    [sel_group_sorted]              input/sel_group_sorted         Sorted list of groups                
d39 1
a39 1
;    [next_dres]                     final/dres##                   Resolution doc.
d51 1
a51 1
   [sel_group_sorted]              ; Group selection file              (input)
d58 1
a58 1
   [sel_group_sorted]              ; Group selection file              (input)
d65 1
a65 1
   [sel_group_sorted]              ; Group Selection File              (input)
d81 1
a81 1
   [next_dres]                     ; FSC doc file                      (removed) 
d88 1
a88 1
   [next_dres]                     ; FSC doc file                      (output)
@


1.22
log
@Removed more enhancement only code & cosmetic
@
text
@d1 1
a1 1
([freq],[iter],[ampenhance])
d6 5
a10 8
;         New                                  ArDean Leith  Nov 2000
;         saveresp                             ArDean Leith  Jan 2005
;         Enhance                              ArDean Leith  Apr 2005
;         []                                   ArDean Leith  Dec 2005
;         Filenames                            ArDean Leith  Dec 2009
;         Echo format                          ArDean Leith  Aug 2010
;         CofG centering now done here         ArDean Leith  Sep 2010
;         Ampl. enhancement moved out          ArDean Leith  Oct 2010
d19 1
a19 1
;    [freq]                                 Nyquist frequency for filtering        
d22 1
d45 1
a45 1
   ; All defocus groups must be present here for "TF CTS" use!
d47 1
a47 1
   [next-iter]=[iter] + 1                   ; Next iteration
d49 80
a128 69
   TF CTS                                   ; Transfer Function - CTF Correction
   [next_group_vol_template]                ; Overall group volumes             (input)
   [sel_group_sorted]                       ; Group selection file              (input)
   [temp_ctf_file_template]                 ; 3D CTF files                      (input)
   (3)                                      ; SNR
   [next_val]                               ; Overall CTF'd volume              (output)

   TF CTS                                   ; Transfer Function - CTF Correction
   [next_group_vol_template]_sub1           ; Subset 1 group volumes            (input)
   [sel_group_sorted]                       ; Group selection file              (input)
   [temp_ctf_file_template]                 ; 3D CTF files                      (input)
   (3)                                      ; SNR
   [next_vol]_sub1                          ; CTF'd volume - subset 1           (output)

   TF CTS                                   ; Transfer Function - CTF Correction
   [next_group_vol_template]_sub2           ; Subset 2 group volumes            (input)
   [sel_group_sorted]                       ; Group Selection File              (input)
   [temp_ctf_file_template]                 ; 3D CTF files                      (input)
   (3)                                      ; SNR
   [next_vol]_sub2                          ; CTF'd volume - subset 2           (output)

   DE
   [next_dres]                              ; FSC doc file                      (removed) 

   ; Resolution calculation
   RF 3 [p69],[spfreq]                      ; Phase Residual & FSC
   [next_vol]_sub1                          ; Volume - subset 1                  (input)
   [next_vol]_sub2                          ; Volume - subset 2                 (input)
   (0.5)                                    ; Ring width
   (0.2,2.0)                                ; Scale factor
   C                                        ; Missing cone/wedge angle 
   (90.0)                                   ; Maximum tilt angle
   (3)                                      ; Factor for noise comparison
   [next_dres]                              ; FSC doc file                      (output)

   [grp] = 0                                ; Defocus group is zero now (none)
   @@saveresp([freq],[iter],[grp],[spfreq])  ; Record resolution in doc file
   [dbpr_resol]                             ; Resolution doc file               (output)

   IF ([ampenhance] .EQ. 0) THEN            ; No amplitude enhancement (Usual case)
      ; Filter to limit resolution

      IF([spfreq] .GT. 0.35)[spfreq] = 0.4  ; Limits pass-band
      [stop-band] = [spfreq]+0.15           ; Stop band frequency

      ; Filter output volume to limit resolution
      FQ                                    ; Quick filter          
      [next_val]                            ; CTF'd volume                     (input)
      [next_vol]_filtered                   ; Filtered volume                  (output)
      (7)                                   ; Butterworth Low pass filter
      [spfreq],[stop-band]                  ; Pass-band and stop-band freq.

   ELSE                                     ; Use amplitude enhancement
      ; Apply amplitude enhancement filter and filter to limit resolution
      @@enhance([p69],[freq],[next-iter],[spfreq])  
      [next_val]                            ; Reconstructed volume             (input)
      [next_vol]_filtered                   ; Filtered volume                  (output)

   ENDIF

   ; Find center of gravity of overall filtered volume
   CG PH [unused],[unused],[unused],[xcg],[ycg],[zcg]  
   [next_vol]_filtered                      ; Filtered volume                  (input)

   ; Shift filtered vol to its CofG
   SH F                                     ; Shift filtered vol 
   [next_vol]_filtered                      ; Filtered volume                  (input)
   [next_vol]                               ; Shifted filtered volume          (output)
   -[xcg],-[ycg],-[zcg]                     ; Shift distances for CofG
d130 1
a130 1
   VM                                       ; Delete files to save space
d133 1
a133 1
   VM
d136 2
a137 2
   MY FL
   RE
@


1.21
log
@Ampl. enhancement moved out
@
text
@d6 8
a13 8
;         New                               ArDean Leith  Nov 2000
;         saveresp                          ArDean Leith  Jan 2005
;         Enhance                           ArDean Leith  Apr 2005
;         []                                ArDean Leith  Dec 2005
;         Filenames                         ArDean Leith  Dec 2009
;         Echo format                       ArDean Leith  Aug 2010
;         COG centering done here           ArDean Leith  Sep 2010
;         Ampl. enhancement moved out       ArDean Leith  Sep 2010
d15 3
a17 1
; PURPOSE: Consolidates CTF data at end of each iteration, not in ||
d22 1
a22 1
;    [freq]                                 Nyquist frequency        
d26 1
a26 1
;  '##' denotes iteration,  '##+' denotes next iteration, and '***' denotes group
d28 6
a33 7
;    input/sel_group_sorted                [sel_group_sorted] 
;    work/ctf***                           [temp_ctf_file_template] (Template for 3D CTF files)
;    work/defgrp***/vol##                  [next_group_vol]
;    work/defgrp***/vol_##                 [next_group_vol_template]      (deleted at end)  
;    work/defgrp***/vol_##_sub1            [next_group_vol_template]_sub1 (deleted at end)  
;    work/defgrp***/vol_##_sub2            [next_group_vol_template]_sub2 (deleted at end)
;    input/mask  (Optional)                [mask]              (Optional Mask from input file)
d36 8
a43 8
;    final/val##                           [next_val]          (Unfiltered volume)
;    final/vol##_filtered                  [next_vol]_filtered (Filtered volume)
;    final/vol##                           [next_vol]          (Shifted, filtered volume)
;    final/vol##_sub1                      [next_vol]_sub1     (Filtered volume - subset 1)
;    final/vol##_sub2                      [next_vol]_sub2     (Filtered volume - subset 2)
;    final/dres##                          [next_dres]         (Resolution doc)
;    work/enhance_doc_##+  (Optional)      [enhance_doc]       (Ampl filter doc file)
;    final/val##+_amps     (Optional)      [next_val]_amps     (Ampl enhanced vol., unfiltered)
a48 1
   [ring] = 0.5                             ; FSC ring width
d51 4
a54 4
   TF CTS                                   ; Transfer Function - CTF correction
   [next_group_vol_template]                ; Template for 3D volumes             (input)
   [sel_group_sorted]                       ; Group Selection File                (input)
   [temp_ctf_file_template]                 ; Template for 3D CTF file            (input)
d56 1
a56 1
   [next_val]                               ; Unfiltered CTF'd volume             (output)
d58 4
a61 4
   TF CTS                                   ; Transfer Function - CTF correction
   [next_group_vol_template]_sub1           ; Template for 3D sub volume          (input)
   [sel_group_sorted]                       ; Group Selection File                (input)
   [temp_ctf_file_template]                 ; Template for 3D CTF files           (input)
d63 1
a63 1
   [next_vol]_sub1                          ; Volume - subset 1                   (output)
d65 4
a68 4
   TF CTS                                   ; Transfer Function - CTF correction
   [next_group_vol_template]_sub2           ; Template for 3D sub volumes        (input)
   [sel_group_sorted]                       ; Group Selection File                (input)
   [temp_ctf_file_template]                 ; Template for 3D CTF files           (input)
d70 1
a70 1
   [next_vol]_sub2                          ; Volume - subset 2                   (output)
d73 1
a73 1
   [next_dres]                              ; FSC doc file                        (removed) 
d77 2
a78 2
   [next_vol]_sub1                          ; Volume - subset 1                   (input)
   [next_vol]_sub2                          ; Volume - subset 2                   (input)
d84 1
a84 1
   [next_dres]                              ; FSC doc file                        (output)
d86 3
a88 8
   [grp] = 0                               ; Defocus group is zero now (none)
   @@saveresp([freq],[iter],[grp],[spfreq]) ; Record resolution in doc file
   [dbpr_resol]                            ; Resolution doc file                  (output)

   IF ([spfreq] .GT. 0.35) [spfreq] = 0.4  ; Limits pass-band
   [stop-band]= [spfreq]+0.15              ; Stop band frequency
   [filter-limit]=int([p69]*[ring])        ; Filter limit
   [filter-limit]                          ; Echo value to results 
d90 5
a94 1
   IF ([ampenhance] .EQ. 0) THEN           ; No amplitude enhancement (Normal case)
d97 5
a101 5
      FQ                                   ; Quick filter          
      [next_val]                           ; CTF'd volume                     (input)
      [next_vol]_filtered                  ; Filtered volume                  (output)
      (7)                                  ; Butterworth Low pass filter
      [spfreq],[stop-band]                 ; Pass-band and stop-band freq.
d103 1
a103 2
   ELSE                                    ; Use amplitude enhancement
 
d105 3
a107 3
      @@enhance([filter-limit],[freq],[next-iter],[spfreq],[stop-band])  
      [next_val]                           ; Reconstructed volume             (input)
      [next_vol]_filtered                  ; Filtered volume                  (output)
d111 1
a111 1
   ; Find center of gravity of the preshift volume
d113 1
a113 1
   [next_vol]_filtered                     ; Filtered volume                  (input)
d115 7
a121 6
   SH F                                    ; Shift filtered vol to its CofG
   [next_vol]_filtered                     ; Filtered volume                  (input)
   [next_vol]                              ; Shifted filtered volume          (output)
   -[xcg],-[ycg],-[zcg]                    ; Shift distances

   VM                                      ; Saves space
d129 1
@


1.20
log
@echo format
@
text
@d5 9
a13 7
; SOURCE: spider/docs/techs/recon/newprogs/ mergegroups.pam
;         new                         ArDean Leith  Nov 2000
;         saveresp                    ArDean Leith  Jan 2005
;         enhance                     ArDean Leith  Apr 2005
;         []                          ArDean Leith  Dec 2005
;         filenames                   ArDean Leith  Dec 2009
;         Echo format                 ArDean Leith  Aug 2010
d20 3
a22 3
;    [freq]                          Nyquist frequency        
;    [iter]                          Refinement step iteration counter  
;    [ampenhance]                    Flag to use amplitude enhancement  
d24 1
d27 6
a32 6
;    work/ctf***                           [temp_ctf_file_template] Template for 3D CTF files
;    work/defgrp{***grp}/vol{**iter}       [next_group_vol]
;    work/defgrp{***grp}/vol_{**iter}      [next_group_vol_template]      (deleted at end)  
;    work/defgrp{***grp}/vol_{**iter}_odd  [next_group_vol_template]_odd  (deleted at end)  
;    work/defgrp{***grp}/vol_{**iter}_even [next_group_vol_template]_even (deleted at end)
;    input/mask                            [mask]  (Mask created from input file)
d35 8
a42 7
;    final/val{**iter}                     [next_val]      (Unfiltered volume)
;    final/vol{**iter}                     [next_vol]      (Filtered volume)
;    final/vol{**iter}_odd                 [next_vol]_odd  (Filtered volume)
;    final/vol{**iter}_even                [next_vol]_even (Filtered volume)
;    final/dres{**iter}                    [next_dres]     (Resolution doc)
;    work/enhance_doc     ???              [enhance_doc]   (Enhancement document)
;                         ???              [next_val]_amps (Amplitude-enhanced volume, unfiltered)
d48 2
a49 2
   [ring] = 0.5                  ; FSC ring width
   [next-iter]=[iter] + 1        ; Next iteration
d51 20
a70 20
   TF CTS                        ; Transfer Function - CTF correction
   [next_group_vol_template]     ; Template for 3D volumes               (input)
   [sel_group_sorted]            ; Group Selection File                  (input)
   [temp_ctf_file_template]      ; Template for 3D CTF file              (input)
   (3)                           ; SNR
   [next_val]                    ; Unfiltered CTF'd volume               (output)

   TF CTS                        ; Transfer Function - CTF correction
   [next_group_vol_template]_odd ; Template for 3D odd volumes           (input)
   [sel_group_sorted]            ; Group Selection File                  (input)
   [temp_ctf_file_template]      ; Template for 3D CTF files             (input)
   (3)                           ; SNR
   [next_vol]_odd                ; Odd volume                            (output)

   TF CTS                        ; Transfer Function - CTF correction
   [next_group_vol_template]_even ; Template for 3D even volumes         (input)
   [sel_group_sorted]            ; Group Selection File                  (input)
   [temp_ctf_file_template]      ; Template for 3D CTF files             (input)
   (3)                           ; SNR
   [next_vol]_even               ; Even output volume                    (output)
d73 1
a73 1
   [next_dres]                   ; Resolution output doc file 
d76 9
a84 9
   RF 3 [p69],[spfreq]           ; Phase Residual & Fourier shell correlation
   [next_vol]_odd                ; Odd volume                           (input)
   [next_vol]_even               ; Even volume                          (input)
   (0.5)                         ; Ring width
   (0.2,2.0)                     ; Scale factor
   C                             ; Missing cone/wedge angle 
   (90.0)                        ; Maximum tilt angle
   (3)                           ; Factor for noise comparison
   [next_dres]                   ; Resolution doc file                  (output)
d88 1
a88 1
   [dbpr_resol]                            ; Resolution doc file       (output)
d93 1
a93 1
   [filter-limit]                          ; diagnostic
d95 1
a95 1
   IF ([ampenhance] .EQ. 1) THEN    ; Use amplitude enhancement
d97 13
a109 2
      DE                            ; Delete 
      [enhance_doc]                 ; Output enhancement document file
a110 31
      ; Generate amplitude enhancement curve 
      @@enhance([filter-limit],[freq],[next-iter]) ; Filter limit, Max. spatial frequency, Next iter.
      [next_val]                    ; Input volume

      FD                            ; Filter using enhancement doc. file
      [next_val]                    ; Input volume
      [next_val]_amps               ; Output amplitude-enhanced volume, unfiltered
      [enhance_doc]                 ; Input enhancement document file

      FQ                            ; Quick Filter          
      [next_val]_amps               ; Input file (Created above)   
      [next_vol]                    ; Output volume, ampl enhanced and filtered
      (7)                           ; Butterworth low pass filter
      [spfreq],[stop-band]          ; Pass-band and stop-band frequency
      
      IQ FI [masked]                ; See if mask file exists
      [mask]                        ; Mask created from ribosome-translocon

      IF ([masked] .GE. 1) THEN     ; Use mask file
         MM C                       ; Mask multiply to eliminate high freq. noise
         [mask]                     ; Mask created from ribosome-translocon
         [next_vol]                 ; Volume for next iteration
      ENDIF

   ELSE
      ; Filter output volume to limit the resolution
      FQ                            ; Quick Filter          
      [next_val]                    ; Input file (Created above)   - val
      [next_vol]                    ; Creates filtered volume, used on next iter.
      (7)                           ; Butterworth Low pass filter
      [spfreq],[stop-band]          ; Pass-band and stop-band frequency
d113 11
a123 2
   VM                               ; Saves space for tests - grp/vol!.
   \rm [next_group_vol_template]_odd* [next_group_vol_template]_even*   
d126 1
a126 1
   echo -n " Merged groups for iteration: {**[iter]}" ; date '+ Time: %x  %X'
@


1.19
log
@simplify-rewrite
@
text
@d5 8
a12 7
; SOURCE:  mergegroups.pam       ArDean Leith                 Nov 2000
;                                saveresp                     Jan 2005
;                                enhance                      Apr 2005
;                                []                           Dec 2005
;                                filenames                    Dec 2009
; MASTER COPY: spider/docs/techs/recon/newprogs/
; 
d18 3
a20 3
;    [freq]                     Nyquist frequency        
;    [iter]                     Refinement step iteration counter  
;    [ampenhance]               Flag to use amplitude enhancement  
d91 1
a91 1
   IF ([ampenhance] .EQ. 1) THEN           ; Use amplitude enhancement
d93 2
a94 2
      DE                                   ; Delete 
      [enhance_doc]                        ; Output enhancement document file
d106 1
a106 1
      [next_val]_amps               ; Input file (Created above)   - val
d133 1
a133 3
   echo " Merged groups for iteration: {**[iter]}"
   VM
   date '+ Time: %x  %X'
@


1.18
log
@nochange
@
text
@d5 6
a10 5
; SOURCE:  mergegroups.pam       ArDean Leith   Nov 2000
;                                saveresp       Jan 2005
;                                enhance        Apr 2005
;                                []             Dec 2005
; MASTER COPY: /net/bali/usr1/spider/docs/techs/recon/programs/
d22 1
a22 1
;    input/order_select_sort               [sorted_order_select]
d36 2
a37 2
;    work/enhance_doc     ???              [enhance_doc]   (enhancement document)
;                         ???              [next_val]_amps (amplitude-enhanced volume, unfiltered)
d48 2
a49 2
   [sorted_order_select]         ; Group Selection File                  (input)
   [temp_ctf_file_template]      ; Template for 3D ctf file - work/ctf   (input)
d55 2
a56 2
   [sorted_order_select]         ; Group Selection File                  (input)
   [temp_ctf_file_template]      ; Template for 3D ctf files - work/ctf  (input)
d58 1
a58 1
   [next_vol]_odd                ; Odd volume                           (output)
d62 2
a63 2
   [sorted_order_select]         ; Group Selection File                  (input)
   [temp_ctf_file_template]      ; Template for 3D ctf files - work/ctf  (input)
d79 1
a79 1
   [next_dres]                   ; Resolution doc file - dres_iter     (output)
d81 1
a81 1
   [grp] = 0                     ; Defocus group is zero now (none)
d83 1
a83 1
   [dbpr_resol]                            ; Output file                        (output)
d92 2
a93 2
      DE                            ; Delete 
      [enhance_doc]                 ; Output enhancement document file
@


1.17
log
@ampenhance bug
@
text
@d95 1
a95 1
      @@enhance[[filter-limit],[freq],[next-iter]] ; Filter limit, Max. spatial frequency, Next iter.
@


1.16
log
@uses named registers
@
text
@d89 1
a89 1
   IF ([ampenhance] .EQ. 1) THEN            ; Use amplitude enhancement
@


1.15
log
@filter limit for enhance.pam added
@
text
@d1 1
a1 1
(x14,x76,x90)
d8 1
d16 3
a18 3
;    x14                     Nyquist frequency        
;    x76                     Refinement step iteration counter  
;    x90                     Flag to use amplitude enhancement  
d42 2
a43 2
   x50 = 0.5                     ; FSC ring width
   x86 = x76 + 1                 ; Next iteration
d70 1
a70 1
   RF 3 x69,x37                  ; Phase Residual & Fourier shell correlation
d80 8
a87 8
   x77 = 0                       ; Defocus group is zero now (none)
   @@saveresp(x14,x76,x77,x37)    ; Record resolution in doc file
   [dbpr_resol]                  ; Output file                        (output)

   IF (x37 .GT. 0.35) x37 = 0.4     ; Limits pass-band
   x38 = x37 + 0.15                 ; Stop band frequency
   x35 = int(x69*x50)               ; Filter limit
   x35  ; diagnostic
d89 1
a89 1
   IF (x90 .EQ. 1) THEN             ; Use amplitude enhancement
d95 1
a95 1
      @@enhance[x35,x14,x86]         ; Filter limit, Max. spatial frequency, Next iter.
d107 1
a107 1
      x37,x38                       ; Pass-band and stop-band frequency
d109 1
a109 1
      IQ FI x11                     ; See if mask file exists
d112 1
a112 1
      IF (x11 .GE. 1) THEN          ; Use mask file
d124 1
a124 1
      x37,x38                       ; Pass-band and stop-band frequency
d131 1
a131 1
   echo " Merged groups for iteration: {**x76}"
@


1.14
log
@x52 not passed in anymore (unused)
@
text
@d7 1
d41 1
d85 2
d94 1
a94 1
      @@enhance[x69,x14,x86]         ; Filter limit, Max. spatial frequency, Next iter.
@


1.13
log
@comments only
@
text
@d1 1
a1 1
(x14,x52,x76,x90)
a14 1
;    x52                     Image size
@


1.12
log
@echo formatting only
@
text
@d6 1
a6 1
;
d44 3
a46 3
   [next_group_vol_template]     ; Template for 3D volumes  - grp***/vol
   [sorted_order_select]         ; Selection File  - order_select_sort
   [temp_ctf_file_template]      ; Template for 3D ctf file - work/ctf
d48 1
a48 1
   [next_val]                    ; Unfiltered CTF'd output volume  - final/val
d51 3
a53 3
   [next_group_vol_template]_odd ; Template for 3D odd volumes
   [sorted_order_select]         ; Selection File  - order_select_sort
   [temp_ctf_file_template]      ; Template for 3D ctf files - work/ctf
d55 1
a55 1
   [next_vol]_odd                ; Odd output volume   
d58 3
a60 3
   [next_group_vol_template]_even ; Template for 3D even volumes
   [sorted_order_select]         ; Selection File  - order_select_sort
   [temp_ctf_file_template]      ; Template for 3D ctf files - work/ctf
d62 1
a62 1
   [next_vol]_even               ; Even output volume   
d69 2
a70 2
   [next_vol]_odd                ; Odd  input volume
   [next_vol]_even               ; Even input volume 
d76 1
a76 1
   [next_dres]                   ; Resolution output doc file - dres_iter
d80 1
a80 1
   [dbpr_resol]                  ; Output file
@


1.11
log
@date
@
text
@d127 1
a127 1
   echo "Merged groups for iteration: {**x76}"
@


1.10
log
@scattering_doc
@
text
@d129 1
a129 1
   date
@


1.9
log
@@@enhance call added & saveresp
@
text
@d35 1
a35 1
;                        ???               [next_val]_amps (amplitude-enhanced volume, unfiltered)
d90 1
a90 1
      ; Generate amplitude enhancement curve & use it 
a92 1
      [enhance_doc]                 ; Output enhancement doc. file
@


1.8
log
@x14 passed trhu to saveres
@
text
@d1 1
a1 1
(x14,x52,x76)
d5 1
a5 1
; mergegroups.pam       ArDean Leith   Nov 2000
d17 1
d26 2
a27 1
;
d34 2
d39 1
a39 2
   x86=x76+1
   ; all defocus groups must be present here for "TF CTS" use!!!!
d41 2
d64 6
a69 3
   ; resolution calculation
   RF 3                          ; Phase Residual & Fourier shell corr
   [next_vol]_odd                ; Odd input volume
d73 1
a73 1
   C                             ; Missing cone/wedge angle (c/w
d78 45
a122 25
   x77=0
   @@saveres(x14,x76,x77)
   [next_dres]
   [dbpr_resol]

   x68=x52-1
   DO LB68 j=3,x68               ; Find resolution parameter for filter
      x69=x68-x0+3
      UD IC,x69,x37,x38,x39
      [next_dres]                ; File from above 'RF 3'  - dres_iter
      IF(x39.GT.0.5) GOTO LB69
   LB68
   LB69
   UD ICE
   [next_dres]                   ; File from above 'RF 3' - dres_iter

   IF(x37.GT.0.35) x37=0.4       ; Limits pass-band
   x38=x37+0.15                  ; Stop band frequency

   ; Filter output volume to limit the resolution
   FQ                            ; Filter - Quick         
   [next_val]                    ; Input file (Created above)   - val
   [next_vol]                    ; Creates filtered volume, used on next iter.
   (7)                           ; Butterworth Low pass
   x37,x38                       ; Pass-band and stop-band frequency
d124 1
a124 1
   VM                            ; Saves space for tests - grp/vol!.
@


1.7
log
@saveres input
@
text
@d1 1
a1 1
(x52,x76)
d14 1
d71 1
a71 1
   @@saveres(x52,x76,x77)
@


1.6
log
@comments
@
text
@d72 1
@


1.5
log
@*** empty log message ***
@
text
@d19 1
a19 1
;    work/ctf***                           [temp_ctf_file_template] Template for 3D ctf files
d26 5
a30 5
;    final/val{**iter}                     [next_val]     (volume)
;    final/vol{**iter}                     [next_vol]
;    final/vol{**iter}_odd                 [next_vol]_odd
;    final/vol{**iter}_even                [next_vol]_even
;    final/dres{**iter}                    [next_dres]    (resolution doc)
d42 1
a42 1
   [next_val]                    ; Output volume   - final/val
d64 1
a64 1
   c                             ; Missing cone/wedge angle (c/w
d67 1
a67 1
   [next_dres]                   ; Output doc file - dres_iter
d74 1
a74 1
   DO LB68 j=3,x68
d84 2
a85 2
   IF(x37.GT.0.35) x37=0.4
   x38=x37+0.15
d87 1
a87 1
   ; Limit the resolution
d90 1
a90 1
   [next_vol]                    ; Creates volume, used on next iter.
@


1.4
log
@*** empty log message ***
@
text
@a72 1
   ; Limit the resolution
d87 1
@


1.3
log
@after test
@
text
@d1 1
a1 1
(x52,x66,x76)
d3 1
a3 1
; <html><head><title>Merges groups at end of each iteration</title></head><body><pre>
d5 3
a7 2
; mergegroups.pam      ArDean Leith Nov 2000
; master copy: /net/sicily/usr1/leith/clus/spahn/pubsub
d9 3
a11 2
; PURPOSE:
; Consolidates CTF data at end of each iteration, not in ||
d13 18
a30 19
; CALLED FROM:
; master
;<a href="./pub_master.pam">pub_master.pam</a>
;
; INPUT:
; reg: (x52,x66,x76)
;
; input/order_select_sort             [sorted_order_select]
; work/ctf***                         [temp_ctf_file_template]
; work/defgrp{***grp}/vol{**86}       [next_group_vol>
; work/defgrp{***grp}/vol_{**86}_odd  [next_group_vol_template]  (deleted at end)  
; work/defgrp{***grp}/vol_{**86}_even [next_group_vol_template]  (deleted at end)
;
; OUTPUT:
; final/val{**86}                   [next_val]     (volume)
; final/vol{**86}                   [next_vol]
; final/vol{**86}_odd               [next_vol]_odd
; final/vol{**86}_even              [next_vol]_even
; final/dres{**86}                  [next_dres]    (doc)
d38 3
a40 3
   <next_group_vol_template>     ; Template for 3D volumes  - grp***/vol
   <sorted_order_select>         ; Selection File  - order_select_sort
   <temp_ctf_file_template>      ; Template for 3D ctf file - work/ctf
d42 1
a42 1
   <next_val>                    ; Output volume   - final/val
d45 3
a47 3
   <next_group_vol_template>_odd ; Template for 3D odd volumes
   <sorted_order_select>         ; Selection File  - order_select_sort
   <temp_ctf_file_template>      ; Template for 3D ctf files - work/ctf
d49 1
a49 1
   <next_vol>_odd                ; Odd output volume   
d52 3
a54 3
   <next_group_vol_template>_even ; Template for 3D even volumes
   <sorted_order_select>         ; Selection File  - order_select_sort
   <temp_ctf_file_template>      ; Template for 3D ctf files - work/ctf
d56 1
a56 1
   <next_vol>_even               ; Even output volume   
d60 2
a61 2
   <next_vol>_odd                ; Odd input volume
   <next_vol>_even               ; Even input volume 
d67 1
a67 1
   <next_dres>                   ; Output doc file - dres_iter
d70 2
a71 2
   @@saveres(x52,x86,x77)
   <next_dres>
d78 1
a78 1
      <next_dres>                ; File from above 'RF 3'  - dres_iter
d83 3
a85 4
   <next_dres>                   ; File from above 'RF 3' - dres_iter
   IF(x37.GT.0.35) THEN
      x37=0.4
   ENDIF
d89 2
a90 2
   <next_val>                    ; Input file (Created above)   - val
   <next_vol>                    ; Creates volume, used on next iter.
d95 6
a100 6
   \rm <next_group_vol_template>_odd* <next_group_vol_template>_even*   
;
VM
echo "Merged groups for iteration: {**x76}"
VM
date
d102 2
a103 2
MY FL
RE
@


1.2
log
@<>
@
text
@d1 1
a1 1
(x52,x76)
d12 2
a13 2
; refine
;<a href="./pub_refine.pam">pub_refine.pam</a>
d18 5
a22 5
; input/order_select_sort           [sorted_order_select]
; work/ctf***                       [temp_ctf_file_template]
; work/defgrp{***grp}/vol{**86}     [next_group_vol]
; work/defgrp{***grp}/vol1_{**86}   [next_group_vol1_template]  (deleted at end)  
; work/defgrp{***grp}/vol2_{**86}   [next_group_vol2_template]  (deleted at end)
d25 5
a29 5
; final/val{**iter+1}               [next_val]     (val volume)
; final/vol{**iter+1}               [next_vol]
; final/vol1{**iter+1}              [next_vol1]
; final/vol2{**iter+1}              [next_vol2]
; final/dres{**iter+1}              [next_dres]    (doc)
d37 3
a39 3
   [next_group_vol_template]     ; Template for 3D files  - grp***/vol
   [sorted_order_select]         ; Selection File  - order_select_sort
   [temp_ctf_file_template]      ; Template for 3D ctf file - work/ctf
d41 1
a41 1
   [next_val]                    ; Output volume   - final/val
d44 3
a46 3
   [next_group_vol1_template]    ; Template for 3D files - grp/vol1
   [sorted_order_select]         ; Selection File  - order_select_sort
   [temp_ctf_file_template]      ; Template for 3D ctf files - work/ctf
d48 1
a48 1
   [next_vol1]                   ; Output volume   - final/vol1
d51 3
a53 3
   [next_group_vol2_template]    ; Template for 3D files - grp/vol1
   [sorted_order_select]         ; Selection File  - order_select_sort
   [temp_ctf_file_template]      ; Template for 3D ctf files - work/ctf
d55 1
a55 1
   [next_vol2]                   ; Output volume   - final/vol2
d59 2
a60 2
   [next_vol1]                   ; First input file - vol1_iter
   [next_vol2]                   ; Second input file - vol2_iter
d66 1
a66 1
   [next_dres]                   ; Output doc file - dres_iter
d68 4
d77 1
a77 1
      [next_dres]                ; file from above 'RF 3'  - dres_iter
d82 1
a82 1
   [next_dres]                   ; file from above 'RF 3' - dres_iter
d89 4
a92 8
   [next_val]                    ; input file (Created above)   - val
   [next_vol]                    ; creates volume, used on next iter.
   (7)
   x37,x38
vm ; remove this for production !!!!!!!!!!!!!!!!!!!!!!!!
\rm [current_vol]*
   VM                            ; saves space for tests - grp/vol1 !!!!!.
   \rm [next_group_vol1_template]*  
d94 2
a95 2
   VM                            ; saves space for tests - grp/vol2!!!!!.
   \rm [next_group_vol2_template]* 
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
[x52,x76]
d16 1
a16 1
; reg: [x52,x66,x76]
d18 5
a22 5
; input/order_select_sort           <sorted_order_select>
; work/ctf***                       <temp_ctf_file_template>
; work/defgrp{***grp}/vol{**86}     <next_group_vol>
; work/defgrp{***grp}/vol1_{**86}   <next_group_vol1_template>  (deleted at end)  
; work/defgrp{***grp}/vol2_{**86}   <next_group_vol2_template>  (deleted at end)
d25 5
a29 5
; final/val{**iter+1}               <next_val>     (val volume)
; final/vol{**iter+1}               <next_vol>
; final/vol1{**iter+1}              <next_vol1>
; final/vol2{**iter+1}              <next_vol2>
; final/dres{**iter+1}              <next_dres>    (doc)
d37 3
a39 3
   <next_group_vol_template>     ; Template for 3D files  - grp***/vol
   <sorted_order_select>         ; Selection File  - order_select_sort
   <temp_ctf_file_template>      ; Template for 3D ctf file - work/ctf
d41 1
a41 1
   <next_val>                    ; Output volume   - final/val
d44 3
a46 3
   <next_group_vol1_template>    ; Template for 3D files - grp/vol1
   <sorted_order_select>         ; Selection File  - order_select_sort
   <temp_ctf_file_template>      ; Template for 3D ctf files - work/ctf
d48 1
a48 1
   <next_vol1>                   ; Output volume   - final/vol1
d51 3
a53 3
   <next_group_vol2_template>    ; Template for 3D files - grp/vol1
   <sorted_order_select>         ; Selection File  - order_select_sort
   <temp_ctf_file_template>      ; Template for 3D ctf files - work/ctf
d55 1
a55 1
   <next_vol2>                   ; Output volume   - final/vol2
d59 2
a60 2
   <next_vol1>                   ; First input file - vol1_iter
   <next_vol2>                   ; Second input file - vol2_iter
d66 1
a66 1
   <next_dres>                   ; Output doc file - dres_iter
d73 1
a73 1
      <next_dres>                ; file from above 'RF 3'  - dres_iter
d78 1
a78 1
   <next_dres>                   ; file from above 'RF 3' - dres_iter
d85 2
a86 2
   <next_val>                    ; input file (Created above)   - val
   <next_vol>                    ; creates volume, used on next iter.
d90 1
a90 1
\rm <current_vol>*
d92 1
a92 1
   \rm <next_group_vol1_template>*  
d95 1
a95 1
   \rm <next_group_vol2_template>* 
@
