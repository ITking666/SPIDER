<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
   <title>Defocus Estimation with CTFFIND3</title>
</head>

<body>

<p>
<h2>Estimating defocus and astigmatism of micrographs with CTFFIND3</h2>
</p>

<dt>USING CTFFIND3 FROM SPIDER</dt> <br />

<dd>The SPIDER procedure:
     <a class="project" href="./newprogs/mrcctf.spi">mrcctf.spi</a> 
     reads <font class="input">../sel_micrograph</font> and 
           <font class="input">../Micrographs/raw****</font>. <br />
     It calls 
     <a class="project" href="./newprogs/loadmic.spi">loadmic.spi</a> 
     (a SPIDER procedure), 
     <a class="project" href="http://emlab.rose2.brandeis.edu/software">ctffind3</a> 
     (the MRC CTFFIND3 program), and
     <a href="./newprogs/readmrc.py">readmrc.py</a>, 
    (a python script), and <br />  creates:
     defocus-mrc: a SPIDER doc file of defocus and astigmatism values. </dd>
</dl> 

<hr />

<p><b><a href="./newprogs/mrcctf.spi">mrcctf.spi</a></b></p>

<p><b>mrcctf.spi</b> takes a micrograph in SPIDER or scanned format, 
windows it, creates a temporary shell script, and uses the
shell script as input to the MRC program ctffind3.exe. This
program generates a text report with defocus and astigmatism
estimates as well as a power spectrum image. It then calls a
python script ( <b>readmrc.py</b>), which searches the report for
the defocus and astigmatism values, and writes these out to a
SPIDER document file.</p>

<dl>
<dt>Inputs:</dt>
   <dd>Micrographs (in SPIDER format)    </dd>
   <dd>SPIDER parameter doc file providing
      <dl>
      <dd>Spherical aberration           </dd>
      <dd>Electron beam voltage (kV)     </dd>
      <dd>Amplitude contrast ratio       </dd>
      <dd>Magnification                  </dd>
      <dd>Pixel size on scanner (microns)</dd>
      </dl>
   </dd>
   <dd>Selection doc file containing micrograph numbers</dd>
   <dd>Boundary for windowing edges of micrographs</dd>

   <dl>
   <dt>Parameters for ctffind</dd>
      <dd>Box size  Box size for ctffind3 (must be even)</dd>
      <dd>ResMin (A)</dd>
      <dd>ResMax (A)</dd>
      <dd>dFMin  (A)</dd>
      <dd>dFMax  (A)</dd>
      <dd>FStep 
   </dl>
<p />

<dt>Outputs:</dt>
   <dd>Doc file of defocus and astigmatism information</dd>
   <dd>Power spectrum generated by ctffind3           </dd>
   <dd>Text report generated by ctffind3               </dd>
</dl>


<hr />

<p><b>ctffind3</b></p>

<dl>
<dt>
<dt>PURPOSE:</dt>
   <dd>Determines defocus and astigmatism for images of
       arbitrary size. Astigmatic angle is measured from x axis 
      (same conventions as in the MRC 2D image processing programs).</dd>
   <br />

<dt>AUTHOR:</dt>
   <dd>CTFFIND3 was developed in 1998 by Nikolaus Grigorieff at the MRC 
       Laboratory of Molecular Biology in Cambridge, The software is licensed 
       under the terms of the GNU Public License version 3 (GPLv3). 
       <a href=" http://emlab.rose2.brandeis.edu/software">Download</a></dd>
   <br />
 
<dt>REFERENCE:</dt> 
   <dd>Mindell, JA, Grigorieff N.  2003.  Accurate determination of 
       local defocus and specimen tilt in electron microscopy. 
       J. Struct. Biol. 142:334-47.</dd>
   <br />

<dt>CTFFIND3 INPUT LINES:</dt> 
   <dd>1) Input file name for image</dd>
   <dd>2) Output file name to check result</dd>
   <dd>3) CS[mm], HT[kV], AmpCnst, XMAG, DStep[um]</dd>
   <dd>4) Box, ResMin[A], ResMax[A], dFMin[A], dFMax[A], FStep</dd>
   <br />
<dt>CTFFIND3 PARAMETERS:</dt> 
   <dd>CS: Spherical aberration coefficient of the objective in mm</dd>
   <dd>HT: Electron beam voltage in kV</dd>
   <br />
   <dd>AmpCnst: Amount of amplitude contrast (fraction). For ice
       images 0.07, for negative stain about 0.15.</dd>
   <br />
   <dd>XMAG: Magnification of original image</dd>
   <br />
   <dd>DStep: Pixel size on scanner in microns</dd>
   <br />
   <dd>Box: Tile size. The program divides image into square
       tiles and calculates the average power spectrum. Tiles
       with a significatly higher or lower variance are
       excluded; these are parts of the image which are unlikely
       to contain useful information (beam edge, film number
       etc). IMPORTANT: Box must have even pixel dimensions.</dd>
   <br />
   <dd>ResMin: Low resolution end of data to be fitted.</dd>
   <br />
   <dd>ResMaX: High resolution end of data to be fitted.</dd>
   <br />
   <dd>dFMin: Starting defocus value for grid search in Angstroms.
       Positive values represent an underfocus. The program
       performs a systematic grid search of defocus values
       and astigmatism before fitting a CTF to maching precision.</dd>
   <br />
   <dd>dFMax: End defocus value for grid search in Angstroms.</dd>
   <br />
   <dd>FStep: Step width for grid search in Angstroms.</dd>
   <p />

<dt>CTFFIND3 OUTPUTS:</dt>
   <dd>1) Power spectrum generated (in SPIDER format).</dd>
   <dd>This output image file can be used to check the result of the 
       fitting. It  shows the filtered average power spectrum of the 
       input image in one half, and the fitted CTF (squared) in the
       other half. The two halfs should agree very well for a sucessfull fit.
       <a href='def/fix001.jpg'>Example output</a>.   </dd>
   <p />

   <dd>2) Text report.</dd>
</dl>

<hr />

<p><b><a href="./newprogs/readmrc.py">readmrc.py</a></b></p>

<dl>
<dt>
<dt>PURPOSE:</dt>
   <dd> Searches through the CTFFIND3 report for the following lines:    </dd>
   <dd><table>
       <tr valign="top"> <th>DFMID1</th>  <th>DFMID2</th>   <th>ANGAST</th> <th>CC1</th>                         </tr>
       <tr>              <td>19240.91</td><td>18631.46</td> <td>6.43</td>   <td>0.0137</td> <td>Final Values</td></tr>
     </table></dd> 

   <dd> Where:                              </dd>
   <dd> DFMID1 = defocus along "long" axis  </dd>
   <dd> DFMID2 = defocus along "short" axis </dd>
   <dd> ANGAST = angle of astigmatism       </dd>
   <dd> CC = magnitude of astigmatism       </dd> 
   <p />

<dt>OUTPUT:</dt>
   <dd>The two defocus measures are averaged, and this information is
       written out to a SPIDER document file with 6 columns:</dd>

   <dd><table>
       <tr valign="top"> <th>key</th> <th>n</th> <th>mic no</th> <th>avg defocus</th> <th>defocus1</th> <th>defocus2</th> <th>angle</th>     <th>astig</th>              </tr>
       <tr>              <td>1</td>   <td>6</td> <td>1.000</td>  <td>26404.675</td>   <td>26446.72</td> <td>26362.63</td> <td>0.940</td><td>0.013</td></tr>
   </table></dd> 

   <dd> The micrograph number is used as the index key. If there are
      gaps in the micrograph numbers, use the SPIDER operation 
      <a href= "../../man/docren.html"><b>DOC REN</b></a> on the file.  </dd> 
<p />

<dt>NOTES:</dt>

   <dd>Angle and magnitude of astigmatism are represented differently 
       than in SPIDER.  According to Grigorieff's web site:</dd>
   
   <dd>Question: Is there a program to CTF correct a single image using the 
      values obtained from ctffind3 (i.e. correction taking into account some 
      astigmatism)?   </dd>
   <dd>Answer: SPIDER can do this -- you would use the "TF C" function to generate 
       CTF with amplitudes, or "TF CT" to just generate the binary version for 
       phase flipping. Then you would multiply the FT of your image by the 
       result using "MU". The only tricky thing is converting the CTFFIND3 
       parameters to SPIDER ones, because the astigmatism angle conventions 
       are different. The following code illustrates:               </dd>
   <dd> spider_defocus     = (DFMID1 + DFMID2)/2;                   </dd>
   <dd> spider_astig       = (DFMID2 - DFMID1);                     </dd>
   <dd> spider_angle_astig = ANGAST - 45;                           </dd>
   <dd> if (spider_astig < 0)                                       </dd>
   <dd> &nbsp;&nbsp; {spider_astig = -spider_astig;                 </dd>
   <dd> &nbsp;&nbsp; spider_angle_astig = spider_angle_astig + 90;} </dd>
</dl>
 
<hr />

<p><b><a href="./newprogs/enhancepowmrc.spi">enhancepowmrc.spi</a></b></p>

<p><b>enhancepowmrc.spi</b> enhances the power spectrum image from
CTFFIND3.</p>

<dl>
<dt>Inputs:</dt>
   <dd>Power spectra generated by SPIDER</dd>
   <dd>Power spectra generated by CTFFIND3</dd>
   <dd>Selection doc file containing micrograph numbers</dd>

</dl>
<p />

<dt>Outputs:</dt>
   <dd>Enhanced Power spectra generated by ctffind3</dd>
</dl>


<hr />

<p />

<p>
Source: defmrc.html    &nbsp;&nbsp;&nbsp; 
Page updated: 12/10/12  &nbsp;&nbsp;&nbsp;
Author: Bill Baxter</small></p>

</body>
</html>

