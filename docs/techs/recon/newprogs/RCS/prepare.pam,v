head	1.34;
access;
symbols
	GPL_update:1.26
	pre_rewrite_2010:1.25
	pre_more_stack:1.22
	best-code:1.21
	no-named-regs:1.19
	pre_GPL:1.19
	tag_version1_0:1.19;
locks; strict;
comment	@# @;


1.34
date	2015.04.30.13.22.17;	author leith;	state Exp;
branches;
next	1.33;

1.33
date	2015.04.28.15.49.10;	author leith;	state Exp;
branches;
next	1.32;

1.32
date	2012.08.31.15.33.32;	author leith;	state Exp;
branches;
next	1.31;

1.31
date	2012.01.05.15.46.45;	author leith;	state Exp;
branches;
next	1.30;

1.30
date	2011.01.31.14.24.11;	author leith;	state Exp;
branches;
next	1.29;

1.29
date	2011.01.07.18.54.08;	author leith;	state Exp;
branches;
next	1.28;

1.28
date	2010.11.04.16.12.39;	author leith;	state Exp;
branches;
next	1.27;

1.27
date	2010.11.01.14.52.22;	author leith;	state Exp;
branches;
next	1.26;

1.26
date	2010.01.19.19.05.21;	author leith;	state Exp;
branches;
next	1.25;

1.25
date	2009.04.24.10.58.56;	author leith;	state Exp;
branches;
next	1.24;

1.24
date	2009.02.10.15.23.44;	author leith;	state Exp;
branches;
next	1.23;

1.23
date	2007.01.17.16.35.08;	author leith;	state Exp;
branches;
next	1.22;

1.22
date	2006.04.06.14.53.10;	author leith;	state Exp;
branches;
next	1.21;

1.21
date	2006.03.15.19.56.19;	author leith;	state Exp;
branches;
next	1.20;

1.20
date	2006.01.04.14.28.32;	author leith;	state Exp;
branches;
next	1.19;

1.19
date	2004.11.10.16.40.01;	author leith;	state Exp;
branches;
next	1.18;

1.18
date	2004.08.24.13.09.44;	author leith;	state Exp;
branches;
next	1.17;

1.17
date	2004.08.09.15.46.57;	author leith;	state Exp;
branches;
next	1.16;

1.16
date	2004.08.02.14.16.00;	author leith;	state Exp;
branches;
next	1.15;

1.15
date	2004.07.23.19.14.31;	author leith;	state Exp;
branches;
next	1.14;

1.14
date	2004.07.08.14.56.57;	author leith;	state Exp;
branches;
next	1.13;

1.13
date	2004.06.09.14.39.01;	author leith;	state Exp;
branches;
next	1.12;

1.12
date	2004.06.02.14.30.20;	author leith;	state Exp;
branches;
next	1.11;

1.11
date	2004.03.29.15.58.40;	author leith;	state Exp;
branches;
next	1.10;

1.10
date	2004.03.18.15.56.58;	author leith;	state Exp;
branches;
next	1.9;

1.9
date	2004.03.18.15.12.53;	author leith;	state Exp;
branches;
next	1.8;

1.8
date	2003.11.21.15.26.57;	author leith;	state Exp;
branches;
next	1.7;

1.7
date	2003.03.28.14.12.59;	author leith;	state Exp;
branches;
next	1.6;

1.6
date	2003.03.10.15.34.21;	author leith;	state Exp;
branches;
next	1.5;

1.5
date	2003.03.06.14.35.29;	author leith;	state Exp;
branches;
next	1.4;

1.4
date	2002.10.15.18.11.30;	author leith;	state Exp;
branches;
next	1.3;

1.3
date	2002.10.02.14.30.34;	author leith;	state Exp;
branches;
next	1.2;

1.2
date	2002.09.12.20.26.43;	author leith;	state Exp;
branches;
next	1.1;

1.1
date	2002.09.09.19.32.43;	author leith;	state Exp;
branches;
next	;


desc
@@


1.34
log
@formatting, cosmetic, converg removed
@
text
@([pixsiz],[lambda],[iter1])
; <html><head><title>Prepare for refinement by initializing input, etc.</title></head><body><pre>
;
; SOURCE:  spider/docs/techs/recon/newprogs/prepare.pam
;          New                                           ArDean Leith  Nov 2000
;          Declining group sort                          ArDean Leith  Oct 2010
;          CS from params, DOC STAT                      ArDean Leith  Jan 2011
;          Dala removal                                  ArDean Leith  Jan 2012
;         [n-big]                                        ArDean Leith  Apr 2015
;
; PURPOSE: Prepare various initial files, CTF correction, etc.
;
; CALLED FROM: refine & pub_refine <a href="./refine.pam">refine.pam</a> & 
;                                  <a href="./pub_refine.pam">pub_refine.pam</a>
;
; Register variables & files are set in: <a href="./refine settings.pam">refine settings.pam</a>
;
; INPUT REGISTERS (SET ABOVE):
;   [pixsiz]                Pixel size (A)
;   [lambda]                Lambda(A)
;   [iter]                  Initial iteration (Usually 1)
;
; '***' denotes group number
; INPUT FILES:
;   [params]                ../params                            Params file  
;   [vol_orig]              ../Reconstruction/vol01              Initial volume file  
;   [sel_group_orig]        ../Reconstruction/sel_group_cclim    Group selection file
;   [sel_particles_orig]    ../Reconstruction/sel_particles_***  Group particle selection files 
;   [group_align_orig]      ../Alignment/align_01_***            Alignment parameter files 
;   [unaligned_images_orig] ../Alignment/input/data***           Unaligned image stacks 
;
; OUTPUT FILES:
;   [input_dir]             input                                Directory
;   [temp_work_dir]         work                                 Directory
;   [final_dir]             final                                Directory
;   [current_vol]           final/vol01                          Starting volume file  
;   [sel_particles]         input/sel_particles_***              Group particle selection files 
;   [sel_group]             input/sel_group                      Group selection file
;   [sel_group_sorted]      input/sel_group_sort                 Sorted group selection file
;   [group_align]           final/align_01_***                   Group alignment parameter files 
;   [unaligned_images]      input/data***                        Unaligned image stacks  (LINKS!)
;   [temp_ctf_file]         input/ctf***                         Group CTF correction files
;
; INLINE FILES USED: _1

 [iter] = [iter1]            ; Needed for naming initial files

 ; Create dir. for temp and output files
 SYS                          
   mkdir -p [temp_work_dir] [final_dir] [input_dir]
   
 ; Copy initial volume to input directory 
 CP                          ; Copy volume  
   [vol_orig]                ; Initial volume file            (input)
   [current_vol]             ; Current volume file            (output)

 ; Copy group selection doc file to input dir. 
 SYS                                   ; Copy group selection file to input dir. 
   \cp -p [sel_group_orig].$DATEXT   [sel_group].$DATEXT 

 ; Sort defocus groups by number of particles
 DOC SORT                    ; Sort doc file in descending order
   [sel_group]               ; Group selection file            (input)
   [sel_group_sorted]        ; Sorted group selection file     (output)
    -2                       ; Register col for sorting (descending)
   YES                       ; Compress and renumber keys?

 FI H [nx]                   ; Query nsam value (nrow must be = nsam)
   [current_vol]             ; Initial reference volume        (input)
   NX                        ; X dimension location

 ; Sum total number of particles in all groups
 DOC STAT [nv],[minv],[maxv],[totp]
   [sel_group]               ; Doc file listing groups        (input)    
   2

 UD 7,[cs]                   ; Get CS from params file
   [params]                  ; Parameter doc. file

 UD N [num-grp]              ; Get total number of defocus groups
   [sel_group]               ; Group selection doc file        (input)

 DO [i]=1,[num-grp]          ; Loop over defocus groups  --------------------

   ;         GROUP, PART.,     DEFOCUS              
   UD IC [i],[grp],[num-part],[defocus] ; Get # of particles & defocus
     [sel_group]                        ; Group sel. doc file (input)  

   ; Copy starting alignment parameter files to final dir. 
   SYS                        
     \cp -p [group_align_orig].$DATEXT [group_align].$DATEXT

   ; Link starting unaligned images to input dir  (large files) 
   SYS                        
     ln -sf  ../[unaligned_images_orig].$DATEXT  [unaligned_images].$DATEXT  

   ; Copy particle selection files to input dir. (one/group)
   SYS                       
     \cp -p [sel_particles_orig].$DATEXT  [sel_particles].$DATEXT

   ; Create group CTF correction file 
   [maxspfreq] = 1.0 / (2.0 * [pixsiz])
   TF C3                    ; Compute phase contrast transfer function 
     _1                     ; Inline CTF file             (output)
     [cs]                   ; CS 
     [defocus], [lambda]    ; Defocus(A), lambda(A)
     [nx]                   ; # of spatial freq. points
     [maxspfreq]            ; Max spatial freq.(1/A)
     0.005, 0               ; Source size(1/A), defocus spread(A)
     0,0                    ; Astigmatism(A), azimuth(deg)
     0.1, 10000             ; ACR(0-1), Gaussian env halfw(1/A)  
     -1                     ; Sign

   ; Weight the group CTF volume file for # of particles  
   [wt] = [num-grp] * [num-part] / [totp] 

   AR                       ; Arithmetic operation 
     _1                     ; Inline CTF file             (input)
     [temp_ctf_file]        ; Weighted CTF volume         (output)
     P1*[wt]                ; Does the weighting

   SYS                                      
     echo ' 'Group: {%I0%[grp]}  CTF weighting: {%f10.5%[wt]} 
 ENDDO

 UD ICE                      ; Finished with this doc file 
   [sel_group]

 DE                          ; Remove temp. inline file
  _1
 
 SYS
   echo ' Finished initial file preparation' ; echo 

 RE
; </body></pre></html>
@


1.33
log
@VM,  nbig
@
text
@d5 5
a9 5
;          New                                        ArDean Leith  Nov 2000
;          Declining group sort                       ArDean Leith  Oct 2010
;          CS from params, DOC STAT                   ArDean Leith  Jan 2011
;          Dala removal                               ArDean Leith  Jan 2012
;          [n-big]                                    ArDean Leith  Apr 2015
d57 1
a57 1
; Copy group selection doc file to input dir. 
d123 1
a123 1
     echo ' 'Group: {***[grp]}  CTF weighting: {%f10.5%[wt]} 
@


1.32
log
@pixsiz, cosmetic
@
text
@d5 5
a9 4
;          New                                           ArDean Leith  Nov 2000
;          Declining group sort                          ArDean Leith  Oct 2010
;          CS from params, DOC STAT                      ArDean Leith  Jan 2011
;          Dala removal                                  ArDean Leith  Jan 2012
d13 2
a14 1
; CALLED FROM: refine & pub_refine <a href="./refine.pam">refine.pam</a> & <a href="./pub_refine.pam">pub_refine.pam</a>
d46 1
a46 1
 [iter]=[iter1]              ; Needed for naming initial files
d49 1
a49 1
 VM                          
d58 1
a58 1
 VM                                   ; Copy group selection file to input dir. 
d90 1
a90 1
   VM                        
d94 1
a94 1
   VM                        
d98 1
a98 1
   VM                       
d122 1
a122 1
   VM                                      
d132 2
a133 2
 VM
   echo ' Finished initial file preparation' ; echo ' '
@


1.31
log
@no dala files now
@
text
@d1 1
a1 1
([maxspfreq],[lambda],[iter1])
d17 1
a17 1
;   [maxspfreq]             Maximum spatial frequency(1/A)
d44 1
a44 1
[iter]=[iter1]              ; Needed for naming initial files
d46 3
a48 3
; Create dir. for temp and output files
VM                          
mkdir -p [temp_work_dir] [final_dir] [input_dir]
d50 4
a53 4
; Copy initial volume to input directory 
CP                          ; Copy volume  
  [vol_orig]                ; Initial volume file            (input)
  [current_vol]             ; Current volume file            (output)
d56 2
a57 2
VM                                   ; Copy group selection file to input dir. 
\cp -p [sel_group_orig].$DATEXT   [sel_group].$DATEXT 
d59 15
a73 6
; Sort defocus groups by number of particles
DOC SORT                    ; Sort doc file in descending order
  [sel_group]               ; Group selection file            (input)
  [sel_group_sorted]        ; Sorted group selection file     (output)
   -2                       ; Register col for sorting (descending)
  YES                       ; Compress and renumber keys?
d75 2
a76 3
FI H [nx]                   ; Query nsam value (nrow must be = nsam)
  [current_vol]             ; Initial reference volume        (input)
  NX                        ; NSAM location
d78 2
a79 4
; Sum total number of particles in all groups
DOC STAT [nv],[minv],[maxv],[totp]
  [sel_group]               ; Doc file listing groups        (input)    
  2
d81 1
a81 8
UD 7,[sp_cs]                ; Get CS from params file
  [params]                  ; Parameter doc. file

UD N [num-grp]              ; Get total number of defocus groups
  [sel_group]               ; Group selection doc file        (input)


DO [i]=1,[num-grp]          ; Loop over defocus groups  --------------------
d89 1
a89 1
   \cp -p [group_align_orig].$DATEXT [group_align].$DATEXT
d93 1
a93 1
   ln -sf  ../[unaligned_images_orig].$DATEXT  [unaligned_images].$DATEXT  
d97 1
a97 1
   \cp -p [sel_particles_orig].$DATEXT  [sel_particles].$DATEXT
d100 1
d103 1
a103 1
     [sp_cs]                ; CS (Used to be: 2.0)
d121 2
a122 2
   echo ' 'Group: {***[grp]}  CTF weighting: {%f10.5%[wt]} 
ENDDO
d124 2
a125 2
UD ICE                      ; Finished with this doc file 
  [sel_group]
d127 1
a127 1
DE                          ; Remove temp. inline file
d129 3
d133 1
a133 6
VM
  echo ' Finished initial file preparation'
VM                                      
  echo ' '

RE
@


1.30
log
@CS from params, DOC STAT
@
text
@d2 1
a2 1
; <html><head><title>Prepare for refinement run by initializing input, etc.</title></head><body><pre>
d8 1
a27 1
;   [aligned_images_orig]   ../Alignment/input/dala01_***        Aligned image stacks 
a38 1
;   [aligned_images]        work/dala01_***                      Aligned image stacks    (LINKS!)
d52 2
a53 2
[vol_orig]                  ; Initial volume file            (input)
[current_vol]               ; Current volume file            (output)
d61 8
a68 8
[sel_group]                 ; Group selection file            (input)
[sel_group_sorted]          ; Sorted group selection file     (output)
-2                          ; Register col for sorting (descending)
YES                         ; Compress and renumber keys?

FI H [nsam]                 ; Query nsam value (nrow must be = nsam)
[current_vol]               ; Initial reference volume        (input)
NSAM                        ; NSAM location
d72 2
a73 2
[sel_group]                 ; Doc file listing groups        (input)    
2
d76 1
a76 1
[params]                    ; Parameter doc. file
d79 1
a79 1
[sel_group]                 ; Group selection doc file        (input)
d86 1
a86 1
   [sel_group]                          ; Group sel. doc file (input)  
a95 4
   ; Link starting aligned images to work dir  (large files) 
   VM                       
   ln -sf  ../[aligned_images_orig].$DATEXT  [aligned_images].$DATEXT  

d102 9
a110 9
   _1                       ; Inline CTF file             (output)
   [sp_cs]                  ; CS (Used to be: 2.0)
   [defocus], [lambda]      ; Defocus(A), lambda(A)
   [nsam]                   ; # of spatial freq. points
   [maxspfreq]              ; Max spatial freq.(1/A)
   (0.005, 0)               ; Source size(1/A), defocus spread(A)
   (0,0)                    ; Astigmatism(A), azimuth(deg)
   (0.1, 10000)             ; ACR(0-1), Gaussian env halfw(1/A)  
   (-1)                     ; Sign
d116 3
a118 3
   _1                       ; Inline CTF file             (input)
   [temp_ctf_file]          ; Weighted CTF volume         (output)
   P1*[wt]                  ; Does the weighting
d125 1
a125 1
[sel_group]
d128 1
a128 1
_1
d131 1
a131 1
echo ' Finished initial file preparation'
d133 1
a133 1
echo ' '
@


1.29
log
@even odd now gone
@
text
@d2 1
a2 1
; <html><head><title>Prepare for refinement run by initializing input, outputs, etc.</title></head><body><pre>
d7 1
d18 1
a18 1
;   [iter]                  Initial iteration (usually 1)
d47 2
a48 1
VM                          ; Dir. for temporary files and output files
a59 1

d61 1
a61 1
DOC SORT                    ; Sort doc file in descending  order
d64 1
a64 1
-2                          ; Register to sort by (descending)
d71 8
a81 8
; Sum total number of particles in all groups
[totpt]=0
DO  [i]=1,[num-grp]         ; Loop over defocus groups  --------------------  
   UD IC [i],[grp],[num-part]   ; Get number of particles 
   [sel_group]              ; Doc file listing groups       (input)    

   [totp]=[totp]+[num-part] ; Sum total number of particles in all groups
ENDDO
d87 1
a87 1
   [sel_group]                          ; Group selection doc file (input)  
d93 1
a93 1
   ; Link the starting unaligned images to input dir  (large files) 
d97 1
a97 1
   ; Link the starting aligned images to work dir  (large files) 
d105 1
a105 1
   ; Create group CTFs 
d107 2
a108 2
   _1                       ; Inline CTF file              (output)
   (2.0)                    ; CS
d117 1
a117 1
   ; Weight the group CTF file for number of particles  
d121 2
a122 2
   _1                       ; Inline CTF file              (input)
   [temp_ctf_file]          ; Weighted CTF volume          (output)
@


1.28
log
@cosmetic labels
@
text
@d21 7
a27 7
;   [params]                ../params                              Params file  
;   [vol_orig]              ../Reconstruction/vol01                Initial volume file  
;   [sel_group_orig]        ../Reconstruction/sel_group_cclim      Group selection file
;   [sel_particles_orig]    ../Reconstruction/sel_particles_***    Group particle selection files 
;   [group_align_orig]      ../Alignment/align_01_***              Alignment parameter files 
;   [aligned_images_orig]   ../Alignment/input/dala01_***          Aligned image stacks 
;   [unaligned_images_orig] ../Alignment/input/data***             Unaligned image stacks 
d30 11
a40 13
;   [input_dir]             input                                  Directory
;   [temp_work_dir]         work                                   Directory
;   [final_dir]             final                                  Directory
;   [current_vol]           final/vol01                            Starting volume file  
;   [sel_particles]         input/sel_particles_***                Group particle selection files 
;   [sel_particles_odd]     input/sel_particles_odd_***            Group particle selection files 
;   [sel_particles_even]    input/sel_particles_even_***           Group particle selection files 
;   [sel_group]             input/sel_group                        Group selection file
;   [sel_group_sorted]      input/sel_group_sort                   Sorted group selection file
;   [group_align]           final/align_01_***                     Group alignment parameter files 
;   [aligned_images]        work/dala01_***                        Aligned image stacks    (LINKS!)
;   [unaligned_images]      input/data***                          Unaligned image stacks  (LINKS!)
;   [temp_ctf_file]         input/ctf***                           Group CTF correction files
d44 1
a44 1
[iter]=[iter1]                       ; Needed for naming initial files
d46 1
a46 1
VM                                   ; Dir. for temporary files and output files
d50 3
a52 3
CP                                   ; Copy volume  
[vol_orig]                           ; Initial volume file            (input)
[current_vol]                        ; Current volume file            (output)
d60 9
a68 9
DOC SORT                             ; Sort doc file in descending  order
[sel_group]                          ; Group selection file            (input)
[sel_group_sorted]                   ; Sorted group selection file     (output)
-2                                   ; Register to sort by (descending)
YES                                  ; Compress and renumber keys?

FI H [nsam]                          ; Query nsam value (nrow must be = nsam)
[current_vol]                        ; Initial reference volume        (input)
NSAM                                 ; NSAM location
d70 2
a71 2
UD N [num-grp]                       ; Get total number of defocus groups
[sel_group]                          ; Group selection doc file        (input)
d74 4
a77 4
[tot-part]=0
DO  [i]=1,[num-grp]                  ; Loop over defocus groups  -----------------------------  
   UD IC [i], [grp], [num-part]      ; Get number of particles 
   [sel_group]                       ; Doc file listing groups       (input)    
d79 1
a79 1
   [tot-part]=[tot-part]+[num-part]  ; Sum total number of particles in all groups
d82 1
a82 1
DO [i]=1,[num-grp]                   ; Loop over defocus groups  -----------------------------
d84 3
a86 3
   ;          GROUP, PART.,     DEFOCUS              
   UD IC [i], [grp], [num-part],[defocus] ; Get number of particles & defocus value
   [sel_group]                            ; Group selection doc file  (input)  
a103 6
   ; Create sub-set group particle selection files
   DOC SPLIT                ; Split particles into two sets 
   [sel_particles]          ; Particle sel. doc file (one/group)  (input) 
   [sel_particles_odd]      ; Particle sel. doc file (one/group)  (output)
   [sel_particles_even]     ; Particle sel. doc file (one/group)  (output)

d106 1
a106 1
   _1                       ; Inline CTF file               (output)
d116 2
a117 2
   ; Weight group CTF file for number of particles  
   [wt] = [num-grp] * [num-part] / [tot-part] 
@


1.27
log
@declining group sort,  many cosmetic labels
@
text
@d15 1
a15 1
;   [maxspfreq]             Maximum spatial frequency[a-1]
d114 1
a114 1
   _1                       ; Temp inline CTF file               (output)
d116 1
a116 1
   [defocus], [lambda]      ; Defocus(Angstroms), lambda(A)
d118 2
a119 2
   [maxspfreq]              ; Maximum spatial freq.(a-1)
   (0.005, 0)               ; Source size[a-1], defocus spread(A)
d121 1
a121 1
   (0.1, 10000)             ; Ampl. contrast ratio (0-1), Gaussian env halfw (Fou units)  
d125 1
a125 1
   [WT] = [num-grp] * [num-part] / [tot-part] 
d128 3
a130 3
   _1                       ; Temp inline CTF file              (input)
   [temp_ctf_file]          ; Weighted CTF volume               (output)
   P1*[WT]                  ; Does the weighting
d133 1
a133 1
   echo ' 'Group: {***[grp]}  CTF weighting: {%f10.5%[WT]} 
@


1.26
log
@simplify-rewrite
@
text
@d2 1
a2 2
; <html><head><title>Prepare for refinement run by initializing input
;                    and output directories</title></head><body><pre>
d5 2
d12 1
a12 1
; Registers & files are set in: refine settings <a href="./refine settings.pam">refine settings.pam</a>.pam)
d16 1
a16 1
;   [lambda]                Lambda(angstroms)
d21 2
a22 2
;   [params]                ../params                              Input params file  
;   [vol_orig]              ../Reconstruction/vol01                Input volume file  
d24 1
a24 1
;   [sel_particles_orig]    ../Reconstruction/sel_particles_***    Particle selection files 
d27 1
a27 1
;   [unaligned_images_orig] ../Alignment/input/data***             Aligned image stacks 
d34 3
a36 3
;   [sel_particles]         input/sel_particles_***                Particle selection files 
;   [sel_particles_odd]     input/sel_particles_odd_***            Particle selection files 
;   [sel_particles_even]    input/sel_particles_even_***           Particle selection files 
d39 1
a39 1
;   [group_align]           final/align_01_***                     Group align input file 
d42 1
a42 1
;   [temp_ctf_file]         input/ctf***                           CTF correction files
d51 4
a54 3
CP                                   ; Copy initial volume to input directory 
[vol_orig]                           ; Input volume file               (input)
[current_vol]                        ; Initial volume file             (output)
d56 1
d60 3
a62 1
DOC SORT                             ; Sort defocus groups by number of particles
d65 2
a66 2
2                                    ; Register for particle numbers
Y                                    ; Compress and renumber keys
d68 1
a68 1
FI [nsam]                            ; Query NSAM value (NROW must be = NSAM)
d70 1
a70 1
12                                   ; NSAM location
d73 1
a73 1
[sel_group]                          ; Group selection file            (input)
d75 1
d79 1
a79 1
   [sel_group]                       ; Doc file listing groups     (input)    
d88 1
a88 1
   [sel_group]                            ; Doc file listing groups (input)  
d90 2
a91 1
   VM                       ; Copy starting alignment parameter files to final dir. 
d94 2
a95 1
   VM                       ; Link the starting unaligned images to input dir (large files) 
d98 2
a99 1
   VM                       ; Link the starting aligned images to work dir (large files) 
d102 2
a103 1
   VM                       ; Copy particle selection files to input dir. (one/group)
d106 5
a110 4
   DOC SPLIT                ; Split particles into two sets of particle selection files
   [sel_particles]          ; Particle sel. doc file  (one/group)      (input) 
   [sel_particles_odd]      ; Particle sel. doc file  (one/group)      (output)
   [sel_particles_even]     ; Particle sel. doc file  (one/group)      (output)
d114 1
a114 1
   _1                       ; Creates temp inline CTF file                     (output)
d116 6
a121 6
   [defocus], [lambda]      ; Defocus(Angstroems), lambda(Angstroems):
   [nsam]                   ; Number of spatial freq. points
   [maxspfreq]              ; Maximum spatial frequency[a-1]
   (0.005, 0)               ; Source size[a-1], defocus spread[a]
   (0,0)                    ; Astigmatism[a], azimuth[deg]
   (0.1, 10000)             ; Ampl contrast ratio [0-1], Gaussian env halfw [Fou units]:  
d124 1
a124 1
   ; Weight by number of particles / group
d127 3
a129 3
   AR                       ; Weight CTF by number of particles 
   _1                       ; Temp inline CTF file          (input)
   [temp_ctf_file]          ; Weighted for CTF              (output)
d133 1
a133 1
   echo ' 'Group: {***[grp]}  CTF weighting: {%f8.2%[WT]} 
@


1.25
log
@LB
@
text
@d5 1
a5 1
; SOURCE:  prepare.pam
d9 1
a9 1
; MASTER COPY: /net/bali/usr1/spider/docs/techs/recon/newprogs/
d11 1
a11 1
; CALLED FROM: refine & pub_refine <a href="./refine.pam">refine.pam</a> & <a href="./pub_refine.pam">pub_refine.pam</a>
d18 24
a41 18
; '***' denotes group
; INPUT FILES (SET IN <a href="./refine_settings.pam">refine_settings.pam</a>):
;   [start_vol]             input/vol**          Input volume file  
;   [order_select]          input/order_select   Group selection file
;   [sel_particles]         input/select_***     Particle selection files 
;   [start_group_align]     input/align_01_***   Alignment parameter files 
;   [start_aligned_images]  input/dala01_***     Aligned image stacks 
;
; OUTPUT FILES (SET IN <a href="./refine_settings.pam">refine_settings.pam</a>):
;   [final_dir]             final                Directory
;   [temp_work_dir]         work                 Directory
;   [temp[_local_dir]       local                Directory (Can be local on each node)
;   [current_vol]           final/vol01          Starting volume file  (link)
;   [sel_particles_odd]     input/selectodd_***  Particle selection files 
;   [sel_particles_even]    input/selecteven_*** Particle selection files 
;   [group_align]           final/align_01_***   Group align input file 
;   [aligned_images]        work/dala01_***      Aligned image stacks (link)
;   [temp_ctf_file]         input/ctf***         CTF correction files
d47 15
a61 2
VM                                   ; Dir. for temporary files, local files and output files
mkdir -p [temp_work_dir] [final_dir] 
a62 3
VM                                   ; Put link to initial volume in final directory 
ln -sf ../[start_vol].$DATEXT        [current_vol].$DATEXT  

d64 1
a64 1
[current_vol]                        ; Initial reference volume    (input)
d68 1
a68 1
[order_select]
d71 1
a71 2
DO  [i]=1,[num-grp]               ; Loop over all groups  

d73 1
a73 1
   [order_select]                    ; Doc file listing groups     (input)    
d78 1
a78 1
DO [i]=1,[num-grp]   ; Loop over defocus groups  ----------------------------------------
d81 2
a82 2
   UD IC [i], [grp], [num-part],[defocus] ; Get number of particles & defocus value=[defocus]
   [order_select]                         ; Doc file listing groups (input)  
d85 10
a94 1
   cp [start_group_align].$DATEXT  [group_align].$DATEXT
d96 4
a99 8
   ; Link the starting aligned images to work dir
   VM                       ; Link from original dir. to work dir. (large files) 
   ln -sf  ../[start_aligned_images].$DATEXT  [aligned_images].$DATEXT  

   DOC SPLIT                ; Split the particles into two sets of particle selection files
   [sel_particles]          ; Particle sel. doc file - input/select_***grp     (input) 
   [sel_particles_odd]      ; Particle sel. doc file - input/selectodd_***grp  (output)
   [sel_particles_even]     ; Particle sel. doc file - input/selecteven_***grp (output)
d105 1
a105 1
   [defocus],[lambda]       ; Defocus(Angstroems), lambda(Angstroems):
d108 1
a108 1
   (0.005,0)                ; Source size[a-1], defocus spread[a]
d110 1
a110 1
   (0.1,10000)              ; Ampl contrast ratio [0-1], Gaussian env halfw [fou units]:  
d113 2
a114 2
   ; Weight by avg. number of particles / group
   [WT]=[num-grp]*[num-part]/[tot-part] 
d126 1
a126 1
[order_select]
@


1.24
log
@clone dir changes
@
text
@d55 1
a55 1
DO LB1 [i]=1,[num-grp]               ; Loop over all groups  
d61 1
a61 1
LB1
d63 1
a63 1
DO LB2 [i]=1,[num-grp]   ; Loop over defocus groups  ----------------------------------------
d103 1
a103 1
LB2
@


1.23
log
@added stacks, named variables
@
text
@d34 1
a34 1
;   [aligned_images_prefix] work/dala01_***      Aligned image stacks (link)
d42 1
a42 1
mkdir -p [temp_work_dir] [temp_local_dir] [final_dir]
d74 1
a74 1
   ln -sf  ../[start_aligned_images].$DATEXT  [aligned_images_prefix].$DATEXT  
@


1.22
log
@wt
@
text
@d2 2
a3 1
; <html><head><title>Prepare for refinement run</title></head><body><pre>
d14 3
a16 3
;    [maxspfreq]                    Maximum spatial frequency[a-1]
;    [lambda]                       Lambda(angstroms)
;    [iter]                         Initial iteration (usually 1)
d18 1
d20 5
a24 4
;    input/order_select_sort        [sorted_order_select] Image ID doc. file
;    input/vol{**iter}              [initial_vol]         Initial starting volume
;    input/dala{**iter}_{***group}@@ [aligned_images]      Aligned stacked image files
;    input/align{**iter}_{***group} [group_align}         Original alignment parameters 
d27 23
a49 31
;    work/ctf{***group}               CTF corrected volume files
;    work/select_{***group}           Group selection doc files
;    work/selectodd_{***group}        Group selection doc files
;    work/selecteven_{***group}       Group selection doc files
;    work/dala01_{***group}           Aligned input images (link)
;    final/vol{**iter}                Input volume file (link)
;    local                            Empty directory
;    work                             Empty directory
;    final                            Empty directory
;    final/align{**iter}_{***group}   Doc file
;
; INLINE FILES USED:
;    _1

[iter]=[iter1]            ; Needed for names

VM                        ; Dir. for temporary files - work
mkdir -p [temp_work_dir]

VM                        ; Dir. for local files - local
mkdir -p [temp_local_dir]

VM                        ; Dir. for output files - final
mkdir -p [final_dir]

VM                        ; Put initial volume vol001. in - final/vol01. 
ln -sf ../[initial_vol].$DATEXT [current_vol].$DATEXT  

FI [nsam]                 ; Query NSAM value (NROW must be = NSAM)
[current_vol]             ; Initial reference volume   
12                        ; Nsam location
d51 2
a52 2
UD N [num-grp]            ; Get total number of defocus groups
[sorted_order_select]
d55 1
a55 1
DO LB4 [i]=1,[num-grp]    ; Loop over defocus groups  ------------------
a56 1
    ;         GROUP, PART.               
d58 1
a58 1
   [sorted_order_select]             ; Doc file listing groups (input)    
d60 2
a61 2
   [tot-part]=[tot-part]+[num-part]  ; Sum total number of particles
LB4
d63 1
a63 1
DO LB5 [i]=1,[num-grp]          ; Loop over defocus groups  ------------------
d65 39
a103 39
      ;        GROUP, PART.,      DEFOCUS              
   UD IC [i], [grp],  [num-part], [defocus] ; Get number of particles & defocus value=[defocus]
   [sorted_order_select]                    ; Doc file listing groups (input)    

   VM                      ; Copy starting alignment par. file from input dir. to final dir. 
   cp [initial_group_align].*  [final_dir]/

   VM                      ; Link from input dir. to final dir. (large file) 
   ln -sf ../[initial_aligned_images].$DATEXT [aligned_images_prefix].$DATEXT  

   ; Prepare selection document file for this group
   DOC CREATE
   [group_select]        ; Doc file - work/select_{***[grp]} 
   (1)                   ; Register to be filled - first
   1-[num-part]                 ; 1...number of particles in this group

   DOC SPLIT             ; Split the particles into two sets
   [group_select]        ; Doc file - work/select_{***[grp]}     (input) 
   [group_select]odd     ; Doc file - work/selectodd_{***[grp]}  (output)
   [group_select]even    ; Doc file - work/selecteven_{***[grp]} (output)

   ; Create group CTFs, weights derived  number of particles in group.
   TF C3                 ; Compute phase contrast transfer function 
   _1                    ; Creates temp inline CTF file        (output)
   (2.0)                 ; CS
   [defocus],[lambda]    ; Defocus(Angstroems), lambda(Angstroems):
   [nsam]                ; Number of spatial freq. points
   [maxspfreq]           ; Maximum spatial frequency[a-1]
   (0.005,0)             ; Source size[a-1], defocus spread[a]
   (0,0)                 ; Astigmatism[a], azimuth[deg]
   (0.1,10000)           ; Ampl contrast ratio [0-1], Gaussian env halfw [fou units]:  
   (-1)                  ; Sign

   [WT]=[num-grp]*[num-part]/[tot-part] ; Weight by avg. number of particles / group

   AR                    ; Weight CTF by number of particles 
   _1                    ; Temp CTF file          (input)
   [temp_ctf_file]       ; Weighted for CTF       (output)
   P1*[WT]               ; Does the weighting
d105 2
a106 1
LB5
d108 2
a109 2
UD ICE                   ; Finished with this doc file 
[sorted_order_select]
d111 4
a114 2
DE                       ; Remove temp. inline file
_1
a116 1

@


1.21
log
@replaced cp [initial_group_align] and ln [initial_aligned_images
@
text
@d104 1
a104 1
   [wt]=[num-grp]*[num-part]/[tot-part] ; Weight by avg. number of particles / group
d109 1
a109 1
   P1*[wt]               ; Does the weighting
@


1.20
log
@uses named registers
@
text
@d75 2
a76 2
;VM                      ; Copy starting alignment par. file from input dir. to final dir. 
;cp [initial_group_align].*  [final_dir]/
d78 2
a79 2
;VM                      ; Link from input dir. to final dir. (large file) 
;ln -sf ../[initial_aligned_images].$DATEXT [aligned_images_prefix].$DATEXT  
@


1.19
log
@newdala added
@
text
@d1 1
a1 1
(x14,x72,x76)
d13 3
a15 3
;    x14                          Maximum spatial frequency[a-1]
;    x72                          Lambda(angstroms)
;    x76                          Initial iteration (usually 1)
d38 2
d52 1
a52 1
FI x52                    ; Query NSAM value (NROW must be = NSAM)
d54 1
a54 1
12                        ; Nsam 
d56 1
a56 1
UD N,x22                  ; Get total number of defocus groups
d59 2
a60 2
x62=0
DO LB4 x99=1,x22          ; Loop over defocus groups  ------------------
d62 3
a64 3
    ;        GROUP, PART.               
   UD IC,x99, x77,  x61   ; Get number of particles=x61 
   [sorted_order_select]  ; Doc file listing groups (input)    
d66 1
a66 1
   x62=x62+x61            ; Sum total number of particles
d69 1
d71 3
a73 5
DO LB5 x99=1,x22          ; Loop over defocus groups  ------------------

      ;        GROUP, PART., DEFOCUS              
   UD IC,x99, x77,    x61,   x23 ; Get number of particles=x61 & ctf value=x23
   [sorted_order_select]  ; Doc file listing groups (input)    
d75 1
a75 1
;VM                     ; Copy starting alignment par. file from input dir. to final dir. 
d78 1
a78 1
;VM                     ; Link from input dir. to final dir. (large file) 
d83 1
a83 1
   [group_select]        ; Doc file - work/select_{***x77} 
d85 1
a85 1
   1-x61                 ; 1...number of particles in this group
d88 3
a90 3
   [group_select]        ; Doc file - work/select_{***x77}     (input) 
   [group_select]odd     ; Doc file - work/selectodd_{***x77}  (output)
   [group_select]even    ; Doc file - work/selecteven_{***x77} (output)
d96 3
a98 3
   x23,x72               ; Defocus(Angstroems), lambda(Angstroems):
   x52                   ; Number of spatial freq. points
   x14                   ; Maximum spatial frequency[a-1]
d104 1
a104 1
   x69=x22*x61/x62       ; Weight by avg. number of particles / group
d109 1
a109 1
   P1*x69                ; Does the weighting
@


1.18
log
@x69=x22*x61/x62       ; Weight by avg.
@
text
@d74 2
a75 2
   VM                     ; Copy starting alignment par. file from input dir. to final dir. 
   cp [initial_group_align].*  [final_dir]/
d77 2
a78 2
   VM                     ; Link from input dir. to final dir. (large file) 
   ln -sf ../[initial_aligned_images].$DATEXT [aligned_images_prefix].$DATEXT  
@


1.17
log
@3 params sent/ret
@
text
@d4 1
a4 1
; SOURCE: prepare.pam
d6 1
a6 1
; PURPOSE: Prepare various initial files
d62 1
a62 1
   [sorted_order_select]         
d72 1
a72 1
   [sorted_order_select]         
d87 3
a89 3
   [group_select]        ; Doc file - work/select_{***x77} 
   [group_select]odd     ; Doc file - work/selectodd_{***x77}
   [group_select]even    ; Doc file - work/selecteven_{***x77}
d93 1
a93 1
   _1                    ; Creates temp inline output file
d103 1
a103 1
   x69=x61/x62           ; Weight by total number of particles
d106 2
a107 2
   _1                    ; Temp input file
   [temp_ctf_file]       ; output file= work/ctf{group}
@


1.16
log
@defocus, weighting wrong
@
text
@d1 1
a1 1
(x14,x61,x72,x76)
a13 1
;    x61                          Total particle numbers
@


1.15
log
@used order_select_sort
per eb
@
text
@d1 1
a1 1
(x14,x72,x76)
d14 1
d58 11
d71 2
a72 1
   UD IC,x99, x77,x61,x23 ; Get number of particles=x61 & ctf value=x23
a74 2
   x62=x62+x61            ; Sum total number of particles in whole reconstruction

d96 1
a96 1
   x71,x72               ; Defocus(Angstroems), lambda(Angstroems):
d101 1
a101 1
   (0.1,10000)           ; Ampl contrast ratio [0-1], gaussian env halfw [fou units]:  
d104 1
a104 1
   x69=x22*x61/x62       ; Weight by total number of particles
d114 1
a114 1
[order_select]
@


1.14
log
@comment
@
text
@d18 1
a18 1
;    input/order_select             [order_select]        Image ID doc. file
d55 1
a55 1
[order_select]
d57 1
a57 2
UD IC, x22,x11,x62        ; Get total number of particles in all defocus groups
[order_select]            ;    from last cumulative particle number register
d59 2
a60 4
DO LB5 x77=1,x22          ; Loop over defocus groups  ------------------

   UD IC,x77, x61,x11,x23 ; Get number of particles=x61 & ctf value=x23
   [order_select]         
@


1.13
log
@x52 not passed now
@
text
@a12 1
;    x52                          Image size 
@


1.12
log
@consolidated loops, deleted ctfs file (get from defocus selector)
@
text
@d1 1
a1 1
(x52,x14,x72,x76)
d50 4
@


1.11
log
@ap ref
@
text
@d4 1
a4 1
; prepare.pam
d6 2
d20 1
a20 3
;    input/order_select_sort        [sorted_order_select] Sorted image ID doc. fil
;    input/ctfs                     [ctf_input]           Initial vol CTF file   
;    input/vol{**iter}              [initial_vol]         Initial volume
d25 4
a28 4
;    work/ctf{***group}               CTF files
;    work/select_{***x77}             Group selection doc files
;    work/selectodd_{***x77}          Group selectiondoc files
;    work/selecteven_{***x77}         Group selectiondoc files
d30 1
a30 1
;    final/vol{**iter}                Input volume file( link)
a35 3
; CALLS:
;    makeselect           <a href="./makeselect.pam">makeselect.pam</a>
;
d39 1
a39 1
VM                   ; Dir. for temporary files - work
d42 1
a42 1
VM                   ; Dir. for local files - local
d45 1
a45 1
VM                   ; Dir. for output files - final
d48 1
a48 1
VM                   ; Put initial volume vol001. in - final/vol01. 
d51 2
a52 3
FI x52               ; Query NSAM value (nrow must be = NROW)
[initial_vol]        ; Initial reference volume   
12                   ; nsam 
d54 2
a55 1
x62=0                 ; Zero counter x62 - total number of particles
d57 1
a57 2
UD N,x22              ; Get total number of defocus groups
[sorted_order_select]
d59 2
a60 3
DO LB5 x78=1,x22         ; Loop over defocus groups  ------------------
   UD S,x78,x77,x61      ; Get current defocus group number,set X61 to number of particles
   [sorted_order_select] ;Input file - order_select
d62 1
a62 1
   x62=x62+x61           ; Sum total number of particles in whole reconstruction
d64 1
a64 1
   VM                    ; Copy starting alignment par. file from input dir. to final dir. 
d67 1
a67 1
   VM                    ; Link from input dir. to final dir. (large file) 
d70 29
a98 5
   ; Prepare selection document files
   @@makeselect(x61)
   [group_select]           ; Doc file - work/select_{***x77} 
   [group_select]odd        ; Doc file - work/selectodd_{***x77}
   [group_select]even       ; Doc file - work/selecteven_{***x77}
d102 1
a102 1
UD ICE                      ; Finished with this doc file 
d105 1
a105 33
;  Create group CTFs, weights derived  number of particles in group.

DO LB6 x78=1,x22     ; Loop over defocus group set -----------------
   UD S,x78,x77      ; Get current defocus group number
   [sorted_order_select]

   UD IC,x77,x71      ; Retrieve defocus value for this group
   [ctf_input]        ; CTF input doc file (input/ctfs)

   TF C3              ; Compute phase contrast transfer function 
   _1                 ; Creates temp inline output file
   (2.0)              ; CS
   x71,x72            ; Defocus(Angstroems), lambda(Angstroems):
   x52                ; Number of sp.freq.pts
   x14                ; Maximum spatial frequency[a-1]
   (0.005,0)          ; Source size[a-1], defocus spread[a]
   (0,0)              ; Astigmatism[a], azimuth[deg]
   (0.1,10000)        ; Ampl contrast ratio [0-1], gaussian env halfw [fou units]:  
   (-1)               ; Sign

   UD IC,x77,x61      ; Find number of particles in this group
   [order_select]     ; Selection doc file 

   x69=x22*x61/x62    ; Weight by total number of particles

   AR                 ; Weight CTF by number of particles 
   _1
   [temp_ctf_file]    ; work/ctf{group}
   P1*x69             ; Does the weighting

LB6                   ; End loop over defocus groups -----------------

DE                    ; Remove temp. inline file
d108 1
a108 2
UD ICE                ; Close ctf doc. file 
[ctf_input]
a109 1
RE
@


1.10
log
@ln -f
@
text
@d1 1
a1 1
(x65,x66,x52,x14,x72,x76)
a10 2
;    x65                          Starting defocus group 
;    x66                          Ending defocus group 
d17 3
a19 3
;    input/order_select             [order_select]        Image ID doc. fil
;    input/order_select_sort        [sorted_order_select] Input file
;    input/ctfs                     [ctf_input]           CTF Starting file   
d22 1
a22 1
;    input/align{**iter}_{***group} [group_align}         Original alignment offsets 
d25 10
a34 8
;    work/ctf{***group}               ctf files
;    work/select_{***x77}             doc files
;    work/selectodd_{***x77}          doc files
;    work/selecteven_{***x77}         doc files
;    work/dala01_{***group}           aligned input images (copy)
;    final/vol{**iter}                copy of input volume file
;    local                            empty directory
;    final/align{**iter}_{***group}   doc file
d51 2
a52 3
CP                   ; Put initial volume vol001. in - final/vol01. 
[initial_vol]
[current_vol]
d54 4
d60 2
a61 3
DO LB5 x78=x65,x66    ; Loop over defocus group set ------------------
   UD S,x78,x77       ; Get defocus group number
   [sorted_order_select]
d63 3
a65 2
   UD IC,X77,X61      ; Set X61 to number of particles in a group
   [order_select]     ; Need this input file - order_select
d67 1
a67 1
   x62=x62+x61        ; Sum total number of particles in reconstruction
d69 1
a69 1
   VM                 ; Copy from input dir. to final dir. 
d72 2
a73 2
   VM                 ; Copy from input dir. to final dir. 
   ln -f [initial_aligned_images].$DATEXT [aligned_images_prefix].$DATEXT  
d88 2
a89 2
DO LB6 x78=x65,x66   ; Loop over defocus group set -----------------
   UD S,x78,x77      ; Get defocus group number
d92 2
a93 2
   UD IC,x77,x71     ; Retrieve defocus value
   [ctf_input]       ; ctfs input doc file (input/ctfs)
d95 10
a104 10
   TF C3             ; Compute phase contrast transfer function 
   _1                ; Creates temp inline output file
   (2.0)             ; CS
   x71,x72           ; Defocus(Angstroems), lambda(Angstroems):
   x52               ; Number of sp.freq.pts
   x14               ; Maximum spatial frequency[a-1]
   (0.005,0)         ; Source size[a-1], defocus spread[a]
   (0,0)             ; Astigmatism[a], azimuth[deg]
   (0.1,10000)       ; Ampl contrast ratio [0-1], gaussian env halfw [fou units]:  
   (-1)              ; Sign
d106 2
a107 2
   UD IC,x77,x61     ; Find number of particles in this group
   [order_select]    ; Selection doc file 
d109 1
a109 1
   x69=(x66-x65+1)*x61/x62  ; Weight by total number of particles
@


1.9
log
@ap ref
@
text
@d70 1
a70 1
   ln -s [initial_aligned_images].$DATEXT [aligned_images_prefix].$DATEXT  
@


1.8
log
@align doc
@
text
@d27 8
a34 9
;    work/ctf{***group}                ctf files
;    work/defgrp{***group}/select      doc files
;    work/defgrp{***group}/selectodd   doc files
;    work/defgrp{***group}/selecteven  doc files
;    work/dala01_{***group}            aligned input images (copy)
;    final/vol{**iter}            [current_vol] copy of input volume file
;    local                        [temp_local_dir] empty directory
;    final/defgrp{***group}/           empty directories
;    final/trans{**iter}_{***group}    doc files
a54 1

d66 2
a67 2
   VM                 ; Dirs needed - work/def{..} 
   mkdir -p [temp_group_dirs]
d69 2
a70 5
   VM                 ; Dirs needed  - final/def{..}  
   mkdir -p [final_group_dirs]

   VM                 ; Copy from input to final - final/trans
   cp [initial_group_align].*  [final_dir]/
d74 3
a76 3
   [group_select]           ; Doc file - work/defgrp{***x77}/select 
   [group_select]odd        ; Doc file - work/defgrp{***x77}/selectodd
   [group_select]even       ; Doc file - work/defgrp{***x77}/selecteven
d80 1
a80 1
UD ICE                      ; Finished with this doc file t
d103 2
a104 2
   UD IC,x77,x61            ; Find number of particles in this group
   [order_select]           ; Selection doc file 
@


1.7
log
@*** empty log message ***
@
text
@d6 1
a6 1
; MASTER COPY: /net/bali/usr1/spider/docs/techs/recon/programs/
d24 1
a24 1
;    input/trans{**iter}_{***group} [group_trans}         Original alignment offsets 
d75 1
a75 1
   cp [initial_group_trans].*  [final_dir]/
@


1.6
log
@*** empty log message ***
@
text
@d8 1
a8 1
; CALLED FROM: refine & pub_refine <a href="./refine.pam">refine.pam</a>) & <a href="./pub_refine.pam">pub_refine.pam</a>):
d44 1
a44 1
mkdir -p <temp_work_dir>
d47 1
a47 1
mkdir -p <temp_local_dir>
d50 1
a50 1
mkdir -p <final_dir>
d53 2
a54 2
<initial_vol>
<current_vol>
d61 1
a61 1
   <sorted_order_select>
d64 1
a64 1
   <order_select>     ; Need this input file - order_select
d69 1
a69 1
   mkdir -p <temp_group_dirs>
d72 1
a72 1
   mkdir -p <final_group_dirs>
d75 1
a75 1
   cp <initial_group_trans>.*  <final_dir>/
d79 3
a81 3
   <group_select>           ; Doc file - work/defgrp{***x77}/select 
   <group_select>odd        ; Doc file - work/defgrp{***x77}/selectodd
   <group_select>even       ; Doc file - work/defgrp{***x77}/selecteven
d86 1
a86 1
<order_select>
d92 1
a92 1
   <sorted_order_select>
d95 1
a95 1
   <ctf_input>       ; ctfs input doc file (input/ctfs)
d109 1
a109 1
   <order_select>           ; Selection doc file 
d115 1
a115 1
   <temp_ctf_file>    ; work/ctf{group}
d124 1
a124 1
<ctf_input>
@


1.5
log
@*** empty log message ***
@
text
@d1 1
a1 1
(x65,x66,x52,x14,x72,x73,x76)
a15 1
;    x73                          Lambda(angstroms)
d94 1
a94 1
   UD IC,x77,x71
@


1.4
log
@comments
@
text
@d98 2
a99 3
   IF (X77.LE.36) THEN
   TF C3             ; Creates inline file #1 (temp)
   _1                ; Temp inline output file
a108 14
   ELSE
   TF C3             ; Creates inline file #1 (temp)
   _1                ; Temp inline output file
   (2.0)             ; CS
   x71,x73           ; Defocus(angstroems), lambda(angstroems):
   x52               ; Number of sp.freq.pts
   x14               ; Maximum spatial frequency[a-1]
   (0.005,0)         ; Source size[a-1], defocus spread[a]
   (0,0)             ; Astigmatism[a], azimuth[deg]
   (0.1,10000)       ; Ampl contrast ratio [0-1], gaussian env halfw [fou units]:  
   (-1)              ; Sign
   ENDIF

   ; Calculate the weight
d111 1
d114 1
a114 1
   AR                 ; Weighting
@


1.3
log
@after test
@
text
@a4 1
; SOURCE LOCATION:
d6 1
a6 2
; CALLED FROM:
; refine 
d8 1
a8 27
; INPUT REGISTERS:
;  x65                          Starting defocus group 
;  x66                          Ending defocus group 
;  x52                          Image size 
;  x14                          Maximum spatial frequency[a-1]
;  x72                          Lambda(angstroms)
;  x73                          Lambda(angstroms)
;  x76                          Initial iteration (usually 1)
;
; INPUT FILES:
; input/order_select            [order_select]        Input file
; input/order_select_sort       [sorted_order_select] Input file
; input/ctfs                    [ctf_input]           Input file   
; input/vol{**iter}             [initial_vol]         Input volume file
; input/dala*                   [aligned_images]      Aligned input images (saved)
; input/trans{**iter}_{***group} [initial_group_trans] Trans doc files
;
; OUTPUT FILES:
; work/ctf{***group}                ctf files
; work/defgrp{***group}/select      doc files
; work/defgrp{***group}/selectodd   doc files
; work/defgrp{***group}/selecteven  doc files
; work/dala01_{***group}            aligned input images (copy)
; final/vol{**iter}            [current_vol] copy of input volume file
; local                        [temp_local_dir] empty directory
; final/defgrp{***group}/           empty directories
; final/trans{**iter}_{***group}    doc files
d10 28
d39 1
a39 1
; @@makeselect (x66,x52) <a href="./makeselect.pam">makeselect.pam</a>
d42 1
a42 1
; _1
@


1.2
log
@*** empty log message ***
@
text
@d3 1
a3 1

d5 1
a5 1
; Source location: /net/sicily/usr1/leith/clus/spahn/refine/linux
d10 16
a25 14
; INPUT:
; [x65]                          starting defocus group 
; [x66]                          ending defocus group 
; [x52]                          image size 
; [x14]                          maximum spatial frequency[a-1]
; [x72]                          lambda(angstroms)
; [x73]                          lambda(angstroms)
; [x76]                          initial iteration (usually 1)
; input/order_select             [order_select]        input file
; input/order_select_sort        [sorted_order_select] input file
; input/ctfs                     [ctf_input]           input file   
; input/vol{**iter}              [starting_vol]     input volume file
; input/dala*                    [aligned_images]      aligned input images (saved)
; input/trans{**iter}_{***group} [initial_trans_docs]  trans doc files
d27 1
a27 1
; OUTPUT:
d33 1
a33 1
; final/vol{**iter}  [current_vol] copy of input volume file
d39 1
a39 1
; @@makeselect [x66,x52] <a href="./makeselect.pam">makeselect.pam</a>
a42 1
;.......................................................................
d44 2
a45 2
VM                   ; dir. for temporary files - work
mkdir -p [temp_work_dir]
d47 2
a48 2
VM                   ; dir. for local files - local
mkdir -p [temp_local_dir]
d50 2
a51 2
VM                   ; dir. for output files - final
mkdir -p [final_dir]
d53 3
a55 3
CP                   ; put starting volume vol001. in - final/vol01. 
[starting_vol]
[current_vol]
d58 1
a58 1
x62=0                 ; zero counter x62 - total number of particles
d60 3
a62 3
DO LB5 x78=x65,x66    ; loop over defocus group set ------------------
   UD S,x78,x77       ; get defocus group number
   [sorted_order_select]
d64 2
a65 2
   UD IC,X77,X61      ; set X61 to number of particles in a group
   [order_select]     ; need this input file - order_select
d67 1
a67 1
   x62=x62+x61        ; sum total number of particles in reconstruction
d69 2
a70 2
   VM                 ; dirs needed - work/def{..} 
   mkdir -p [temp_group_dirs]
d72 2
a73 2
   VM                 ; dirs needed  - final/def{..}  
   mkdir -p [final_group_dirs]
d75 2
a76 2
   VM                 ; copy from input to final - final/trans
   cp [initial_trans_docs].*  [final_dir]/
d78 5
a82 2
;;;;   VM                 ; copy from input to work - work/dala01_
;;;;   cp [aligned_images].$DATEXT  [temp_work_dir] 
a83 6
   ; prepare selection document files
   @@makeselect[x61]
   [group_select]                ; doc file - work/defgrp{***x77}/select 
   [group_select]odd             ; doc file - work/defgrp{***x77}/selectodd
   [group_select]even            ; doc file - work/defgrp{***x77}/selecteven

d86 2
a87 3
UD ICE                ; finished with this doc file - order_select
[order_select]

d91 3
a93 3
DO LB6 x78=x65,x66   ; loop over defocus group set -----------------
   UD S,x78,x77      ; get defocus group number
   [sorted_order_select]
d96 1
a96 1
   [ctf_input]               ; ctfs input doc file (input/ctfs)
d98 29
a126 15
   TF C3             ; creates inline file #1 (temp)
   _1                ; temp inline output file
   (2.0)             ; cs
   x71,x72           ; defocus(angstroems), lambda(angstroems):
   x52               ; number of sp.freq.pts
   x14               ; maximum spatial frequency[a-1]
   (0.005,0)         ; source size[a-1], defocus spread[a]
   (0,0)             ; astigmatism[a], azimuth[deg]
   (0.1,10000)       ; ampl contrast ratio [0-1], gaussian env halfw [fou units]:  
   (-1)              ; sign

   ; calculate the weight
   UD IC,x77,x61             ; find number of particles per group
   [order_select]            ; input selection doc file 
   x69=(x66-x65+1)*x61/x62   ; weight by total number of particles
d128 1
a128 1
   AR                 ; weighting
d130 2
a131 2
   [temp_ctf_file]                ; work/ctf{group}
   P1*x69             ; does the weighting
d133 1
a133 1
LB6                   ; end loop over defocus groups -----------------
d135 1
a135 1
DE                    ; remove temp. inline file
d138 2
a139 2
UD ICE                ; close ctf doc. file 
[ctf_input]
@


1.1
log
@Initial revision
@
text
@d1 2
a2 2
[x65,x66,x52,x14,x72,x73,x76]
;; <html><head><title>Prepare for refinement run</title></head><body><pre>
d18 6
a23 6
; input/order_select             <order_select>        input file
; input/order_select_sort        <sorted_order_select> input file
; input/ctfs                     <ctf_input>           input file   
; input/vol{**iter}              <starting_vol>     input volume file
; input/dala*                    <aligned_images>      aligned input images (saved)
; input/trans{**iter}_{***group} <initial_trans_docs>  trans doc files
d31 2
a32 2
; final/vol{**iter}  <current_vol> copy of input volume file
; local                        <temp_local_dir> empty directory
d44 1
a44 1
mkdir -p <temp_work_dir>
d47 1
a47 1
mkdir -p <temp_local_dir>
d50 1
a50 1
mkdir -p <final_dir>
d53 2
a54 2
<starting_vol>
<current_vol>
d61 1
a61 1
   <sorted_order_select>
d64 1
a64 1
   <order_select>     ; need this input file - order_select
d69 1
a69 1
   mkdir -p <temp_group_dirs>
d72 1
a72 1
   mkdir -p <final_group_dirs>
d75 1
a75 1
   cp <initial_trans_docs>.*  <final_dir>/
d78 1
a78 1
;;;;   cp <aligned_images>.$DATEXT  <temp_work_dir> 
d82 3
a84 3
   <group_select>                ; doc file - work/defgrp{***x77}/select 
   <group_select>odd             ; doc file - work/defgrp{***x77}/selectodd
   <group_select>even            ; doc file - work/defgrp{***x77}/selecteven
d89 1
a89 1
<order_select>
d96 1
a96 1
   <sorted_order_select>
d99 1
a99 1
   <ctf_input>               ; ctfs input doc file (input/ctfs)
d114 1
a114 1
   <order_select>            ; input selection doc file 
d119 1
a119 1
   <temp_ctf_file>                ; work/ctf{group}
d128 1
a128 1
<ctf_input>
@
