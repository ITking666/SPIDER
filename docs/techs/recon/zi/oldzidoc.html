<HTML>
<HEAD>
<title>Processing files with the ZI Scanner</title>
</HEAD>
<BODY>

<H2>Processing files with the ZI Scanner</H2>
<hr>
<p>
<A HREF="scans.html">A comparison of the new ZI scanner with the HiScan</A>
<p>

<A HREF="#STRUCTURE">The ZI file structure</A><BR>
<A HREF="#CONVERT">Converting ZI files to SPIDER</A><BR>
<A HREF="#BATCH">Batch files</A><BR>
&nbsp&nbsp&nbsp&nbsp<A HREF="#POWER">power spectrum</A><BR>
&nbsp&nbsp&nbsp&nbsp<A HREF="#PICK">particle picking</A><BR>

<p>
<A name="STRUCTURE"></A>
<B><U>ZI file structure</U></B>
<p>
ZI files can be BIG. A typical micrograph scanned at 7u (microns) is 11,000 x 14,000 8-bit pixels - about 150 Mb (Megabytes). When it's converted to a 4-byte spider file, it will occupy 600 Mb of disk space.
<p>
However, micrographs may also be scanned at 14u. This reduces scan time as well as file size, and is approximately the same as the resolution as the HiScan.
<p>
ZI scans should be saved in tif format, and given the tif extension. However, data is arranged in a tiled format which may not be readable by some image viewers. They also have some proprietary header values set aside, e.g., for transmissivity values.
<p>
ZI files contain a set of increasingly smaller overviews: each successive overview averages 4 pixels into 1 pixel, so the size of the overviews decreases by powers of 2. Here is a typical set of overviews:
<p>
<TABLE BORDER=1 CELLPADDING=3>
<TR>
<TH>7u<BR>overviews</TH><TH>14u<BR>overviews</TH><TH>width</TH>
<TH>height</TH><TH>pixelsize(A)</TH>
</TR>
<TR>
	<TD align=center> 1 </TD>
	<TD align=center>   </TD>
	<TD align=right> 11092 </TD>
	<TD align=right> 14291 </TD>
	<TD align=center> 1.41 </TD>
</TR>
<TR>
	<TD align=center> 2 </TD>
	<TD align=center> 1 </TD>
	<TD align=right> 5546 </TD>
	<TD align=right> 7145 </TD>
	<TD align=center> 2.82 </TD>
</TR>
<TR>
	<TD align=center> 3 </TD>
	<TD align=center> 2 </TD>
	<TD align=right> 2773 </TD>
	<TD align=right> 3572 </TD>
	<TD align=center> 5.64 </TD>
</TR>
<TR>
	<TD align=center> 4 </TD>
	<TD align=center> 3 </TD>
	<TD align=right> 1386 </TD>
	<TD align=right> 1786 </TD>
	<TD align=center> 11.28 </TD>
</TR>
<TR>
	<TD align=center> 5 </TD>
	<TD align=center> 4 </TD>
	<TD align=right> 693 </TD>
	<TD align=right> 893 </TD>
	<TD align=center> 22.56 </TD>
</TR>
<TR>
	<TD align=center> 6 </TD>
	<TD align=center> 5 </TD>
	<TD align=right> 346 </TD>
	<TD align=right> 446 </TD>
	<TD align=center> etc </TD>
</TR>
<TR>
	<TD align=center> 7 </TD>
	<TD align=center> 6 </TD>
	<TD align=right> 173 </TD>
	<TD align=right> 223 </TD>
	<TD align=center> etc </TD>
</TR>
<TR>
	<TD align=center> 8 </TD>
	<TD align=center> 7 </TD>
	<TD align=right> 86 </TD>
	<TD align=right> 111 </TD>
	<TD align=center> etc </TD>
</TR>
<TR>
	<TD align=center> 9 </TD>
	<TD align=center> 8 </TD>
	<TD align=right> 43 </TD>
	<TD align=right> 55 </TD>
	<TD align=center> etc </TD>
</TR>
 <TR>
	<TD align=center> 10 </TD>
	<TD align=center> 9 </TD>
	<TD align=right> 21 </TD>
	<TD align=right> 27 </TD>
	<TD align=center> etc </TD>
</TR>
 
</TABLE>
<p>
Note: <BR>
Overview 1 corresponds to the full size image.<BR>
2.82 A pixelsize roughly corresponds to that of HiScan files.<BR>
Smaller overviews (bigger overview numbers) have better SNR due to averaging of pixels.<BR>
Overview numbers may not correspond to numbers in the Photoscan software.<BR>

<p>
<A name="CONVERT"></A>
<B><U>Converting ZI files to SPIDER format</U></B>
<p>
Until a Spider operation such as CP FROM ZI is available, there is a utility on the Unix systems and the ZI PC called <i>zi2spi</i>. It takes a ZI scanned file and an overview number as input, and converts that overview to a Spider file. Pixel values are converted to their density values. It expects as input the original ZI scanned file with a full set of overviews, not an extracted overview or the raw bytes. Usage:
<pre>
zi2spi inputfile outputfile overview#
</pre>
For example:
<pre>
zi2spi zi001.tif mic001.spi 2
</pre>
will take overview #2 in zi001.tif and convert it to the Spider file mic001.spi. It can also be called from a procedure file using VM:
<pre>
VM
zi2spi zi{***x11}.tif mic{***x11}.spi {*x22}
</pre>
Note that the extensions of both the ZI and Spider files must be indicated in a VM command. <i>zi2spi</i> is located in /usr/local/spider/bin on Unix machines, and in C:\Program Files\ZI\Common Files on the ZI PC. There is also a procedure file, <A HREF="./newprogs/convert.bat">convert.bat</A>, for converting many files at once (see below).

<p>

<A name="BATCH"></A>
<B><U>Batch files</U></B>
<p>

Because of the size of ZI scans, it may be preferable to do some processing on the ZI PC, and then move the smaller results files to a Unix machine. Some procedure files from the Single Particle Reconstruction web page have been adapted to permit this. Network connectivity via Solstice is available on the ZI PC.
<p>
As an alternative to the procedures described below, you can just move the scans to sylt, convert the full-size images to Spider format, and just treat them as regular project files.
<p>
The procedure files on the ZI PC are located in
C:\Program Files\SPIDER\docs\recon\newprogs<BR>
Or you can set the URL of a browser to 
C:\Program Files\SPIDER\docs\recon\mr.html
to view the <A HREF="./mr.html"> Single Particle Reconstruction web page</A>. It contains pointers to the zi procedure files.

<p>

<A name="POWER"></A>
<B><U>Power Spectra</U></B>
<p>
<u>On the ZI PC</u><BR>
Use the procedure file power.bat (and its procedures power_p1, power_p2) as usual to generate images of power spectra (pw_avg*** files) as well as document files of their rotational averages (roo*** files).
<p>
Overview 2 (2x smaller) works best for discerning rings.
<p>
Make changes to the parameter file (usually called params.ext). This file may be created with <A HREF="./newprogs/makeparams.bat">makeparams.bat</A>. Once created, you can change values in any text editor. See the
<A HREF="./params.html">description of the parameter file</A> to see which values to edit.<BR>
In the parameter file:<BR>
- set the file type to 3 (for ZI) <BR>
- set the pixelsize to 2.82 (for overview 2 - see table above).<BR>
- If the window size & actual size (of the particle) are set to zero, the procedure file will compute appropriate values based on the pixelsize. If you want the program to use specific window sizes, set these values in the parameter doc file.
<p>
<u>On a Unix machine</u><BR>
Currently, we cannot view Spider files or run Web on the ZI PC. Transfer the pw_avg*** and roo*** files to a Unix machine to look at the rings and calculate defocus in Web.
<p>
Gnuplot is on the PC, so you can look at the rotationaly averaged files. Note, the transmissivity values are quite small compared to the HiScan, so you will have to add an extra zero to the plotpower files, eg., 
<pre>
set yrange [0:0.00005]
</pre>

<p>

<A name="PICK"></A>
<B><U>Particle Picking</U></B>
<p>
You can run pick.bat on the PC, but since Web is not available, you cannot do the manual particle selection there.
<p>
For now, it is recommended to extract small overviews from the scans, transfer them to a unix machine, do the particle selection on those files, and then send the coordinates back to the ZI PC to extract particles from the full-sized images.
<p>
<u>On the ZI PC</u><BR>
<p>
1) Extract an overview and convert it to spider: use convert.bat with the overview number set to 3 (it's 4x smaller, but you can change this to 2 (2x smaller) if you want).
<p>
2) Move the spider micrograph files to a Unix machine. 
<p>
<u>On a Unix machine</u><BR>
<p>
3) Set parameters in the params file accordingly:<BR>
- set the file type to 0 (for Spider files) <BR> 
- set the pixelsize to 5.64 (for overview 3 - see table above).<BR>
- set the window size & actual size each to zero. The procedure file pick.bat will compute appropriate values based on the pixelsize.<BR>
<p>
4) Run Spider with the procedure files (and their associated procedure files) from the 
<A HREF="./mr.html"> Single Particle Reconstruction web page</A> :<BR>
<A HREF="./newprogs/pick.bat">pick.bat</A><BR>
<A HREF="./newprogs/pnums.bat">pnums.bat</A> <BR> 
Do the manual particle selection in Web.<BR>
<A HREF="./newprogs/renumber.bat">renumber.bat</A><BR>
<A HREF="./newprogs/newcoords.bat">newcoords.bat</A>, which generates new coordinates to extract windowed particles from the full-sized image. The outputs from this procedure file are a set of doc files, by default called coords/new{***}<BR>
NB - one of the inputs to this procedure file is the overview number used in particle picking.
<p>
5) Transfer the new{***} coordinate doc files to the ZI PC.
<p>
<u>Back on the ZI PC</u><BR>
<p>
6) Set up your folders (directories) as you would on a Unix machine, i.e.,<BR>
Top level : filenums.ext, params.ext, /Micrographs, /Particles<BR>
/Particles should contain: /coords and /win folders, and the procedure files
 <A HREF="./newprogs/extract.bat">extract.bat</A> and 
 <A HREF="./newprogs/extract_p1.bat">extract_p1.bat</A><BR>
Run Spider with extract.bat. It will read the coordinates from coords/new{***} and write out the windowed particles into win/<BR>
<p>
7) Transfer the contents of the win/ folder to a Unix machine. CAUTION: you may not want to overwrite the original particles extracted from the overview, so you may want to first rename the original win/ directory to something else, like winov4. You can rename a directory with th eUnix command mv:
<pre>
mv win winov4
</pre>
<p>

<u>Back on the Unix machine</u><BR>
<p>
Change the parameter file to have pixel size 1.41
<p>
The windowed particle files moved from the ZI PC have to be converted from NT format. Use <A HREF="./newprogs/fromnt.bat">fromnt.bat</A> and 
<A HREF="./newprogs/fromnt_p1.bat">fromnt_p1.bat</A><BR>
<p>
Continue reconstruction with the subsequent procedure files.
<p>
<HR>
<P><SMALL>
Source: zidoc.html 	&nbsp;&nbsp;&nbsp;
Written: 2/9/01      &nbsp;&nbsp;&nbsp;
Bill Baxter
</SMALL>
<P>
<SMALL><ADDRESS>&copy; <A HREF="./copyright.html"> 
   Copyright Notice</A>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
   Enquiries: <A HREF= "mailto:spider@wadsworth.org">spider@wadsworth.org</A> </ADDRESS></SMALL></A>


</BODY>
</HTML>

